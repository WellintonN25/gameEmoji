<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guardi√µes: Legends</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700;800&display=swap');

        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --gold: #f59e0b; --danger: #ef4444; --success: #10b981; --purple: #a855f7; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; color: white; }

        #app {
            width: 100%; max-width: 800px; height: 100%; position: relative;
            background: linear-gradient(to bottom, #111827, #000);
            box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden;
        }

        /* --- ESTILOS PARA IMAGENS CUSTOMIZADAS --- */
        .custom-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }

        /* --- UI HELPERS --- */
        .shake-screen { animation: shake-screen 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-screen { 10%, 90% { transform: translate3d(-2px, -2px, 0); } 20%, 80% { transform: translate3d(2px, 2px, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 2px, 0); } 40%, 60% { transform: translate3d(4px, -2px, 0); } }

        .flash-gold { animation: flash-gold-anim 1s ease-out; }
        @keyframes flash-gold-anim { 0% { background: rgba(245, 158, 11, 0); } 50% { background: rgba(245, 158, 11, 0.8); } 100% { background: rgba(245, 158, 11, 0); } }
        
        /* Anima√ß√£o de Invoca√ß√£o */
        .card.summoning { animation: summon-pulse 0.8s infinite alternate; border-color: #fff; box-shadow: 0 0 20px #fff; background: #000; }
        .card.summoning::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 60%); animation: summon-gathering 1.5s ease-in forwards; }
        .card.revealed { animation: reveal-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes summon-pulse { 0% { transform: scale(0.95); box-shadow: 0 0 10px #fff; } 100% { transform: scale(1.05); box-shadow: 0 0 30px #fff; } }
        @keyframes summon-gathering { 0% { opacity: 0; transform: scale(0.5); } 80% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(2); } }
        @keyframes reveal-pop { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }

        .card.legendary-spawn { animation: legendary-pop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 50px var(--gold), 0 0 100px var(--gold); border-color: #fff; }
        @keyframes legendary-pop { 0% { transform: scale(0.5) rotate(180deg); opacity: 0; } 60% { transform: scale(1.2) rotate(0deg); } 100% { transform: scale(1); } }

        /* --- TELAS --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; z-index: 10; background: #0f172a; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from{opacity:0} to{opacity:1} }
        
        #login { background: url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?w=800&q=60') center/cover; align-items: center; justify-content: center; }
        #hub { background: url('https://images.unsplash.com/photo-1542256851-e1293fb84338?w=800&q=60') center/cover; }
        #battle { background: url('https://images.unsplash.com/photo-1518066000714-58c45f1a2c0a?w=800&q=60') center/cover; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 0; pointer-events: none; }
        #hub .overlay { background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent 40%, rgba(0,0,0,0.9)); }
        #flash-layer { position: absolute; inset: 0; pointer-events: none; z-index: 999; }

        /* --- UI LOGIN --- */
        .login-box { background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; border: 2px solid var(--accent); text-align: center; z-index: 2; width: 90%; max-width: 350px; backdrop-filter: blur(5px); }
        .login-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: white; border-radius: 8px; font-size: 1.2rem; text-align: center; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* --- UI GERAL --- */
        .btn { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; font-size: 0.9rem; backdrop-filter: blur(4px); }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .btn-gold { background: var(--gold); color: #000; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .btn-green { background: var(--success); border: none; }
        .btn-purple { background: var(--purple); border: none; box-shadow: 0 0 10px var(--purple); }
        .btn-blue { background: var(--accent); border: none; box-shadow: 0 0 10px var(--accent); }
        .btn-red { background: var(--danger); border: none; box-shadow: 0 0 10px var(--danger); }
        
        .btn-farm { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); font-size: 0.8rem; }
        .btn-farm:hover { filter: brightness(1.2); transform: scale(1.05); }
        
        .btn-back { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); color: #fff; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 10px rgba(0,0,0,0.3); backdrop-filter: blur(5px); margin-right: 15px; }
        .btn-back:hover { background: var(--gold); color: #000; transform: scale(1.1) translateX(-3px); box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); border-color: var(--gold); }
        .btn-back:active { transform: scale(0.9); }

        .sub-header { display: flex; align-items: center; width: 100%; }
        .screen-title { font-size: 1.5rem; font-weight: 800; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); letter-spacing: 1px; text-transform: uppercase; }
        
        .hub-header { width: 100%; padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 5; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        
        .profile-card { display: flex; align-items: center; gap: 12px; }
        .profile-icon { width: 50px; height: 50px; background: rgba(255,255,255,0.1); border: 2px solid var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); overflow: hidden; }
        .profile-info { display: flex; flex-direction: column; gap: 4px; }
        .player-name { font-weight: 800; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .lvl-badge { background: var(--gold); color: #000; font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; font-weight: bold; }
        .xp-track { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #fbbf24); width: 0%; transition: 0.5s; }
        
        .resources-bar { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .res-item { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1); }
        .res-item.mana { color: #00ffff; border-color: rgba(0, 255, 255, 0.3); }
        .res-item.gems { color: #facc15; border-color: rgba(250, 204, 21, 0.3); }

        .hub-main { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; z-index: 5; padding: 20px; width: 100%; }
        
        .mode-card { width: 100%; max-width: 320px; height: 90px; background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; display: flex; align-items: center; padding: 0 20px; gap: 20px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; backdrop-filter: blur(5px); }
        .mode-card:hover { transform: scale(1.02); border-color: var(--gold); background: rgba(30, 41, 59, 0.9); }
        .mode-card:active { transform: scale(0.98); }
        .mode-card.adventure { border-left: 4px solid var(--gold); }
        .mode-card.dungeon { border-left: 4px solid var(--danger); }
        .mode-card.runes { border-left: 4px solid var(--purple); }
        
        .mode-icon { font-size: 2.2rem; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .mode-title { font-size: 1.3rem; font-weight: 800; text-transform: uppercase; color: #fff; line-height: 1; }
        .mode-desc { font-size: 0.75rem; color: #aaa; margin-top: 4px; }
        
        .mini-res-bar { width: 100%; display: flex; justify-content: center; gap: 20px; padding: 10px; font-size: 0.8rem; color: #ddd; background: rgba(0,0,0,0.4); z-index: 5; border-top: 1px solid rgba(255,255,255,0.05); }

        .hub-dock { width: 100%; height: 80px; background: rgba(15, 23, 42, 0.9); display: flex; justify-content: space-around; align-items: center; padding-bottom: 10px; z-index: 10; border-top: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .dock-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 0.7rem; cursor: pointer; transition: 0.2s; width: 60px; }
        .dock-item:hover { color: #fff; }
        .dock-item.highlight { color: var(--gold); transform: translateY(-10px); }
        .dock-icon { font-size: 1.8rem; transition: 0.2s; }
        .dock-item:hover .dock-icon { transform: scale(1.2); }
        .dock-item.highlight .dock-icon { font-size: 2.2rem; filter: drop-shadow(0 0 10px var(--gold)); }
        .summon-pulse { animation: pulse-icon 2s infinite; }
        @keyframes pulse-icon { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- LOJA --- */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; }
        .shop-item { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; text-align: center; transition: 0.2s; min-height: 220px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .shop-item:hover { transform: translateY(-5px); border-color: var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .shop-icon { font-size: 3.5rem; margin-bottom: 10px; filter: drop-shadow(0 0 8px rgba(255,255,255,0.1)); background: rgba(255, 255, 255, 0.05); width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .shop-name { font-size: 1rem; font-weight: 800; color: #fff; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .shop-desc { font-size: 0.75rem; color: #94a3b8; margin-bottom: 15px; line-height: 1.2; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .shop-price-btn { background: #334155; border: 1px solid #475569; border-radius: 8px; padding: 8px 10px; font-size: 0.9rem; width: 100%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-top: auto; }
        .shop-price-btn:hover { background: var(--success); border-color: var(--success); color: #000; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }

        .top-bar { position: relative; z-index: 10; display: flex; flex-direction: column; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 10px 15px; height: 85px; flex-shrink: 0; justify-content: center; }
        
        /* --- RUNAS (REDESIGN) --- */
        .rune-container { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .rune-slot { width: 50px; height: 50px; background: #111; border: 2px dashed #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.2s; }
        .rune-slot:active { transform: scale(0.95); }
        .rune-slot.filled { border-style: solid; border-color: #666; background: #222; }
        
        /* Novo estilo visual da runa (Pedra Preciosa) */
        .rune-icon { 
            width: 40px; height: 40px; 
            border-radius: 8px; /* Formato levemente quadrado */
            display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; font-weight: bold; 
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.3), 0 4px 6px rgba(0,0,0,0.5);
            position: relative;
            text-shadow: 0 1px 2px black;
            color: #fff;
        }
        
        .rune-icon::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
            border-radius: 6px 6px 0 0;
            pointer-events: none;
        }

        .rune-rare { background: linear-gradient(135deg, #1e40af, #3b82f6); border-color: #60a5fa; box-shadow: 0 0 10px #3b82f6; }
        .rune-epic { background: linear-gradient(135deg, #6b21a8, #a855f7); border-color: #d8b4fe; box-shadow: 0 0 10px #a855f7; }
        .rune-legend { background: linear-gradient(135deg, #92400e, #f59e0b); border-color: #fcd34d; box-shadow: 0 0 15px #f59e0b; animation: rune-glow 2s infinite alternate; }
        
        @keyframes rune-glow { 0% { box-shadow: 0 0 10px #f59e0b; } 100% { box-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; } }

        .rune-list-item { display: flex; justify-content: space-between; align-items: center; background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #334155; cursor: pointer; }
        .rune-list-item:hover { background: #334155; }
        
        /* GRID DO INVENT√ÅRIO DE RUNAS SEPARADO */
        .rune-bag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 20px; overflow-y: auto; align-content: start; flex: 1; }
        .rune-bag-item { background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .rune-bag-item:hover { transform: translateY(-3px); border-color: var(--gold); background: #334155; }
        .rune-level-badge { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; background: #000; padding: 1px 4px; border-radius: 4px; border: 1px solid #666; }
        
        .rune-btn-group { display:flex; gap:5px; width:100%; margin-top:auto; }
        .rune-action-btn { flex:1; font-size: 0.7rem; color: white; border: none; padding: 4px; border-radius: 6px; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .btn-sell { background: #ef4444; border-color: #b91c1c; }
        .btn-sell:hover { background: #dc2626; }
        .btn-up { background: #eab308; border-color: #a16207; color: black; font-weight: bold; }
        .btn-up:hover { background: #ca8a04; }

        /* MODAL DE POWER-UP */
        .rune-up-box { background: #1e293b; border: 2px solid var(--gold); padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .rune-up-header { font-size: 1.2rem; font-weight: bold; color: var(--gold); }
        .rune-up-stats { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; width: 100%; text-align: left; }
        .rune-stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .substat { color: #94a3b8; font-size: 0.8rem; }
        .substat.new { color: #4ade80; animation: pulse 1s infinite; }
        
        .up-animation { animation: up-bounce 0.5s ease-in-out; }
        @keyframes up-bounce { 0% { transform: scale(1); } 50% { transform: scale(1.2); filter: brightness(1.5); } 100% { transform: scale(1); } }
        
        /* --- MAPAS & EST√ÅGIOS --- */
        .stage-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; overflow-y: auto; }
        .stage-btn { aspect-ratio: 1; background: #222; border: 2px solid #555; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; position: relative; transition: 0.2s; }
        .stage-btn.locked { opacity: 0.3; pointer-events: none; border-color: #333; }
        .stage-btn.cleared { border-color: var(--success); color: var(--success); }
        .stage-btn.boss { background: linear-gradient(135deg, #450a0a, #1a0505); border-color: #ef4444; color: #fca5a5; box-shadow: inset 0 0 15px rgba(0,0,0,0.7); }
        .stage-btn.boss:hover { filter: brightness(1.2); }
        .boss-floor-num { font-size: 2rem; font-weight: 800; line-height: 1; text-shadow: 0 2px 4px black; }
        .boss-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; opacity: 0.8; }
        .stage-btn:active { transform: scale(0.9); }
        .first-clear-badge { position: absolute; top: -5px; right: -5px; background: var(--gold); color: black; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

        /* --- ESTILOS NOVOS DA MASMORRA (SELE√á√ÉO E LISTA) --- */
        .dungeon-selector { display:flex; flex-direction:column; gap:20px; padding:20px; flex:1; align-items:center; justify-content:center; }
        .dungeon-card { 
            width:100%; max-width:400px; height:150px; 
            border:2px solid #444; border-radius:20px; 
            display:flex; align-items:center; padding:0 30px; gap:20px; 
            cursor:pointer; transition:0.3s; position:relative; overflow:hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .dungeon-card:hover { transform:scale(1.05); border-color:white; box-shadow:0 0 20px rgba(255,255,255,0.2); }
        .dungeon-card::after { content:''; position:absolute; inset:0; z-index:0; opacity:0.3; transition:0.5s; background-size:cover; background-position:center; }
        .dungeon-card:hover::after { transform:scale(1.1); opacity:0.5; }
        
        .dungeon-card.golem { background: linear-gradient(to right, #1a2e05, #365314); border-color:#65a30d; }
        .dungeon-card.golem::after { background-image: url('https://images.unsplash.com/photo-1598556776374-27944747ebc6?w=500&q=60'); }
        
        .dungeon-card.dragon { background: linear-gradient(to right, #450a0a, #7f1d1d); border-color:#ef4444; }
        .dungeon-card.dragon::after { background-image: url('https://images.unsplash.com/photo-1577493340887-b7bfff550145?w=500&q=60'); }

        .dungeon-info { position:relative; z-index:2; text-shadow:0 2px 4px black; }
        .dungeon-title { font-size:1.8rem; font-weight:800; text-transform:uppercase; line-height:1; }
        .dungeon-drops { font-size:0.8rem; margin-top:5px; opacity:0.9; font-weight:bold; display:flex; gap:10px; }

        /* LISTA ESTILO SUMMONERS WAR */
        .sw-floor-list { width:100%; max-width:500px; display:flex; flex-direction:column; gap:10px; padding:20px; overflow-y:auto; flex:1; }
        .sw-floor-btn {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #475569;
            border-left: 5px solid #888;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.2s;
            position: relative;
        }
        .sw-floor-btn:hover { background:#334155; transform:translateX(5px); }
        .sw-floor-btn.cleared { border-left-color: var(--success); }
        .sw-floor-btn.locked { opacity:0.5; pointer-events:none; filter:grayscale(1); }
        
        .floor-idx { font-size: 1.5rem; font-weight: 800; color: #fff; width: 50px; }
        .floor-name { font-size: 0.9rem; color: #cbd5e1; text-transform: uppercase; letter-spacing: 1px; flex:1; }
        .floor-drop-icon { font-size:1.2rem; }

        /* --- MONSTROS & MONSTER BOX --- */
        .mon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 5px; padding: 8px; overflow-y: auto; align-content: start; flex: 1; width: 100%; }
        .mon-slot { width: 50px; height: 50px; background: #222; border: 2px solid #555; border-radius: 6px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; overflow: hidden; }
        .mon-slot.selected { border-color: var(--gold); box-shadow: 0 0 8px var(--gold); background: #333; }
        .mon-slot.fodder { border-color: var(--danger); opacity: 0.5; filter: grayscale(1); }
        .mon-slot.skill-up { border-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .mon-visual { font-size: 2rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; overflow: hidden; }
        .mon-visual img { width: 100%; height: 100%; object-fit: cover; }
        .mon-lvl { position: absolute; bottom: 0; right: 0; background: #000; color: #fff; font-size: 0.6rem; padding: 0 3px; border-top-left-radius: 3px; z-index: 2; }
        .stars-row { position: absolute; top: 0; width: 100%; text-align: center; display: flex; justify-content: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); z-index: 2; }
        .star { font-size: 0.6rem; color: var(--gold); text-shadow: 0 1px 2px black; margin: 0 -1px; }
        .star.purple { color: var(--purple); }

        /* CORRE√á√ÉO DE ESPELHAMENTO: Remove do pai, aplica no filho */
        .players .unit { cursor: default; } 
        .players .unit .unit-sprite { transform: scaleX(-1); } 

        /* Estilo para aliados selecion√°veis */
        .unit.selectable { 
            animation: pulse-select 1s infinite; 
            border: 2px solid #4ade80; 
            border-radius: 50%; 
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
            cursor: pointer;
        }
        @keyframes pulse-select { 
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } 
        }

        /* --- INVENT√ÅRIO --- */
        .inv-container { flex: 1; display: flex; position: relative; z-index: 2; overflow: hidden; }
        .inv-list-panel { width: 45%; background: rgba(0,0,0,0.85); border-right: 1px solid #444; display: flex; flex-direction: column; }
        .inv-filters { padding: 8px; background: rgba(0,0,0,0.5); border-bottom: 1px solid #444; font-size: 0.8rem; color: #ccc; flex-shrink: 0; }
        .inv-detail-panel { width: 55%; padding: 15px; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle at center, rgba(30, 41, 59, 0.9), rgba(0,0,0,0.95)); overflow-y: auto; }
        
        @media (max-width: 1024px) {
            .inv-container { flex-direction: column; }
            .inv-list-panel { width: 100%; height: 50%; border-right: none; border-bottom: 2px solid #444; }
            .inv-detail-panel { width: 100%; height: 50%; }
            .mon-grid { padding: 5px; gap: 4px; }
            .mon-slot { width: 50px; height: 50px; } 
        }

        .detail-model { width: 120px; height: 120px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 5rem; animation: float 3s infinite ease-in-out; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); overflow: hidden; }
        .detail-model img { width: 100%; height: 100%; object-fit: cover; }
        .detail-stats { width: 100%; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 4px 0; font-size: 0.8rem; }
        .stat-bonus { color: var(--success); font-weight: bold; font-size: 0.7rem; }
        .btn-grp { display: grid; gap: 8px; width: 100%; margin-top: 5px; }

        /* --- PREP --- */
        .prep-stage { height: 35%; display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; z-index: 2; }
        .prep-slot { width: 70px; height: 70px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); cursor: pointer; overflow: hidden; }
        .prep-slot.filled { border-style: solid; border-color: var(--success); background: rgba(16, 185, 129, 0.2); }
        .prep-list { height: 65%; background: rgba(0,0,0,0.9); padding: 10px; z-index: 2; border-top: 2px solid #444; }

        /* --- BATALHA --- */
        .stage { flex: 1; position: relative; perspective: 1000px; overflow: hidden; z-index: 1; transition: 0.3s; }
        .ground-shadow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160%; height: 60%; background: radial-gradient(ellipse at center, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 40%, transparent 70%); z-index: 0; pointer-events: none; }
        .row { display: flex; justify-content: center; gap: 20px; position: absolute; width: 100%; transition: 0.6s; }
        .enemies { top: 25%; z-index: 5; transform: scale(0.85); }
        .players { top: 55%; z-index: 10; } 
        .unit { position: relative; width: 70px; height: 70px; text-align: center; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s; cursor: pointer; }
        .unit.boss-unit { width: 120px; height: 120px; z-index: 6; }
        .players .unit .hp-container { /* N√£o inverte mais */ }
        .unit-sprite { width: 100%; height: 100%; font-size: 3.5rem; filter: drop-shadow(0 10px 5px rgba(0,0,0,0.5)); transition: 0.2s; display: flex; align-items: center; justify-content: center; position: relative; z-index: 2; overflow: hidden; }
        .boss-unit .unit-sprite { font-size: 6rem; }
        .unit-sprite img { width: 100%; height: 100%; object-fit: contain; }
        .hp-container { position: absolute; top: -15px; width: 100%; z-index: 20; opacity: 1; transition: opacity 0.3s; }
        .boss-unit .hp-container { top: -25px; width: 150%; left: -25%; }
        .hp-bar { height: 6px; background: #111; border: 1px solid #444; border-radius: 3px; position: relative; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.3s ease-out; }
        .enemies .hp-fill { background: var(--danger); }
        .unit.dead { opacity: 0 !important; filter: none !important; pointer-events: none !important; transform: translateY(30px) scale(0.8) !important; transition: opacity 0.5s, transform 0.5s; }
        .stage.cinematic .unit { filter: blur(2px) brightness(0.4) grayscale(0.8); opacity: 0.7; transform: scale(0.9); }
        .stage.cinematic .players .unit { transform: scaleX(-1) scale(0.9); }
        .stage.cinematic .unit.actor { filter: brightness(1.2) drop-shadow(0 0 15px var(--gold)); transform: scale(1.2) translateY(-10px); z-index: 100; opacity: 1; }
        .stage.cinematic .players .unit.actor { transform: scale(1.2) translateY(-10px); } 
        .stage.cinematic .unit.target-focus { filter: brightness(1.2) drop-shadow(0 0 15px var(--danger)); transform: scale(1.1); z-index: 90; opacity: 1; }
        .stage.cinematic .players .unit.target-focus { transform: scale(1.1); }
        .target-marker { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); color: var(--danger); font-size: 1.5rem; animation: bounce 0.5s infinite; text-shadow: 0 0 5px red; z-index: 100; pointer-events: none; }
        @keyframes bounce { 0%,100%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-10px)} }
        .attacking-p .unit-sprite { animation: atk-p 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .attacking-e .unit-sprite { animation: atk-e 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes atk-p { 0%{transform:translate(0,0)} 50%{transform:translate(0, -80px) scale(1.4)} 100%{transform:translate(0,0)} }
        @keyframes atk-e { 0%{transform:translate(0,0)} 50%{transform:translate(0, 80px) scale(1.4)} 100%{transform:translate(0,0)} }
        .hit-anim .unit-sprite { animation: hit-flash 0.4s ease-out; }
        @keyframes hit-flash { 0% { transform: scale(1.1); filter: brightness(10) sepia(0) grayscale(1); } 20% { transform: translate(-5px, 0); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(5px, 0); } 60% { transform: translate(-5px, 0); } 100% { transform: scale(1); filter: none; } }
        .dmg-txt { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 3rem; font-weight: 800; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; animation: dmg-pop 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; z-index: 200; pointer-events: none; }
        @keyframes dmg-pop { 0%{transform:translate(-50%,0) scale(0.5); opacity:0} 30%{transform:translate(-50%,-40px) scale(1.5); opacity:1; color: #ffeb3b;} 100%{opacity:0; transform:translate(-50%, -80px) scale(1);} }
        .farm-status { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--success); color: var(--success); font-weight: bold; z-index: 100; display: none; }
        
        .skills-ui { position: absolute; bottom: 20px; right: 20px; left: 20px; z-index: 100; display: flex; justify-content: space-between; align-items: flex-end; transform: translateY(150%); transition: 0.3s; }
        .skills-ui.active { transform: translateY(0); }
        .skill-btns { display: flex; gap: 10px; }
        .skill-btn { width: 65px; height: 65px; border-radius: 50%; background: #222; border: 3px solid #555; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s; }
        .skill-btn:active { transform: scale(0.9); }
        .skill-btn.main { border-color: var(--gold); }
        .skill-btn.spec { border-color: var(--accent); }
        .skill-btn.ulti { border-color: #a855f7; }
        .skill-btn.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .cd-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white; }
        .skill-btn small { position: absolute; bottom: -18px; font-size: 0.6rem; font-weight: bold; width: 100px; text-align: center; text-shadow: 0 1px 2px black; }
        
        .speed-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid var(--accent); color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; }
        .auto-btn { position: absolute; top: 20px; right: 70px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid #555; color: #aaa; font-weight: bold; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 100; font-size: 0.7rem; }
        .auto-btn.active { border-color: var(--success); color: var(--success); background: rgba(16,185,129,0.2); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .modal.open { display: flex; }
        .evo-box { background: #1e293b; border: 2px solid var(--purple); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .skill-box { background: #1e293b; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .rune-box { background: #1e293b; border: 2px solid var(--gold); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; height: 70vh; display: flex; flex-direction: column; }
        .evo-materials { display: flex; justify-content: center; gap: 10px; margin: 20px 0; min-height: 50px; }
        .mat-slot { width: 50px; height: 50px; border: 2px dashed #555; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #aaa; }
        
        /* MODAL DE CONFIRMA√á√ÉO */
        /* Novo z-index alto para garantir visibilidade */
        #m-confirm { z-index: 300 !important; }
        
        #m-confirm .modal-content {
            background:#1e293b; padding:20px; border-radius:15px; width:300px; text-align:center; border:2px solid var(--gold);
            animation: popIn 0.2s;
        }

        /* GACHA */
        .gacha-box { background: radial-gradient(circle at center, #1e293b, #0f172a); border: 2px solid var(--gold); padding: 30px; border-radius: 20px; width: 340px; text-align: center; box-shadow: 0 0 50px rgba(245, 158, 11, 0.2); position: relative; overflow: hidden; }
        .gacha-altar { position: absolute; inset: 0; background: url('https://www.transparenttextures.com/patterns/black-scales.png'); opacity: 0.1; z-index: 0; }
        .card { width: 140px; height: 210px; background: linear-gradient(135deg, #333, #000); border: 2px solid #555; border-radius: 15px; font-size: 4rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; position: relative; z-index: 2; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card.unknown::before { content: '?'; color: #444; font-weight: bold; }
        
        .gacha-btns { display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px; position: relative; z-index: 2; }
        .btn-summon { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px 10px; background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; transition: 0.2s; cursor: pointer; position: relative; overflow: hidden; border-bottom: 6px solid #555; }
        .btn-summon:active { transform: scale(0.95); }
        .btn-summon.common { background: linear-gradient(145deg, #e2e8f0, #94a3b8); border-color: #cbd5e1; border-bottom-color: #64748b; color: #1e293b; }
        .btn-summon.rare { background: linear-gradient(145deg, #fef08a, #f59e0b); border-color: #fde047; border-bottom-color: #b45309; color: #451a03; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
        .btn-summon h4 { font-size: 0.9rem; margin-bottom: 5px; font-weight: 800; }
        .summon-cost { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; font-weight: bold; }
        .summon-bg-glow { position: absolute; width: 100%; height: 100%; top:0; left:0; background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%); opacity: 0; transition: 0.3s; }
        .btn-summon:hover .summon-bg-glow { opacity: 1; }

        .reward-box { background: #1e293b; padding: 25px; border-radius: 20px; width: 300px; text-align: center; border: 2px solid var(--gold); box-shadow: 0 0 50px rgba(245, 158, 11, 0.3); animation: popIn 0.3s; }
        @keyframes popIn { from{transform:scale(0.5)} to{transform:scale(1)} }
        .reward-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; font-size: 1.2rem; }

    </style>
</head>
<body>

<div id="app">
    <div id="flash-layer"></div>

    <!-- TELA DE LOGIN -->
    <div id="login" class="screen active">
        <div class="login-box">
            <h1 style="color:var(--gold); font-size:2.5rem; text-shadow:0 0 20px rgba(245,158,11,0.5)">GUARDI√ïES</h1>
            <h3 style="color:var(--accent); margin-bottom:20px; letter-spacing:3px">LEGENDS</h3>
            <input type="text" id="inp-user" class="login-input" placeholder="Nome do Her√≥i" maxlength="12">
            <button class="btn btn-gold" style="width:100%; height:50px; font-size:1.2rem" onclick="Game.login()">JOGAR</button>
        </div>
    </div>

    <!-- MODAL CONFIRMA√á√ÉO (Novo) -->
    <div id="m-confirm" class="modal">
        <div class="modal-content">
            <h3 id="confirm-msg" style="color:white; margin-bottom:20px;">Tem certeza?</h3>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-red" onclick="UI.modal('m-confirm',0)">N√£o</button>
                <button class="btn btn-green" onclick="Core.execConfirm()">Sim</button>
            </div>
        </div>
    </div>

    <!-- MODAL EVOLU√á√ÉO -->
    <div id="m-evo" class="modal">
        <div class="evo-box">
            <h2 style="color:var(--purple); margin-bottom:5px">Evolu√ß√£o</h2>
            <p style="font-size:0.9rem; color:#ccc">Sacrifique <b id="evo-req-c">0</b> monstros de <b id="evo-req-s">0</b>‚òÖ</p>
            <div id="evo-slots" class="evo-materials"></div>
            <div style="height:200px; overflow-y:auto; border:1px solid #444; border-radius:8px; padding:10px; text-align:left; margin-bottom:10px">
                <div id="evo-grid" class="mon-grid"></div>
            </div>
            <p style="font-size:0.8rem; color:var(--accent); margin-bottom:5px">üí° Dica: Sacrificar um monstro igual aumenta a Skill!</p>
            <button id="btn-do-evo" class="btn btn-purple" style="width:100%" disabled onclick="Core.doEvolution()">EVOLUIR</button>
            <button class="btn" style="margin-top:10px; width:100%" onclick="UI.modal('m-evo',0)">Cancelar</button>
        </div>
    </div>

    <!-- MODAL SKILL UP -->
    <div id="m-skill" class="modal">
        <div class="skill-box">
            <h2 style="color:var(--accent); margin-bottom:5px">Skill Up</h2>
            <p style="font-size:0.9rem; color:#ccc">Sacrifique duplicatas ou use Grim√≥rios</p>
            <div style="display:flex; justify-content:center; margin-bottom:15px">
                <button class="btn btn-gold" onclick="Core.useGrimoire()">Usar üìö Grim√≥rio (Possui: <span id="sk-grim">0</span>)</button>
            </div>
            <div id="skill-slots" class="evo-materials"></div>
            <div style="height:200px; overflow-y:auto; border:1px solid #444; border-radius:8px; padding:10px; text-align:left; margin-bottom:10px">
                <div id="skill-grid" class="mon-grid"></div>
            </div>
            <button id="btn-do-skill" class="btn btn-blue" style="width:100%" disabled onclick="Core.doSkill()">APRIMORAR (Duplicata)</button>
            <button class="btn" style="margin-top:10px; width:100%" onclick="UI.modal('m-skill',0)">Cancelar</button>
        </div>
    </div>

    <!-- MODAL RUNAS (Sele√ß√£o) -->
    <div id="m-rune" class="modal">
        <div class="rune-box">
            <h2 style="color:var(--gold); margin-bottom:5px">Gerir Runas</h2>
            <div style="flex:1; overflow-y:auto; border:1px solid #444; border-radius:8px; padding:10px; text-align:left; margin-bottom:10px" id="rune-list">
                <!-- Lista de Runas -->
            </div>
            <button class="btn" style="width:100%" onclick="UI.modal('m-rune',0)">Fechar</button>
        </div>
    </div>

    <!-- NOVO MODAL POWER-UP RUNA -->
    <div id="m-rune-up" class="modal">
        <div class="rune-up-box" id="rune-up-content">
            <div class="rune-up-header">Melhorar Runa</div>
            <!-- Conte√∫do din√¢mico -->
            <div id="rune-up-display" style="display:flex; flex-direction:column; align-items:center; gap:10px; width:100%;">
                <div class="rune-icon" id="up-rune-icon">?</div>
                <div style="font-weight:bold; font-size:1.1rem;" id="up-rune-main">ATK +10</div>
            </div>
            
            <div class="rune-up-stats" id="up-rune-subs">
                <!-- Subs -->
            </div>

            <div style="font-size:0.8rem; color:#aaa;">
                Chance: <span id="up-chance" style="color:white">100%</span>
            </div>

            <button class="btn btn-gold" style="width:100%" onclick="Core.doUpgrade()">
                Power-up (<span id="up-cost">1000</span> üí†)
            </button>
            <button class="btn" style="width:100%" onclick="UI.modal('m-rune-up',0)">Fechar</button>
        </div>
    </div>

    <!-- MODAL GACHA -->
    <div id="m-gacha" class="modal">
        <div class="gacha-box">
            <div class="gacha-altar"></div>
            <h2 style="color:var(--gold); margin-bottom:20px; position:relative; z-index:2; text-shadow:0 0 10px rgba(0,0,0,0.8)">ALTAR DE INVOCA√á√ÉO</h2>
            
            <div id="g-card" class="card unknown"></div>
            <h3 id="g-res" style="color:#fff; margin-bottom:15px; position:relative; z-index:2; min-height:1.2em">...</h3>
            
            <div class="gacha-btns" id="gacha-controls">
                <div class="btn-summon common" onclick="Core.spin('common')">
                    <div class="summon-bg-glow"></div>
                    <h4>COMUM</h4>
                    <div class="summon-cost">üé´ x1</div>
                </div>
                <div class="btn-summon rare" onclick="Core.spin('rare')">
                    <div class="summon-bg-glow"></div>
                    <h4>RARO</h4>
                    <div class="summon-cost">üéüÔ∏è x1</div>
                </div>
            </div>
            
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px; position:relative; z-index:2">
                Dispon√≠vel: üé´ <span id="g-tix">0</span> | üéüÔ∏è <span id="g-rare">0</span>
            </div>

            <button class="btn" style="width:100%; background:rgba(0,0,0,0.5); position:relative; z-index:2" onclick="UI.modal('m-gacha',0)">Voltar</button>
        </div>
    </div>

    <!-- MODAL LOJA -->
    <div id="m-shop" class="modal">
        <div style="background:#1e293b; padding:20px; border-radius:15px; width:90%; max-width:600px; text-align:center; border:2px solid #475569; max-height:85vh; display:flex; flex-direction:column;">
            <h2 style="color:var(--gold); margin-bottom:15px; letter-spacing:2px; text-transform:uppercase;">Mercado Negro</h2>
            
            <div style="margin-bottom:15px; font-size:0.9rem; display:flex; justify-content:center; gap:20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px;">
                <span>üí† <span id="s-mana" style="color:#fff">0</span></span>
                <span>üíé <span id="s-gems" style="color:#fff">0</span></span>
            </div>

            <div class="shop-grid" id="shop-container"></div>
            
            <button class="btn" style="margin-top:15px; background:#334155; width:100%" onclick="UI.modal('m-shop',0)">Sair</button>
        </div>
    </div>

    <!-- MODAL RECOMPENSA -->
    <div id="m-end" class="modal">
        <div class="reward-box">
            <h2 id="end-title" style="color:var(--gold)">VIT√ìRIA!</h2>
            <div class="reward-row">
                <div style="display:flex;align-items:center;flex-direction:column"><span class="mana-icon" style="font-size:2rem">üí†</span><div id="end-mana">+100</div></div>
                <div style="display:flex;align-items:center;flex-direction:column"><span style="font-size:2rem">üíé</span><div id="end-gems">+0</div></div>
                <div style="display:flex;align-items:center;flex-direction:column"><span id="end-item-icon" style="font-size:2rem">üß™</span><div id="end-xp">+1</div></div>
            </div>
            <div style="font-size:0.8rem; color:#aaa; margin-top:5px">XP Conta: <span id="end-acc-xp">+0</span></div>
            <div id="rune-drop-msg" style="margin-top:10px; font-weight:bold; color:var(--purple)"></div>
            <button class="btn btn-gold" style="width:100%; margin-top:10px" onclick="Battle.close()">Continuar</button>
        </div>
    </div>

    <!-- HUB NOVO DASHBOARD -->
    <div id="hub" class="screen">
        <div class="overlay"></div>
        
        <div class="hub-header">
            <div class="profile-card">
                <div class="profile-icon">‚öîÔ∏è</div>
                <div class="profile-info">
                    <div class="player-name"><span id="p-name">Hero</span> <span class="lvl-badge">Lv.<span id="p-lvl">1</span></span></div>
                    <div class="xp-track"><div id="p-xp-bar" class="xp-bar-fill"></div></div>
                </div>
            </div>
            
            <div class="resources-bar">
                <div class="res-item mana">üí† <span id="h-mana">0</span></div>
                <div class="res-item gems">üíé <span id="h-gems">0</span></div>
            </div>
        </div>

        <div class="hub-main">
            <div class="mode-card adventure" onclick="UI.nav('expl')">
                <div class="mode-icon">üó∫Ô∏è</div>
                <div>
                    <div class="mode-title">Explorar</div>
                    <div class="mode-desc">Campanha Principal</div>
                </div>
            </div>
            <div class="mode-card dungeon" onclick="UI.nav('dung')">
                <div class="mode-icon">üè∞</div>
                <div>
                    <div class="mode-title">Masmorra</div>
                    <div class="mode-desc">Desafios √âpicos</div>
                </div>
            </div>
            <!-- NOVO BOT√ÉO DE RUNAS SEPARADO -->
            <div class="mode-card runes" onclick="Core.openRuneBag()">
                <div class="mode-icon">üéí</div>
                <div>
                    <div class="mode-title">Runas</div>
                    <div class="mode-desc">Gerenciar Invent√°rio</div>
                </div>
            </div>
        </div>

        <div class="mini-res-bar">
            <span>üé´ <span id="h-tix">0</span></span>
            <span>üéüÔ∏è <span id="h-rare">0</span></span>
            <span>üìö <span id="h-grim">0</span></span>
            <span>üöÄ <span id="h-boost">0</span></span>
        </div>

        <div class="hub-dock">
            <div class="dock-item" onclick="Core.openInv()">
                <div class="dock-icon">üê∫</div>
                <span>Monstros</span>
            </div>
            <div class="dock-item highlight" onclick="UI.modal('m-gacha',1)">
                <div class="dock-icon summon-pulse">‚ú®</div>
                <span>Invocar</span>
            </div>
            <div class="dock-item" onclick="UI.modal('m-shop',1)">
                <div class="dock-icon">üõí</div>
                <span>Loja</span>
            </div>
            <div class="dock-item" onclick="Game.logout()">
                <div class="dock-icon" style="filter: grayscale(1);">üö™</div>
                <span>Sair</span>
            </div>
        </div>
    </div>

    <!-- EXPLORA√á√ÉO -->
    <div id="expl" class="screen">
        <div class="top-bar" style="flex-direction: row; justify-content: flex-start; align-items: center;">
            <div class="sub-header">
                <button class="btn-back" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="screen-title">MAPA MUNDI</span>
            </div>
        </div>
        <div class="inv-container" style="flex-direction:column">
            <div style="padding:15px; text-align:center; color:#aaa">Ven√ßa para desbloquear e ganhar Cristais!</div>
            <div id="expl-grid" class="stage-grid"></div>
        </div>
    </div>

    <!-- MASMORRA (REDESENHADA: SELE√á√ÉO E LISTA) -->
    <div id="dung" class="screen">
        <div class="top-bar" style="flex-direction: row; justify-content: flex-start; align-items: center;">
            <div class="sub-header">
                <button class="btn-back" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="screen-title">MASMORRAS</span>
            </div>
        </div>
        
        <div class="inv-container" style="flex-direction:column; background: linear-gradient(to bottom, #2e1065, #000); align-items:center; overflow:hidden;">
            
            <!-- TELA 1: SELE√á√ÉO DE MASMORRA -->
            <div id="dung-select" class="dungeon-selector">
                <div class="dungeon-card golem" onclick="Core.selectDung('golem')">
                    <div style="font-size:4rem; z-index:2;">üóø</div>
                    <div class="dungeon-info">
                        <div class="dungeon-title">Gigante</div>
                        <div class="dungeon-drops"><span>‚ù§Ô∏è HP</span><span>üõ°Ô∏è DEF</span></div>
                    </div>
                </div>
                
                <div class="dungeon-card dragon" onclick="Core.selectDung('dragon')">
                    <div style="font-size:4rem; z-index:2;">üêâ</div>
                    <div class="dungeon-info">
                        <div class="dungeon-title">Drag√£o</div>
                        <div class="dungeon-drops"><span>‚öîÔ∏è ATK</span><span>üí• CRIT</span></div>
                    </div>
                </div>
            </div>

            <!-- TELA 2: LISTA DE ANDARES (ESTILO SW) -->
            <div id="dung-floors" class="sw-floor-list" style="display:none;">
                <button class="btn-back" style="margin-bottom:10px; width:40px; height:40px; align-self:flex-start;" onclick="Core.backToDungSelect()">‚ùÆ</button>
                <div id="dung-list-container" style="display:flex; flex-direction:column; gap:10px;">
                    <!-- Lista gerada via JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- NOVA TELA: INVENT√ÅRIO DE RUNAS -->
    <div id="rune_bag" class="screen">
        <div class="top-bar" style="flex-direction: row; justify-content: flex-start; align-items: center;">
            <div class="sub-header">
                <button class="btn-back" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="screen-title">INVENT√ÅRIO DE RUNAS</span>
            </div>
        </div>
        <div class="inv-container" style="flex-direction:column; background: linear-gradient(to bottom, #1e1b4b, #000);">
            <div style="padding:15px; text-align:center; color:#a5b4fc">Venda ou Melhore suas runas</div>
            <div id="rune-bag-grid" class="rune-bag-grid">
                <!-- Grid de Runas ser√° renderizado aqui -->
            </div>
        </div>
    </div>

    <!-- INVENT√ÅRIO MONSTROS -->
    <div id="inv" class="screen">
        <div class="top-bar" style="flex-direction: row; justify-content: flex-start; align-items: center;">
            <div class="sub-header">
                <button class="btn-back" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="screen-title">BOX</span>
            </div>
        </div>
        <div class="inv-container">
            <div class="inv-list-panel"><div class="inv-filters">Total: <span id="inv-count">0</span></div><div id="inv-grid" class="mon-grid"></div></div>
            <div id="inv-detail" class="inv-detail-panel"><div style="color:#aaa; margin-top:50px">Selecione</div></div>
        </div>
    </div>

    <!-- PREPARA√á√ÉO -->
    <div id="prep" class="screen">
        <div class="top-bar" style="flex-direction: row; justify-content: space-between; align-items: center;">
            <div class="sub-header">
                <button class="btn-back" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="screen-title">TIME</span>
            </div>
            <div style="display:flex; gap: 10px;">
                <button id="btn-farm" class="btn btn-farm" onclick="Battle.start(5)" style="display:none;">Farm 5x ‚ö°</button>
                <button id="btn-fight" class="btn btn-gold" onclick="Battle.start(0)">LUTAR</button>
            </div>
        </div>
        <div class="prep-stage"><div id="s0" class="prep-slot" onclick="Prep.rem(0)"></div><div id="s1" class="prep-slot" onclick="Prep.rem(1)"></div><div id="s2" class="prep-slot" onclick="Prep.rem(2)"></div></div>
        <div class="prep-list"><div id="prep-grid" class="mon-grid"></div></div>
    </div>

    <!-- BATALHA -->
    <div id="battle" class="screen">
        <div class="overlay"></div>
        <div id="farm-ui" class="farm-status">FARM AUTO: <span id="farm-count">5</span></div>
        <button id="btn-spd" class="speed-btn" onclick="Battle.spd()">x1</button>
        <button id="btn-auto" class="auto-btn" onclick="Battle.toggleAuto()">AUTO</button>
        <div id="stg" class="stage">
            <div class="ground-shadow"></div>
            <div class="row enemies" id="r-ene"></div>
            <div class="row players" id="r-pla"></div>
        </div>
        <div id="btl-ui" class="skills-ui">
            <div style="background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; border-left:3px solid var(--accent)">
                <div id="act-name" style="color:var(--accent); font-weight:bold">Nome</div>
                <div style="font-size:0.7rem; color:#fff">Sua Vez - <span id="act-target" style="color:var(--danger)">Selecione Alvo</span></div>
            </div>
            <div id="skill-list" class="skill-btns"></div>
        </div>
    </div>

</div>

<script>
    const MAX_LVL = { 1:5, 2:10, 3:20, 4:30, 5:40, 6:50 };
    
    const SHOP_DB = [
        { id: 'pot', name: 'Po√ß√£o de XP', desc: 'Sobe o n√≠vel dos seus monstros.', cost: 100, currency: 'mana', icon: 'üß™', img: '' },
        { id: 'xpboost', name: 'Booster XP', desc: '3x XP de conta na pr√≥xima batalha.', cost: 50, currency: 'gems', icon: 'üöÄ', img: '' },
        { id: 'grimoire', name: 'Grim√≥rio', desc: 'Aprimora uma habilidade aleat√≥ria.', cost: 500, currency: 'gems', icon: 'üìö', img: '' },
        { id: 'tix', name: 'Ticket Comum', desc: 'Invoca monstros de 1 a 3 estrelas.', cost: 1000, currency: 'mana', icon: 'üé´', img: '' },
        { id: 'tix_pack', name: 'Pack Comum', desc: '11 Tickets Comuns com desconto.', cost: 10000, currency: 'mana', icon: 'üì¶', img: '' },
        { id: 'rare', name: 'Ticket Raro', desc: 'Invoca monstros de 3 a 5 estrelas.', cost: 100, currency: 'gems', icon: 'üéüÔ∏è', img: '' },
        { id: 'rare_pack', name: 'Pack Raro', desc: '11 Tickets Raros com desconto.', cost: 1000, currency: 'gems', icon: 'üëë', img: '' }
    ];

    const DB = [
        { id:101, nat:1, n:'Slime', type:'√Ågua', img:'', visual:'üíß', s:[{n:'Pancada',m:1,cd:0}], hp:50, atk:10, color:'#3b82f6' },
        { id:102, nat:1, n:'Wisp', type:'Fogo', img:'', visual:'üî•', s:[{n:'Queimar',m:1,cd:0}], hp:45, atk:12, color:'#ef4444' },
        { id:103, nat:1, n:'Rat', type:'Terra', img:'', visual:'üêÄ', s:[{n:'Mordida',m:1,cd:0}], hp:55, atk:11, color:'#10b981' },
        { id:201, nat:2, n:'Goblin', type:'Terra', img:'', visual:'üë∫', s:[{n:'Clava',m:1,cd:0},{n:'F√∫ria',m:1.3,cd:2}], hp:80, atk:18, color:'#10b981' },
        { id:202, nat:2, n:'Bat', type:'Vento', img:'', visual:'ü¶á', s:[{n:'Suga Sangue',m:1,cd:0},{n:'S√¥nico',m:1.2,cd:2}], hp:70, atk:20, color:'#a855f7' },
        { id:203, nat:2, n:'Wolf', type:'√Ågua', img:'', visual:'üê∫', s:[{n:'Mordida',m:1,cd:0},{n:'Uivo',m:1.3,cd:2}], hp:85, atk:19, color:'#3b82f6' },
        { id:204, nat:2, n:'Dryad', type:'Natureza', img:'', visual:'üßö', s:[{n:'Espinhos',m:1,cd:0},{n:'Curar',m:2,cd:3,ty:'heal'}], hp:90, atk:15, color:'#10b981' },
        { id:301, nat:3, n:'Golem', type:'Terra', img:'', visual:'üóø', s:[{n:'Esmagar',m:1,cd:0},{n:'Pedregulho',m:1.3,cd:2},{n:'Terremoto',m:2.8,cd:4}], hp:120, atk:22, color:'#10b981' },
        { id:302, nat:3, n:'Mage', type:'Trov√£o', img:'', visual:'üßô', s:[{n:'Raio',m:1,cd:0},{n:'Choque',m:1.5,cd:2},{n:'Trov√£o',m:3,cd:4}], hp:100, atk:30, color:'#f59e0b' },
        { id:303, nat:3, n:'Kraken', type:'√Ågua', img:'', visual:'üêô', s:[{n:'Tent√°culo',m:1,cd:0},{n:'Jato',m:1.4,cd:2},{n:'Tsunami',m:2.5,cd:4}], hp:110, atk:24, color:'#3b82f6' },
        { id:304, nat:3, n:'Oracle', type:'Luz', img:'', visual:'üîÆ', s:[{n:'Orbe',m:1,cd:0},{n:'Grande Cura',m:3,cd:3,ty:'heal'}], hp:105, atk:18, color:'#facc15' },
        { id:401, nat:4, n:'Sylph', type:'Vento', img:'', visual:'ü¶Ö', s:[{n:'Bico',m:1,cd:0},{n:'Ventania',m:1.4,cd:2},{n:'Tornado',m:1.3,cd:4, ty:'aoe'}], hp:160, atk:22, color:'#a855f7' },
        { id:402, nat:4, n:'Raijin', type:'Trov√£o', img:'', visual:'‚ö°', s:[{n:'Choque',m:1,cd:0},{n:'Raio',m:1.6,cd:2},{n:'Tempestade',m:1.4,cd:4, ty:'aoe'}], hp:160, atk:24, color:'#f59e0b' },
        { id:403, nat:4, n:'Phoenix', type:'Fogo', img:'', visual:'üê¶‚Äçüî•', s:[{n:'Bico',m:1,cd:0},{n:'Chama',m:1.1,cd:2, ty:'aoe'},{n:'Renascer',m:3,cd:4}], hp:140, atk:25, color:'#ef4444' },
        { id:404, nat:4, n:'TimeKeeper', type:'Trevas', img:'', visual:'‚è≥', s:[{n:'Tique',m:1,cd:0},{n:'Acelerar',m:0,cd:4,ty:'turn'}], hp:140, atk:20, color:'#a855f7' },
        { id:405, nat:4, n:'Paladin', type:'Luz', img:'', visual:'üõ°Ô∏è', s:[{n:'Golpe',m:1,cd:0},{n:'Impor M√£os',m:4,cd:4,ty:'heal'}], hp:180, atk:18, color:'#facc15' },
        { id:501, nat:5, n:'Bahamut', type:'Fogo', img:'', visual:'ü¶ñ', s:[{n:'Garra',m:1.2,cd:0},{n:'Mega Flare',m:1.4,cd:3, ty:'aoe'},{n:'Apocalipse',m:1.8,cd:5, ty:'aoe'}], hp:180, atk:25, color:'#ef4444' },
        { id:502, nat:5, n:'Leviathan', type:'√Ågua', img:'', visual:'üêâ', s:[{n:'Mordida',m:1.2,cd:0},{n:'Tuf√£o',m:1.4,cd:3, ty:'aoe'},{n:'Dil√∫vio',m:1.8,cd:5, ty:'aoe'}], hp:200, atk:22, color:'#3b82f6' },
        { id:503, nat:5, n:'Zeus', type:'Trov√£o', img:'', visual:'üå©Ô∏è', s:[{n:'Martelo',m:1.2,cd:0},{n:'Rel√¢mpago',m:1.4,cd:3, ty:'aoe'},{n:'Ira Divina',m:1.8,cd:5, ty:'aoe'}], hp:170, atk:28, color:'#f59e0b' },
        { id:504, nat:5, n:'Seraphim', type:'Luz', img:'', visual:'üëº', s:[{n:'Luz',m:1.2,cd:0},{n:'Reden√ß√£o',m:4,cd:3,ty:'heal'},{n:'Milagre',m:0,cd:5,ty:'turn'}], hp:180, atk:22, color:'#facc15' },
        
        // --- BOSS UNITS ---
        { id:901, nat:6, n:'Golem Ancestral', type:'Terra', img:'', visual:'üóø', s:[{n:'Esmagar',m:1,cd:0},{n:'Pele de Pedra',m:0,cd:3,ty:'turn'}], hp:500, atk:15, color:'#a3e635' },
        { id:902, nat:6, n:'Drag√£o do Caos', type:'Fogo', img:'', visual:'üêâ', s:[{n:'Baforada',m:1.5,cd:0},{n:'Cataclismo',m:2.5,cd:4,ty:'aoe'}], hp:400, atk:40, color:'#f87171' }
    ];

    const DEFAULT_STATE = { 
        mana:5000, gems:200, pot:10, 
        tix: 2, rare_tix: 1, xp_boosters: 0, grimoires: 0,
        xp: 0, max_xp: 100, p_lvl: 1, 
        maxStage: 1, cleared: [],
        runes_inv: [], 
        roster:[
            {uid:1, id:101, lvl:1, star:1, skLvl:[1], runes:[null,null,null,null]}, 
            {uid:2, id:102, lvl:1, star:1, skLvl:[1], runes:[null,null,null,null]}, 
            {uid:3, id:201, lvl:1, star:2, skLvl:[1,1], runes:[null,null,null,null]}
        ]
    };
    
    let s = {};
    let tmp = { prep:[], selInv:null, evoTarget:null, evoFodder:[], skillFodder:[], mode:'story', lvl:1, selRuneSlot:null, dungType: null, upRune: null };
    let b = { p:[], e:[], t:'p', idx:0, spd:1, target:null, auto: false, farmRuns: 0, skillPending: null };
    let uidCount = 4;
    let runeIdCount = 1;
    let currentUser = null;
    let pendingAction = null; 

    const el = id => document.getElementById(id);

    /* --- GAME SYSTEM --- */
    const Game = {
        login: () => {
            const user = el('inp-user').value.trim();
            if(!user) return UI.toast("Digite um nome!", 'error');
            currentUser = user;
            const saved = localStorage.getItem(`g_legend_${user}`);
            if(saved) {
                s = JSON.parse(saved);
                if(!s.runes_inv) s.runes_inv = [];
                s.roster.forEach(m => {
                    if(!m.runes) m.runes = [null,null,null,null];
                    delete m.bonus; 
                    // MIGRATION: Ensure runes have level and subs
                    m.runes.forEach((r, i) => { 
                        if(r) {
                            if (typeof r.lvl === 'undefined') r.lvl = 0;
                            if (!r.subs) r.subs = [];
                        }
                    });
                });
                s.runes_inv.forEach(r => {
                    if (typeof r.lvl === 'undefined') r.lvl = 0;
                    if (!r.subs) r.subs = [];
                });

                uidCount = s.roster.reduce((max, r) => Math.max(max, r.uid), 0) + 1;
                const maxRuneIdInv = s.runes_inv.reduce((max, r) => Math.max(max, r.id), 0);
                let maxRuneIdEquip = 0;
                s.roster.forEach(m => {
                    m.runes.forEach(r => { if(r) maxRuneIdEquip = Math.max(maxRuneIdEquip, r.id); });
                });
                runeIdCount = Math.max(maxRuneIdInv, maxRuneIdEquip) + 1;
            } else {
                s = JSON.parse(JSON.stringify(DEFAULT_STATE));
            }
            el('p-name').innerText = user;
            UI.upd(); UI.nav('hub');
        },
        save: () => {
            if(currentUser) localStorage.setItem(`g_legend_${currentUser}`, JSON.stringify(s));
        },
        logout: () => {
            currentUser = null; el('inp-user').value = '';
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
            el('login').classList.add('active');
        }
    };

    /* --- UI --- */
    const UI = {
        nav: scn => { 
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); 
            el(scn).classList.add('active'); UI.upd();
            if(scn === 'expl') Core.renExpl(); 
            if(scn === 'dung') {
                tmp.dungType = null; // Reseta sele√ß√£o
                Core.renDungSelect(); 
            }
        },
        modal: (id,o) => { 
            el(id).className=o?'modal open':'modal'; 
            if(o) {
                UI.upd();
                if (id === 'm-shop') Core.renderShop(); 
            }
        },
        toast: (msg, type='info') => {
            const toast = document.createElement('div');
            const color = type === 'error' ? '#ef4444' : '#10b981';
            toast.style.cssText = `position:absolute; top:10%; left:50%; transform:translate(-50%, -50%); background:${color}; color:white; padding:10px 20px; border-radius:10px; z-index:1000; font-weight:bold; box-shadow: 0 0 10px #000; animation: fadeUp 1.5s forwards;`;
            toast.innerHTML = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
        },
        upd: () => {
            const safeSet = (id, val) => { const e = el(id); if(e) e.innerText = val; };
            safeSet('h-mana', s.mana); safeSet('s-mana', s.mana);
            safeSet('h-gems', s.gems); safeSet('s-gems', s.gems);
            safeSet('h-tix', s.tix); safeSet('g-tix', s.tix);
            safeSet('h-rare', s.rare_tix); safeSet('g-rare', s.rare_tix);
            safeSet('h-boost', s.xp_boosters); safeSet('h-grim', s.grimoires); safeSet('sk-grim', s.grimoires);
            safeSet('inv-count', s.roster.length); safeSet('p-lvl', s.p_lvl);
            const pct = Math.min(100, (s.xp / s.max_xp) * 100); 
            const xpBar = el('p-xp-bar'); if(xpBar) xpBar.style.width = `${pct}%`;
        },
        renStars: (star) => {
            let h = '<div class="stars-row">';
            for(let i=0; i<star; i++) h += `<div class="star ${star>=6?'purple':''}">‚òÖ</div>`;
            return h+'</div>';
        },
        getVis: (d) => {
            if (d.img && d.img !== '') {
                return `<img src="${d.img}" class="custom-img" alt="${d.name || d.n}">`;
            }
            return d.visual || d.icon;
        },
        renMon: (m) => {
            const d = DB.find(x=>x.id===m.id) || DB[0]; 
            return `${UI.renStars(m.star)}<div class="mon-visual">${UI.getVis(d)}</div><div class="mon-lvl">${m.lvl}</div>`;
        },
        
        // Renderiza a visualiza√ß√£o detalhada da runa
        renRuneDetails: (r) => {
            const rClass = r.rarity === 'Lendario' ? 'rune-legend' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
            let icon = '‚ùì';
            if(r.type==='hp') icon = '‚ù§Ô∏è'; else if(r.type==='atk') icon = '‚öîÔ∏è'; else if(r.type==='def') icon = 'üõ°Ô∏è'; else if(r.type==='crit') icon = 'üí•';
            
            el('up-rune-icon').className = `rune-icon ${rClass}`;
            el('up-rune-icon').innerText = icon;
            el('up-rune-main').innerText = `${r.type.toUpperCase()} +${r.val} (Lv.${r.lvl})`;

            let subsHtml = '';
            if(r.subs && r.subs.length > 0) {
                r.subs.forEach(sub => {
                   subsHtml += `<div class="rune-stat-line"><span>${sub.type.toUpperCase()}</span><span>+${sub.val}</span></div>`; 
                });
            } else {
                subsHtml = '<div style="color:#666; font-size:0.8rem">Sem substatus</div>';
            }
            el('up-rune-subs').innerHTML = subsHtml;
        }
    };

    /* --- CORE LOGIC --- */
    const Core = {
        reqConfirm: (msg, action) => {
            el('confirm-msg').innerText = msg;
            pendingAction = action;
            UI.modal('m-confirm', 1);
        },
        execConfirm: () => {
            if(pendingAction) pendingAction();
            pendingAction = null;
            UI.modal('m-confirm', 0);
        },

        renderShop: () => {
            const container = el('shop-container');
            container.innerHTML = '';
            SHOP_DB.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                const currencySymbol = item.currency === 'mana' ? 'üí†' : 'üíé';
                const priceDisplay = item.cost >= 1000 ? (item.cost / 1000) + 'k' : item.cost;
                itemDiv.innerHTML = `<div class="shop-icon">${UI.getVis(item)}</div><div class="shop-name">${item.name}</div><div class="shop-desc">${item.desc}</div><button class="shop-price-btn" onclick="Core.buy('${item.id}', ${item.cost}, '${item.currency}')">${priceDisplay} ${currencySymbol}</button>`;
                container.appendChild(itemDiv);
            });
        },
        buy: (type, cost, currency='mana') => {
            if(currency === 'mana' && s.mana < cost) return UI.toast('Mana insuficiente!', 'error');
            if(currency === 'gems' && s.gems < cost) return UI.toast('Cristais insuficientes!', 'error');
            if(currency === 'mana') s.mana -= cost; else s.gems -= cost;
            if(type === 'pot') s.pot++;
            if(type === 'tix') s.tix++;
            if(type === 'tix_pack') s.tix += 11;
            if(type === 'rare') s.rare_tix++;
            if(type === 'rare_pack') s.rare_tix += 11;
            if(type === 'xpboost') s.xp_boosters++;
            if(type === 'grimoire') s.grimoires++;
            Game.save(); UI.upd(); Core.renderShop(); UI.toast("Compra realizada!");
        },
        spin: (type) => {
            let minNat = 1, maxNat = 3;
            if (type === 'common') {
                if(s.tix < 1) return UI.toast('Sem Tickets Comuns!');
                s.tix--;
            } else if (type === 'rare') {
                if(s.rare_tix < 1) return UI.toast('Sem Tickets Raros!');
                s.rare_tix--;
            }
            UI.upd(); 

            let cd = el('g-card');
            cd.innerHTML = '';
            cd.className = 'card summoning'; 
            cd.style.animation = ''; 
            
            document.getElementById('gacha-controls').style.pointerEvents = 'none';
            document.getElementById('gacha-controls').style.opacity = '0.5';
            el('g-res').innerText = "Invocando...";

            setTimeout(() => {
                let targetNat = 1;
                const r = Math.random() * 100;
                if (type === 'common') {
                    if (r < 70) targetNat = 1; else if (r < 95) targetNat = 2; else targetNat = 3;
                } else {
                    if (r < 70) targetNat = 3; else if (r < 95) targetNat = 4; else targetNat = 5;
                }
                const pool = DB.filter(m => m.nat === targetNat);
                const h = pool[Math.floor(Math.random()*pool.length)];
                const initSkills = h.s.map(() => 1);
                
                cd.className = 'card revealed'; 
                if (h.nat === 5) cd.classList.add('legendary-spawn'); 
                
                cd.classList.remove('unknown'); 
                cd.innerHTML = UI.getVis(h); 
                el('g-res').innerText = `${h.n} ${h.nat}‚òÖ`;

                if (h.nat === 5) {
                    el('flash-layer').classList.add('flash-gold');
                    setTimeout(() => el('flash-layer').classList.remove('flash-gold'), 1000);
                    el('app').classList.add('shake-screen');
                    setTimeout(() => el('app').classList.remove('shake-screen'), 500);
                }

                s.roster.push({uid:uidCount++, id:h.id, lvl:1, star:h.nat, skLvl:initSkills, runes:[null,null,null,null]});
                Game.save(); 
                UI.upd();
                
                document.getElementById('gacha-controls').style.pointerEvents = 'all';
                document.getElementById('gacha-controls').style.opacity = '1';

            }, 1200); 
        },
        
        openInv: () => { 
            UI.nav('inv'); const grid = el('inv-grid'); grid.innerHTML = '';
            const frag = document.createDocumentFragment();
            const sorted = [...s.roster].sort((a,b) => (b.star - a.star) || (b.lvl - a.lvl));
            sorted.forEach(m => {
                const div = document.createElement('div');
                div.className = `mon-slot ${tmp.selInv===m.uid?'selected':''}`;
                div.onclick = () => Core.selInv(m.uid); div.innerHTML = UI.renMon(m);
                frag.appendChild(div);
            });
            grid.appendChild(frag);
        },
        selInv: (uid) => {
            tmp.selInv = uid; Core.openInv(); 
            const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
            const max = MAX_LVL[m.star] || 50; const isMax = m.lvl>=max;
            if(!m.skLvl) m.skLvl = d.s.map(()=>1); 

            const pupCost = Math.floor(m.lvl / 5) + 1;
            // C√°lculo de Stats com novas runas
            let rHp = 0, rAtk = 0, rDef = 0, rCrit = 0;
            let runesHtml = '<div class="rune-container">';
            m.runes.forEach((r, idx) => {
                if(r) {
                    if(r.type==='hp') rHp+=r.val; 
                    if(r.type==='atk') rAtk+=r.val; 
                    if(r.type==='def') rDef+=r.val; 
                    if(r.type==='crit') rCrit+=r.val; 
                    
                    // Add Substats to Total
                    if (r.subs) {
                        r.subs.forEach(s => {
                            if(s.type==='hp') rHp+=s.val; 
                            if(s.type==='atk') rAtk+=s.val; 
                            if(s.type==='def') rDef+=s.val; 
                            if(s.type==='crit') rCrit+=s.val; 
                        });
                    }

                    const rClass = r.rarity === 'Lendario' ? 'rune-legend' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                    
                    let icon = '‚ùì';
                    if(r.type==='hp') icon = '‚ù§Ô∏è';
                    else if(r.type==='atk') icon = '‚öîÔ∏è';
                    else if(r.type==='def') icon = 'üõ°Ô∏è';
                    else if(r.type==='crit') icon = 'üí•';

                    runesHtml += `<div class="rune-slot filled" onclick="Core.openRuneSelect(${idx})"><div class="rune-icon ${rClass}">${icon}</div><div class="rune-level-badge">+${r.lvl}</div></div>`;
                } else {
                    runesHtml += `<div class="rune-slot" onclick="Core.openRuneSelect(${idx})"></div>`;
                }
            });
            runesHtml += '</div>';

            let btnPup = `<button class="btn btn-green" onclick="Core.pup(${uid})">Level Up (${pupCost}üß™)</button>`;
            let btnEvo = isMax && m.star<6 ? `<button class="btn btn-purple" onclick="Core.openEvo(${uid})">Evoluir</button>` : '';
            let btnSkl = `<button class="btn btn-blue" onclick="Core.openSkill(${uid})">Skill Up</button>`;
            
            el('inv-detail').innerHTML = `<div class="detail-model">${UI.getVis(d)}</div><h1 style="color:${d.color}">${d.n}</h1>
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px">Elemento: ${d.type} | Nat: ${d.nat}‚òÖ</div>
                <div style="margin-bottom:10px">${UI.renStars(m.star)}</div>
                <div class="detail-stats">
                    <div class="stat-row"><span>Lv</span> <b>${m.lvl}/${max}</b></div>
                    <div class="stat-row"><span>Skills</span> <b>${m.skLvl.join('/')}</b></div>
                    <div class="stat-row"><span>Runas</span> <span class="stat-bonus">+${rAtk} ATK / +${rHp} HP / +${rDef} DEF / +${rCrit}% CRIT</span></div>
                </div>
                ${runesHtml}
                <div class="btn-grp">${btnPup} ${btnSkl} ${btnEvo}</div>`;
        },
        pup: (uid) => {
            if(s.pot<1) return UI.toast("Sem po√ß√µes!", 'error');
            const m = s.roster.find(x=>x.uid===uid);
            if(m.lvl >= (MAX_LVL[m.star]||50)) return UI.toast("N√≠vel M√°ximo!");
            s.pot--; m.lvl++; Game.save(); UI.upd(); Core.selInv(uid);
        },
        
        openRuneBag: () => {
            UI.nav('rune_bag'); 
            const grid = el('rune-bag-grid');
            grid.innerHTML = '';
            if(s.runes_inv.length === 0) {
                grid.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px; width:100%">Nenhuma runa no invent√°rio.</div>';
                return;
            }
            s.runes_inv.forEach(r => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'rune-bag-item';
                const rClass = r.rarity === 'Lendario' ? 'rune-legend' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                const color = r.rarity === 'Lendario' ? '#f59e0b' : r.rarity === 'Epico' ? '#a855f7' : '#3b82f6';
                const sellPrice = r.rarity === 'Lendario' ? 500 : r.rarity === 'Epico' ? 200 : 50;
                
                let icon = '‚ùì';
                if(r.type==='hp') icon = '‚ù§Ô∏è';
                else if(r.type==='atk') icon = '‚öîÔ∏è';
                else if(r.type==='def') icon = 'üõ°Ô∏è';
                else if(r.type==='crit') icon = 'üí•';

                itemDiv.innerHTML = `
                    <div class="rune-icon ${rClass}" style="margin-bottom:5px">${icon}</div>
                    <div class="rune-level-badge" style="background:#000; border:1px solid #444;">+${r.lvl}</div>
                    <div style="font-size:0.7rem; color:${color}; font-weight:bold">${r.rarity}</div>
                    <div style="font-size:0.8rem">+${r.val} ${r.type.toUpperCase()}</div>
                    <div class="rune-btn-group">
                        <button class="rune-action-btn btn-up" onclick="Core.openRuneUpgrade(${r.id}, event)">UP</button>
                        <button class="rune-action-btn btn-sell" onclick="Core.sellRune(${r.id}, ${sellPrice}, event)">$</button>
                    </div>
                `;
                grid.appendChild(itemDiv);
            });
        },
        sellRune: (runeId, price, event) => {
            if(event) event.stopPropagation(); 
            Core.reqConfirm(`Vender por ${price} Mana?`, () => {
                const idx = s.runes_inv.findIndex(r => r.id == runeId); 
                if(idx > -1) {
                    s.runes_inv.splice(idx, 1);
                    s.mana += price;
                    Game.save();
                    UI.upd();
                    Core.openRuneBag(); 
                    UI.toast(`Vendida por +${price} Mana!`);
                }
            });
        },
        
        // --- POWER UP SYSTEM ---
        openRuneUpgrade: (runeId, event) => {
            if(event) event.stopPropagation();
            
            // Find rune in inventory OR equipped (not supported from bag view directly yet, assume inventory for now)
            let r = s.runes_inv.find(x => x.id === runeId);
            
            // If called from openRuneSelect (equipped context), might need different logic, but let's stick to Bag for now.
            // Or if passed explicitly.
            
            if(!r) {
                // Check equipped runes if not found in inv
                 s.roster.forEach(m => {
                    m.runes.forEach(eqR => {
                        if(eqR && eqR.id === runeId) r = eqR;
                    });
                 });
            }

            if(!r) return console.error("Runa n√£o encontrada");

            tmp.upRune = r;
            UI.renRuneDetails(r);
            
            // Calculate Cost and Chance
            const cost = 500 + (r.lvl * 1000);
            let chance = 100;
            if(r.lvl >= 3) chance = 70;
            if(r.lvl >= 6) chance = 50;
            if(r.lvl >= 9) chance = 30;
            if(r.lvl >= 12) chance = 10;
            if(r.lvl >= 15) { chance = 0; el('up-cost').parentElement.disabled = true; el('up-cost').innerText = "MAX"; }
            else { el('up-cost').parentElement.disabled = false; el('up-cost').innerText = cost; }

            el('up-chance').innerText = chance > 0 ? `${chance}%` : "MAX";
            el('up-chance').style.color = chance >= 70 ? "#4ade80" : chance >= 30 ? "#fbbf24" : "#ef4444";

            UI.modal('m-rune-up', 1);
        },
        
        doUpgrade: () => {
            const r = tmp.upRune;
            if(r.lvl >= 15) return UI.toast("N√≠vel M√°ximo!");
            
            const cost = 500 + (r.lvl * 1000);
            if(s.mana < cost) return UI.toast("Mana Insuficiente!", 'error');
            
            s.mana -= cost;
            UI.upd();
            
            // Chance Logic
            let chance = 1; // 100%
            if(r.lvl >= 3) chance = 0.7;
            if(r.lvl >= 6) chance = 0.5;
            if(r.lvl >= 9) chance = 0.3;
            if(r.lvl >= 12) chance = 0.1;
            
            const success = Math.random() < chance;
            
            // Visual Effect
            const box = el('rune-up-content');
            box.classList.add('up-animation');
            setTimeout(() => box.classList.remove('up-animation'), 500);

            if(success) {
                r.lvl++;
                // Main Stat Increase (Simple +10% base or flat amount)
                r.val = Math.ceil(r.val * 1.1); // +10% per level exponential-ish

                // Substat Logic at +3, +6, +9, +12
                if (r.lvl % 3 === 0) {
                    const subTypes = ['hp', 'atk', 'def', 'crit'];
                    // Max subs depends on rarity (Legendary starts with 3? Let's say max 4 slots for everyone eventually)
                    // Simplified: Always try to add or upgrade.
                    
                    if (r.subs.length < 4) {
                        // Add new sub
                        const newType = subTypes[Math.floor(Math.random() * subTypes.length)];
                        const newVal = Math.floor(Math.random() * 5) + 3; // 3-8
                        r.subs.push({ type: newType, val: newVal });
                        UI.toast(`Sucesso! +${r.lvl} (Novo Substatus!)`);
                    } else {
                        // Upgrade existing sub
                        const subIdx = Math.floor(Math.random() * r.subs.length);
                        r.subs[subIdx].val += Math.floor(Math.random() * 4) + 2; // +2-6
                        UI.toast(`Sucesso! +${r.lvl} (Substatus Melhorado!)`);
                    }
                } else {
                    UI.toast(`Sucesso! +${r.lvl}`);
                }
                
                Game.save();
                UI.renRuneDetails(r); // Refresh modal UI
                
                // Recalculate cost for next level
                const nextCost = 500 + (r.lvl * 1000);
                if(r.lvl < 15) {
                    el('up-cost').innerText = nextCost;
                    // Update chance display
                    let nextChance = 100;
                    if(r.lvl >= 3) nextChance = 70;
                    if(r.lvl >= 6) nextChance = 50;
                    if(r.lvl >= 9) nextChance = 30;
                    if(r.lvl >= 12) nextChance = 10;
                    el('up-chance').innerText = `${nextChance}%`;
                    el('up-chance').style.color = nextChance >= 70 ? "#4ade80" : nextChance >= 30 ? "#fbbf24" : "#ef4444";
                } else {
                    el('up-cost').innerText = "MAX";
                    el('up-cost').parentElement.disabled = true;
                    el('up-chance').innerText = "MAX";
                }
                
                // Update background lists if visible
                if(el('rune_bag').classList.contains('active')) Core.openRuneBag();
                if(el('inv').classList.contains('active')) Core.selInv(tmp.selInv); // Refresh inv view

            } else {
                UI.toast("Falhou...", 'error');
            }
        },

        openRuneSelect: (slotIdx) => {
            tmp.selRuneSlot = slotIdx;
            const m = s.roster.find(x=>x.uid===tmp.selInv);
            const currentRune = m.runes[slotIdx];
            let html = '';
            if (currentRune) {
                const rClass = currentRune.rarity === 'Lendario' ? 'rune-legend' : currentRune.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                let icon = '‚ùì';
                if(currentRune.type==='hp') icon = '‚ù§Ô∏è';
                else if(currentRune.type==='atk') icon = '‚öîÔ∏è';
                else if(currentRune.type==='def') icon = 'üõ°Ô∏è';
                else if(currentRune.type==='crit') icon = 'üí•';

                html += `<div class="rune-list-item">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="rune-icon ${rClass}" style="width:30px;height:30px;font-size:0.8rem">${icon}</div>
                        <div>
                            <div style="font-size:0.8rem; font-weight:bold;">+${currentRune.lvl} ${currentRune.rarity}</div>
                            <div style="font-size:0.7rem;">${currentRune.type.toUpperCase()} +${currentRune.val}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="rune-action-btn btn-up" style="width:40px;" onclick="Core.openRuneUpgrade(${currentRune.id}, event)">UP</button>
                        <button class="rune-action-btn btn-sell" style="width:40px;" onclick="Core.unequipRune()">‚ùå</button>
                    </div>
                </div><hr style="border-color:#444; margin:10px 0;">`;
            }
            if (s.runes_inv.length === 0) {
                html += '<div style="color:#aaa; text-align:center">Nenhuma runa no invent√°rio.</div>';
            } else {
                s.runes_inv.forEach(r => {
                    const rClass = r.rarity === 'Lendario' ? 'rune-legend' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                    const color = r.rarity === 'Lendario' ? '#f59e0b' : r.rarity === 'Epico' ? '#a855f7' : '#3b82f6';
                    
                    let icon = '‚ùì';
                    if(r.type==='hp') icon = '‚ù§Ô∏è';
                    else if(r.type==='atk') icon = '‚öîÔ∏è';
                    else if(r.type==='def') icon = 'üõ°Ô∏è';
                    else if(r.type==='crit') icon = 'üí•';

                    html += `<div class="rune-list-item" onclick="Core.equipRune(${r.id})">
                        <div>
                            <span style="color:${color}; font-weight:bold">+${r.lvl} ${r.rarity}</span> 
                            <span>+${r.val} ${r.type.toUpperCase()}</span>
                        </div>
                        <div class="rune-icon ${rClass}" style="width:25px;height:25px;font-size:0.6rem">${icon}</div>
                    </div>`;
                });
            }
            el('rune-list').innerHTML = html;
            UI.modal('m-rune', 1);
        },
        equipRune: (runeId) => {
            const m = s.roster.find(x=>x.uid===tmp.selInv);
            const runeIdx = s.runes_inv.findIndex(r => r.id === runeId);
            const newRune = s.runes_inv[runeIdx];
            if (m.runes[tmp.selRuneSlot]) {
                s.runes_inv.push(m.runes[tmp.selRuneSlot]);
            }
            m.runes[tmp.selRuneSlot] = newRune;
            s.runes_inv.splice(runeIdx, 1);
            Game.save(); UI.modal('m-rune', 0); Core.selInv(tmp.selInv);
        },
        unequipRune: () => {
            const cost = 1000;
            if(s.mana < cost) return UI.toast(`Mana insuficiente! Precisa de ${cost} üí†`, 'error');
            
            Core.reqConfirm(`Gastar ${cost} Mana para remover?`, () => {
                const m = s.roster.find(x=>x.uid===tmp.selInv);
                const oldRune = m.runes[tmp.selRuneSlot];
                if (oldRune) {
                    s.mana -= cost;
                    s.runes_inv.push(oldRune);
                    m.runes[tmp.selRuneSlot] = null;
                    Game.save(); UI.upd(); UI.modal('m-rune', 0); Core.selInv(tmp.selInv);
                    UI.toast("Runa removida!");
                }
            });
        },

        renExpl: () => {
            const grid = el('expl-grid'); grid.innerHTML = ''; const frag = document.createDocumentFragment();
            for(let i=1; i<=30; i++) {
                const locked = i > s.maxStage;
                const cleared = s.cleared.includes(`story-${i}`);
                const div = document.createElement('div');
                div.className = `stage-btn ${locked?'locked':''} ${i<s.maxStage?'cleared':''}`;
                div.onclick = () => Core.prepFight('story', i);
                let badge = !cleared && !locked ? `<div class="first-clear-badge">50üíé</div>` : '';
                div.innerHTML = `${i<s.maxStage ? '‚úîÔ∏è' : i} ${badge} <div style="font-size:0.6rem; color:#888">N√≠vel ${i}</div>`;
                frag.appendChild(div);
            }
            grid.appendChild(frag);
        },
        
        // --- NOVA L√ìGICA DE MASMORRA SEPARADA ---
        renDungSelect: () => {
            // Garante que s√≥ o menu de sele√ß√£o aparece
            el('dung-select').style.display = 'flex';
            el('dung-floors').style.display = 'none';
        },
        selectDung: (type) => {
            tmp.dungType = type;
            el('dung-select').style.display = 'none';
            el('dung-floors').style.display = 'flex';
            Core.renDungFloors();
        },
        backToDungSelect: () => {
            tmp.dungType = null;
            Core.renDungSelect();
        },
        renDungFloors: () => {
            const container = el('dung-list-container');
            container.innerHTML = '';
            
            const type = tmp.dungType; // 'golem' ou 'dragon'
            const color = type === 'golem' ? '#a3e635' : '#f87171';
            const icon = type === 'golem' ? 'üóø' : 'üêâ';
            const title = type === 'golem' ? 'Fortaleza do Gigante' : 'Covil do Drag√£o';
            
            // T√≠tulo da se√ß√£o (opcional)
            const header = document.createElement('div');
            header.style.textAlign = 'center'; header.style.marginBottom = '10px';
            header.innerHTML = `<h2 style="color:${color}; text-transform:uppercase;">${icon} ${title}</h2>`;
            container.appendChild(header);

            const frag = document.createDocumentFragment();
            for(let i=1; i<=10; i++) {
                const stageKey = type === 'golem' ? `golem-${i}` : `dragon-${i}`;
                const cleared = s.cleared.includes(stageKey);
                // Bloqueia se o anterior n√£o foi limpo (opcional, aqui deixei aberto para teste, ou pode travar)
                // Vamos travar: nivel 1 liberado, outros precisam do anterior
                const prevKey = type === 'golem' ? `golem-${i-1}` : `dragon-${i-1}`;
                const locked = i > 1 && !s.cleared.includes(prevKey);

                const btn = document.createElement('div');
                btn.className = `sw-floor-btn ${cleared?'cleared':''} ${locked?'locked':''}`;
                btn.onclick = () => { if(!locked) Core.prepFight(`dungeon-${type}`, i); };
                
                // Configura drop icon
                let drops = '';
                if(type==='golem') drops = '‚ù§Ô∏è üõ°Ô∏è'; else drops = '‚öîÔ∏è üí•';

                btn.innerHTML = `
                    <div class="floor-idx">B${i}</div>
                    <div class="floor-name">Andar ${i}</div>
                    <div class="floor-drop-icon" style="color:${color}">${drops}</div>
                    ${!cleared && !locked ? '<div class="first-clear-badge" style="position:static; margin-left:10px;">üíé</div>' : ''}
                `;
                frag.appendChild(btn);
            }
            container.appendChild(frag);
        },

        // --- L√ìGICA DE DUNG ANTIGA REMOVIDA, AGORA USAMOS A NOVA ACIMA ---
        renDung: () => { /* Deprecated by new structure */ },

        prepFight: (mode, level) => {
            tmp.mode = mode; tmp.lvl = level; tmp.prep = []; UI.nav('prep'); Prep.render();
        },

        // --- EVOLUTION & SKILL UP ---
        openEvo: (uid) => { tmp.evoTarget=uid; tmp.evoFodder=[]; el('evo-req-c').innerText=s.roster.find(x=>x.uid===uid).star; el('evo-req-s').innerText=s.roster.find(x=>x.uid===uid).star; UI.modal('m-evo',1); Core.renEvo(); },
        renEvo: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('evo-grid'); grid.innerHTML = ''; const slots = el('evo-slots'); slots.innerHTML = '';
            const fragGrid = document.createDocumentFragment(); const fragSlots = document.createDocumentFragment();
            for(let i=0; i<tgt.star; i++) { 
                const f=tmp.evoFodder[i]; const d = document.createElement('div');
                if(f) { d.className='mon-slot'; d.onclick=()=>Core.togFodder(f); d.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); }
                else { d.className='mat-slot'; d.innerText='Slot'; }
                fragSlots.appendChild(d);
            }
            slots.appendChild(fragSlots);
            s.roster.filter(m=>m.star===tgt.star&&m.uid!==tgt.uid).forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-slot ${tmp.evoFodder.includes(m.uid)?'fodder':''} ${m.id===tgt.id?'skill-up':''}`;
                d.onclick = () => Core.togFodder(m.uid); d.innerHTML = UI.renMon(m);
                fragGrid.appendChild(d);
            });
            grid.appendChild(fragGrid);
            el('btn-do-evo').disabled=tmp.evoFodder.length<tgt.star; el('btn-do-evo').style.opacity=tmp.evoFodder.length<tgt.star?0.5:1;
        },
        togFodder: (uid) => {
            if(tmp.evoFodder.includes(uid)) tmp.evoFodder=tmp.evoFodder.filter(x=>x!==uid); else if(tmp.evoFodder.length<s.roster.find(x=>x.uid===tmp.evoTarget).star) tmp.evoFodder.push(uid);
            Core.renEvo();
        },
        doEvolution: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            let skillUps = 0;
            tmp.evoFodder.forEach(fid => { const f = s.roster.find(x=>x.uid===fid); if(f.id === t.id) skillUps++; });
            s.roster = s.roster.filter(m=>!tmp.evoFodder.includes(m.uid));
            t.star++; t.lvl=1; 
            for(let i=0; i<skillUps; i++) { const rnd = Math.floor(Math.random()*t.skLvl.length); if(t.skLvl[rnd]<5) t.skLvl[rnd]++; }
            Game.save(); UI.modal('m-evo',0); Core.openInv(); UI.toast(`Evolu√≠do! +${skillUps} Skills.`);
        },
        openSkill: (uid) => { tmp.evoTarget=uid; tmp.skillFodder=[]; UI.modal('m-skill',1); Core.renSkill(); },
        renSkill: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('skill-grid'); grid.innerHTML = ''; const slots = el('skill-slots'); slots.innerHTML = '';
            const fragGrid = document.createDocumentFragment(); const fragSlots = document.createDocumentFragment();
            const f = tmp.skillFodder[0]; const dS = document.createElement('div');
            if(f) { dS.className='mon-slot'; dS.onclick=()=>Core.togSkill(f); dS.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); }
            else { dS.className='mat-slot'; dS.innerText='Dupe'; }
            fragSlots.appendChild(dS); slots.appendChild(fragSlots);
            const dupes = s.roster.filter(m => m.id === tgt.id && m.uid !== tgt.uid);
            if(dupes.length) {
                dupes.forEach(m => {
                    const d = document.createElement('div'); d.className = `mon-slot ${tmp.skillFodder.includes(m.uid)?'fodder':''}`;
                    d.onclick = () => Core.togSkill(m.uid); d.innerHTML = UI.renMon(m); fragGrid.appendChild(d);
                });
            } else { grid.innerHTML = '<div style="color:#aaa; padding:10px">Sem duplicatas.</div>'; }
            if(dupes.length) grid.appendChild(fragGrid);
            el('btn-do-skill').disabled = tmp.skillFodder.length === 0; el('btn-do-skill').style.opacity = tmp.skillFodder.length === 0 ? 0.5 : 1;
        },
        togSkill: (uid) => {
            if(tmp.skillFodder.includes(uid)) tmp.skillFodder=[]; else if(tmp.skillFodder.length<1) tmp.skillFodder.push(uid);
            Core.renSkill();
        },
        doSkill: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            s.roster = s.roster.filter(m=>!tmp.skillFodder.includes(m.uid));
            const rnd = Math.floor(Math.random()*t.skLvl.length);
            if(t.skLvl[rnd] < 5) t.skLvl[rnd]++; else { const notMax = t.skLvl.map((l,i)=>({l,i})).filter(x=>x.l<5); if(notMax.length) t.skLvl[notMax[Math.floor(Math.random()*notMax.length)].i]++; }
            Game.save(); UI.modal('m-skill',0); Core.selInv(t.uid); UI.toast(`Skill aprimorada!`);
        },
        useGrimoire: () => {
            if(s.grimoires < 1) return UI.toast("Sem Grim√≥rios!", 'error');
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            const notMax = t.skLvl.map((l,i)=>({l,i})).filter(x=>x.l<5);
            if(notMax.length === 0) return UI.toast("Todas as skills est√£o no m√°ximo!", 'error');
            s.grimoires--; const rnd = Math.floor(Math.random()*notMax.length); t.skLvl[notMax[rnd].i]++;
            Game.save(); UI.upd(); UI.modal('m-skill',0); Core.selInv(t.uid); UI.toast("Skill Aprimorada com Grim√≥rio!");
        }
    };

    const Prep = {
        render: () => {
            const grid = el('prep-grid'); grid.innerHTML = ''; const frag = document.createDocumentFragment();
            [0,1,2].forEach(i => {
                const uid = tmp.prep[i]; const sl = el(`s${i}`);
                sl.className = uid ? 'prep-slot filled' : 'prep-slot';
                sl.innerHTML = uid ? UI.renMon(s.roster.find(x=>x.uid===uid)) : '+';
            });
            const sorted = [...s.roster].sort((a,b) => (b.star - a.star) || (b.lvl - a.lvl));
            sorted.forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-slot ${tmp.prep.includes(m.uid)?'selected':''}`;
                d.onclick = () => Prep.pick(m.uid); d.innerHTML = UI.renMon(m); frag.appendChild(d);
            });
            grid.appendChild(frag); 
            
            el('btn-fight').disabled = tmp.prep.length===0;

            const stageKey = tmp.mode === 'story' ? `story-${tmp.lvl}` : (tmp.mode === 'dungeon-golem' ? `golem-${tmp.lvl}` : `dragon-${tmp.lvl}`);
            const isCleared = s.cleared.includes(stageKey);
            const farmBtn = el('btn-farm');
            if (isCleared && tmp.prep.length > 0) {
                farmBtn.style.display = 'block';
            } else {
                farmBtn.style.display = 'none';
            }
        },
        pick: (uid) => {
            if(tmp.prep.includes(uid)) tmp.prep=tmp.prep.filter(x=>x!==uid); else if(tmp.prep.length<3) tmp.prep.push(uid);
            Prep.render();
        },
        rem: (i) => { if(tmp.prep[i]) { tmp.prep.splice(i,1); Prep.render(); } }
    };

    /* --- BATALHA --- */
    const Battle = {
        spd: () => { 
            if(b.spd === 1) b.spd = 2;
            else if(b.spd === 2) {
                if(s.p_lvl >= 5) b.spd = 3;
                else b.spd = 1;
            } else if (b.spd === 3) {
                 if (b.farmRuns > 0) b.spd = 5; 
                 else b.spd = 1;
            } else if (b.spd === 5) {
                 b.spd = 1;
            } else {
                b.spd = 1;
            }
            el('btn-spd').innerText = 'x' + b.spd;
        },
        toggleAuto: () => {
            b.auto = !b.auto;
            const btn = el('btn-auto');
            if (b.auto) { btn.classList.add('active'); Battle.turn(); } 
            else btn.classList.remove('active');
        },
        start: (farmRuns = 0) => {
            if(tmp.prep.length===0) return;
            
            // Initializing skillPending for support selection
            b.skillPending = null;

            b.farmRuns = farmRuns;
            if (farmRuns > 0) {
                b.spd = 5; 
                b.auto = true;
                el('btn-auto').classList.add('active');
                el('farm-ui').style.display = 'block';
                el('farm-count').innerText = farmRuns;
            } else {
                b.spd = 1;
                el('farm-ui').style.display = 'none';
                
                const btnAuto = el('btn-auto');
                if (s.p_lvl >= 2) {
                    btnAuto.style.display = 'flex';
                    btnAuto.classList.remove('active');
                    b.auto = false;
                } else {
                    btnAuto.style.display = 'none';
                }
            }
            el('btn-spd').innerText='x' + b.spd;

            b.p = tmp.prep.map((uid,i) => {
                const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
                const sm = 1 + m.lvl*0.1 + (m.star * 0.3);
                let rHp = 0, rAtk = 0, rDef = 0, rCrit = 0;
                m.runes.forEach(r => { if(r) { 
                    if(r.type==='hp') rHp+=r.val; 
                    if(r.type==='atk') rAtk+=r.val; 
                    if(r.type==='def') rDef+=r.val; 
                    if(r.type==='crit') rCrit+=r.val; 
                    
                    // Add Substats to Battle Stats
                    if (r.subs) {
                        r.subs.forEach(s => {
                            if(s.type==='hp') rHp+=s.val; 
                            if(s.type==='atk') rAtk+=s.val; 
                            if(s.type==='def') rDef+=s.val; 
                            if(s.type==='crit') rCrit+=s.val; 
                        });
                    }
                }});
                
                const finalHp = Math.floor((d.hp*sm) + rHp);
                const finalAtk = Math.floor((d.atk*sm) + rAtk);
                return {...d, max:finalHp, cur:finalHp, atk:finalAtk, def:rDef, crit:rCrit, idx:i, side:'p', dead:false, cds:d.s.map(()=>0), skLvl:m.skLvl};
            });

            if(tmp.mode === 'story') {
                const diff = 1 + (tmp.lvl * 0.5); 
                b.e = Array(3).fill(0).map((_,i) => {
                    const maxNat = Math.min(3, Math.ceil(tmp.lvl/3));
                    const pool = DB.filter(x => x.nat <= maxNat);
                    const base = pool[Math.floor(Math.random()*pool.length)];
                    return {
                        ...base, 
                        max: Math.floor(base.hp * diff), cur: Math.floor(base.hp * diff), atk: Math.floor(base.atk * diff), def:0, crit:0,
                        idx:i, side:'e', dead:false, cds:base.s.map(()=>0), skLvl:base.s.map(()=>1), isBoss:false
                    };
                });
            } else {
                // MASMORRA: CHEFE FIXO
                const diff = 1 + (tmp.lvl * 0.8); 
                let bossBase;
                if (tmp.mode === 'dungeon-golem') bossBase = DB.find(x=>x.id===901); // Golem
                else bossBase = DB.find(x=>x.id===902); // Drag√£o

                b.e = [{
                    ...bossBase,
                    max: Math.floor(bossBase.hp * 5 * diff), cur: Math.floor(bossBase.hp * 5 * diff), atk: Math.floor(bossBase.atk * 1.5 * diff), def: Math.floor(tmp.lvl * 5), crit: Math.floor(tmp.lvl * 2),
                    idx:0, side:'e', dead:false, cds:bossBase.s.map(()=>0), skLvl:bossBase.s.map(()=>3), isBoss:true
                }];
            }

            b.t='p'; b.idx=0; b.target=null;
            UI.nav('battle'); Battle.draw(); Battle.turn();
        },
        draw: () => {
            el('r-ene').innerHTML = b.e.map(u => Battle.renUnit(u)).join('');
            el('r-pla').innerHTML = b.p.map(u => Battle.renUnit(u)).join('');
        },
        renUnit: (u) => {
            const isAct = !u.dead && ((b.t==='p' && u.side==='p' && b.idx===u.idx) || (b.t==='e' && u.side==='e' && b.idx===u.idx));
            const isTgt = !u.dead && b.target===u.idx && u.side==='e';
            
            // Add visual cue if selecting ally
            const isSelectable = b.skillPending !== null && u.side === 'p' && !u.dead;
            
            return `
                <div id="${u.side}${u.idx}" class="unit ${u.isBoss?'boss-unit':''} ${u.dead?'dead':''} ${isAct?'actor':''} ${isTgt?'targeted':''} ${isSelectable?'selectable':''}" 
                     onclick="Battle.clickUnit('${u.side}', ${u.idx})">
                    ${isTgt ? '<div class="target-marker">üéØ</div>' : ''}
                    <div class="hp-container"><div class="hp-bar"><div class="hp-fill" style="width:${(u.cur/u.max)*100}%; background:${u.side==='e'?'var(--danger)':'var(--success)'}"></div></div></div>
                    <div class="unit-sprite">${UI.getVis(u)}</div>
                </div>`;
        },
        clickUnit: (side, idx) => {
            if (b.t !== 'p') return; // Not player turn

            // Mode 1: Selecting Ally for Support Skill
            if (b.skillPending !== null) {
                if (side === 'p') {
                    // Execute Skill
                    const u = b.p[b.idx];
                    const skill = u.s[b.skillPending];
                    
                    // Cleanup UI
                    const skillIdx = b.skillPending;
                    b.skillPending = null;
                    el('btl-ui').classList.remove('active');
                    Battle.draw(); // Remove selectable classes

                    // Execute Hit
                    u.cds[skillIdx] = skill.cd + 1;
                    Battle.hit(u, b.p[idx], skill.m, u.skLvl[skillIdx], skill.ty);
                    
                    // Reset target var just in case
                    b.target = null; 
                }
                return;
            }

            // Mode 2: Selecting Enemy for Attack (Default behavior)
            // Original target logic adapted
            if (side === 'e' && !b.e[idx].dead) {
                b.target = b.target === idx ? null : idx;
                Battle.draw();
            }
        },
        target: (i) => { 
            // Deprecated, replaced by clickUnit
            Battle.clickUnit('e', i);
        },
        turn: () => {
            if(b.e.every(x=>x.dead)) return Battle.end(1); if(b.p.every(x=>x.dead)) return Battle.end(0);
            el('stg').classList.remove('cinematic');
            document.querySelectorAll('.unit').forEach(u => {
                u.classList.remove('actor', 'target-focus', 'hit-anim', 'attacking-p', 'attacking-e');
                if(u.classList.contains('dead')) { u.style.pointerEvents='none'; }
            });
            
            // Ensure skillPending is cleared on turn start just in case
            b.skillPending = null;
            
            Battle.draw();
            
            if(b.t==='p') {
                if(b.idx>=b.p.length) { b.t='e'; b.idx=0; return Battle.turn(); }
                const u = b.p[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));

                if (b.auto) {
                    el('btl-ui').classList.remove('active');
                    setTimeout(() => {
                        // AUTO MODE SAFETY CHECK
                        // Ensure we have a valid attacker 'u' (already checked above)
                        
                        let skillIdx = 0;
                        const hasS3 = u.s[2] && u.cds[2] === 0;
                        const hasS2 = u.s[1] && u.cds[1] === 0;
                        if (hasS3) skillIdx = 2; else if (hasS2) skillIdx = 1;
                        
                        const skill = u.s[skillIdx];
                        let target = null;

                        if (skill.ty === 'heal') {
                            // Find ally with lowest % HP
                            target = b.p.filter(a => !a.dead).sort((a,b) => (a.cur/a.max) - (b.cur/b.max))[0];
                        } else if (skill.ty === 'turn') {
                            // Find ally that isn't me, or me if solo
                            const allies = b.p.filter(a => !a.dead && a.idx !== u.idx);
                            target = allies.length ? allies[Math.floor(Math.random()*allies.length)] : u; 
                        } else {
                            // Attack Enemy
                            const enemies = b.e.filter(e => !e.dead);
                            if(enemies.length > 0) {
                                target = enemies[Math.floor(Math.random() * enemies.length)];
                            }
                        }
                        
                        // Fallback Safety: If logic failed to find target (rare but prevents freeze), target self or first enemy
                        if (!target) {
                            if (skill.ty === 'heal' || skill.ty === 'turn') target = u;
                            else {
                                const livingEnemies = b.e.filter(e => !e.dead);
                                if(livingEnemies.length > 0) target = livingEnemies[0];
                                else {
                                    // No enemies alive? End battle should have triggered. Force check.
                                    return Battle.turn();
                                }
                            }
                        }

                        u.cds[skillIdx] = u.s[skillIdx].cd + 1;
                        Battle.hit(u, target, u.s[skillIdx].m, u.skLvl[skillIdx], u.s[skillIdx].ty);
                        
                    }, 500 / b.spd);
                    return;
                }

                el('act-name').innerText=u.n; 
                el('act-target').innerText = "Sua Vez - Selecione Alvo";
                el('act-target').style.color = ""; // Reset color
                el('btl-ui').classList.add('active');
                
                el('skill-list').innerHTML = u.s.map((sk,i) => {
                    const cd = u.cds[i]>0;
                    let typeText = 'ATQ'; let typeColor = '#f87171';
                    if (sk.ty === 'heal') { typeText = 'CURA'; typeColor = '#4ade80'; }
                    else if (sk.ty === 'turn') { typeText = 'SUP'; typeColor = '#60a5fa'; }
                    else if (sk.ty === 'aoe') { typeText = '√ÅREA'; typeColor = '#fbbf24'; } 
                    
                    return `<div class="skill-btn ${i===0?'main':i===1?'spec':'ulti'} ${cd?'cooldown':''}" onclick="${cd?'':'Battle.act('+i+')'}">
                        <div style="margin-bottom:6px">${i===0?'‚öîÔ∏è':i===1?'‚ö°':'üî•'}</div>
                        ${cd?`<div class="cd-overlay">${u.cds[i]}</div>`:''} 
                        <div style="position:absolute; bottom:6px; font-size:0.6rem; font-weight:900; color:${typeColor}; text-shadow:0 1px 1px black">${typeText}</div>
                        <small>Lv.${u.skLvl[i]}</small>
                    </div>`;
                }).join('');
            } else {
                el('btl-ui').classList.remove('active');
                if(b.idx>=b.e.length) { b.t='p'; b.idx=0; return Battle.turn(); }
                const u = b.e[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));
                setTimeout(() => {
                    const tg = b.p.filter(x=>!x.dead);
                    if(tg.length) {
                        const avail = u.s.map((s,i)=>({i, ...s})).filter(s => u.cds[s.i]===0);
                        const skill = avail.length ? avail[Math.floor(Math.random()*avail.length)] : {i:0, m:1, cd:0};
                        u.cds[skill.i] = skill.cd + 1;
                        Battle.hit(u, tg[Math.floor(Math.random()*tg.length)], skill.m, 1, skill.ty);
                    } else { b.idx++; Battle.turn(); }
                }, 800/b.spd);
            }
        },
        act: (i) => { 
            const u = b.p[b.idx]; 
            const skill = u.s[i];

            // Check if skill targets allies (heal/turn)
            if (skill.ty === 'heal' || skill.ty === 'turn') {
                b.skillPending = i;
                // Update UI to tell user what to do
                el('act-target').innerText = "Selecione um Aliado";
                el('act-target').style.color = "#4ade80"; // Green
                Battle.draw(); // Re-render to show selectable allies
                return; // Stop here, wait for clickUnit
            }

            // Normal Offensive Skill Logic
            u.cds[i] = skill.cd + 1; 
            el('btl-ui').classList.remove('active');
            let t = null;
            
            if(b.target!==null && !b.e[b.target].dead) t = b.e[b.target]; 
            else { const l = b.e.filter(x=>!x.dead); if(l.length) t=l[0]; }
            
            if(t || skill.ty === 'aoe') Battle.hit(u,t,skill.m, u.skLvl[i], skill.ty); else { b.idx++; Battle.turn(); }
            b.target=null; 
        },
        hit: (atk, def, baseMult, skillLvl, type) => {
            el('stg').classList.add('cinematic');
            const aEl = el(`${atk.side}${atk.idx}`); 
            // If AoE, def might be undefined/first enemy, but hit logic iterates all. 
            // For single target, highlight defender.
            if(def) {
                const dEl = el(`${def.side}${def.idx}`);
                dEl.classList.add('target-focus');
            }
            
            aEl.classList.add('actor', atk.side==='p'?'attacking-p':'attacking-e'); 
            
            setTimeout(() => {
                aEl.classList.remove('attacking-p','attacking-e'); 
                if (type === 'heal') {
                    const healAmount = Math.floor(atk.atk * baseMult * (1 + (skillLvl-1)*0.2));
                    def.cur = Math.min(def.max, def.cur + healAmount);
                    
                    const dEl = el(`${def.side}${def.idx}`);
                    const txt = document.createElement('div'); txt.className='dmg-txt'; 
                    txt.style.color = '#10b981'; txt.innerText = `+${healAmount}`;
                    dEl.appendChild(txt); setTimeout(()=>txt.remove(), 1000/b.spd);
                    dEl.querySelector('.hp-fill').style.width = `${(def.cur/def.max)*100}%`;
                } else if (type === 'turn') {
                    const dEl = el(`${def.side}${def.idx}`);
                    const txt = document.createElement('div'); txt.className='dmg-txt'; 
                    txt.style.color = '#3b82f6'; txt.style.fontSize = '1.5rem'; txt.innerText = "TURNO EXTRA!";
                    dEl.appendChild(txt); setTimeout(()=>txt.remove(), 1000/b.spd);
                    
                    // Simple turn logic for enemy (player already manually plays)
                    if (def.side === 'e') {
                        setTimeout(() => {
                            const enemies = b.e.filter(e => !e.dead);
                            if(enemies.length) {
                                const target = enemies[Math.floor(Math.random()*enemies.length)];
                                Battle.hit(def, target, def.s[0].m, def.skLvl[0]);
                                return; 
                            }
                        }, 500/b.spd);
                    } else if (def.side === 'p') {
                        // Se for jogador e ganhou turno extra, chama Battle.turn SEM incrementar b.idx
                        setTimeout(Battle.turn, 800/b.spd);
                        return; // Sai da fun√ß√£o para evitar o incremento padr√£o abaixo
                    }
                } else if (type === 'aoe') {
                    const targets = atk.side === 'p' ? b.e : b.p;
                    el('app').classList.add('shake-screen');
                    setTimeout(()=>el('app').classList.remove('shake-screen'), 300);

                    targets.forEach(target => {
                        if (!target.dead) {
                            Battle.applyDmg(atk, target, baseMult, skillLvl, true);
                        }
                    });
                } else {
                    el('app').classList.add('shake-screen'); setTimeout(()=>el('app').classList.remove('shake-screen'), 300);
                    Battle.applyDmg(atk, def, baseMult, skillLvl, false);
                }
                
                // Padr√£o: Incrementa e pr√≥ximo turno
                b.idx++; 
                setTimeout(Battle.turn, 800/b.spd);
            }, 300/b.spd);
        },
        
        applyDmg: (atk, def, baseMult, skillLvl, isAoE) => {
            const dEl = el(`${def.side}${def.idx}`);
            dEl.classList.add('hit-anim'); 
            
            // Defesa reduz % de dano. Ex: 100 def = 50% de redu√ß√£o
            const defRed = 100 / (100 + (def.def || 0));
            const bonus = (skillLvl - 1) * 0.2; 
            let finalMult = baseMult + bonus; 
            
            // Critico
            let isCrit = false;
            if (atk.crit && Math.random() * 100 < atk.crit) {
                finalMult *= 1.5;
                isCrit = true;
            }

            const rawDmg = atk.atk * finalMult;
            const dmg = Math.floor(rawDmg * defRed);
            
            def.cur = Math.max(0, def.cur - dmg);
            
            const txt = document.createElement('div'); 
            txt.className = 'dmg-txt'; 
            if(isCrit) { txt.style.color = '#ef4444'; txt.style.fontSize = '4rem'; txt.innerText = "CRIT! " + dmg; }
            else if(skillLvl > 1) { txt.style.color = '#ffff00'; txt.innerText = dmg; }
            else { txt.innerText = dmg; }

            dEl.appendChild(txt);
            setTimeout(()=>txt.remove(), 1000/b.spd);
            
            dEl.querySelector('.hp-fill').style.width = `${(def.cur/def.max)*100}%`;
            
            if(def.cur === 0) { 
                def.dead = true; 
                dEl.classList.remove('target-focus', 'hit-anim'); 
                dEl.classList.add('dead'); 
            }
        },

        end: (w) => {
            el('stg').classList.remove('cinematic');
            setTimeout(() => {
                let rewardMsg = "", itemIcon = "", itemQtd = "", gemsAwarded = 0, accXpGain = 0;
                let runeDrop = "";
                if(w) {
                    const stageKey = tmp.mode === 'story' ? `story-${tmp.lvl}` : (tmp.mode === 'dungeon-golem' ? `golem-${tmp.lvl}` : `dragon-${tmp.lvl}`);
                    
                    const firstClear = !s.cleared.includes(stageKey);
                    if(firstClear) { s.cleared.push(stageKey); gemsAwarded = 50; } else { gemsAwarded = 5; }
                    s.gems += gemsAwarded;
                    
                    let baseVal = tmp.mode === 'story' ? 50 + (tmp.lvl * 20) : 300 + (tmp.lvl * 50);
                    let xpBase = baseVal; 
                    if(s.xp_boosters > 0) { xpBase *= 3; s.xp_boosters--; }
                    accXpGain = xpBase; s.xp += accXpGain;

                    if(s.xp >= s.max_xp) { s.p_lvl++; s.xp -= s.max_xp; s.max_xp = Math.floor(s.max_xp * 1.5); s.gems += 100; UI.toast("LEVEL UP! +100 Cristais üíé"); }
                    
                    if(tmp.mode === 'story') {
                        const rMana = 50 * tmp.lvl + 50; 
                        const rPot = Math.floor(tmp.lvl / 2) + 1; s.mana += rMana; s.pot += rPot;
                        itemIcon = "üß™"; itemQtd = `+${rPot}`; 
                        if (b.farmRuns <= 1) el('end-mana').innerText = `+${rMana}`; 
                        rewardMsg = "VIT√ìRIA!";
                        if(tmp.lvl === s.maxStage) s.maxStage++;
                    } else { 
                        // --- DROP SYSTEM SUMMONERS STYLE ---
                        const rarities = ['Comum', 'Raro', 'Epico', 'Lendario'];
                        let rIdx = 0;
                        const rnd = Math.random() * 100;
                        
                        // Escalonamento de Drop por Andar (1-10)
                        if (tmp.lvl <= 3) {
                            if(rnd>90) rIdx=1; // Mostly Common, 10% Rare
                        } else if (tmp.lvl <= 6) {
                            rIdx=1; if(rnd>80) rIdx=2; // Mostly Rare, 20% Epic
                        } else if (tmp.lvl <= 9) {
                            rIdx=1; if(rnd>50) rIdx=2; if(rnd>95) rIdx=3; // Rare/Epic split, 5% Leg
                        } else {
                            rIdx=2; if(rnd>90) rIdx=3; // Mostly Epic, 10% Leg
                        }

                        const rarity = rarities[rIdx];
                        
                        // Tipo de Runa Baseado na Dungeon
                        let type = 'hp';
                        if (tmp.mode === 'dungeon-golem') {
                            type = Math.random() > 0.5 ? 'hp' : 'def';
                        } else {
                            type = Math.random() > 0.5 ? 'atk' : 'crit';
                        }

                        // Valor Base
                        let val = 0;
                        if(rarity==='Comum') val = 5 + Math.floor(Math.random()*5);
                        if(rarity==='Raro') val = 10 + Math.floor(Math.random()*10);
                        if(rarity==='Epico') val = 25 + Math.floor(Math.random()*15);
                        if(rarity==='Lendario') val = 50 + Math.floor(Math.random()*25);
                        
                        // Crit √© % e deve ser menor
                        if(type === 'crit') val = Math.ceil(val / 2.5);

                        // Initial Substats Logic (New Rune)
                        let initialSubs = [];
                        let subCount = 0;
                        if(rarity==='Raro') subCount = 1;
                        if(rarity==='Epico') subCount = 2;
                        if(rarity==='Lendario') subCount = 3;
                        
                        const subTypes = ['hp', 'atk', 'def', 'crit'];
                        for(let i=0; i<subCount; i++) {
                             const sType = subTypes[Math.floor(Math.random() * subTypes.length)];
                             const sVal = Math.floor(Math.random() * 5) + 3; 
                             initialSubs.push({ type: sType, val: sVal });
                        }

                        const newRune = { id: runeIdCount++, rarity, type, val, lvl: 0, subs: initialSubs };
                        s.runes_inv.push(newRune);
                        
                        itemIcon = "üìñ"; itemQtd = "-"; 
                        if (b.farmRuns <= 1) el('end-mana').innerText = "+0"; 
                        rewardMsg = "CHEFE DERROTADO!";
                        runeDrop = `${rarity} Runa (${type.toUpperCase()} +${val})`;
                    }
                    Game.save();
                    
                    if (b.farmRuns > 1) {
                        b.farmRuns--;
                        el('farm-count').innerText = b.farmRuns;
                        const toast = document.createElement('div');
                        toast.style.cssText = `position:absolute; top:20%; left:50%; transform:translate(-50%, -50%); background:rgba(16, 185, 129, 0.9); color:white; padding:10px 20px; border-radius:10px; z-index:999; font-weight:bold; font-size:1.2rem; pointer-events:none; box-shadow: 0 0 10px #000; animation: fadeUp 1s forwards;`;
                        toast.innerHTML = `Vit√≥ria! Reiniciando... (${b.farmRuns})`;
                        el('battle').appendChild(toast);
                        if (!document.getElementById('anim-style')) {
                            const style = document.createElement('style');
                            style.id = 'anim-style';
                            style.innerHTML = `@keyframes fadeUp { 0% { opacity: 0; transform: translate(-50%, 0); } 20% { opacity: 1; transform: translate(-50%, -20px); } 80% { opacity: 1; transform: translate(-50%, -20px); } 100% { opacity: 0; transform: translate(-50%, -40px); } }`;
                            document.head.appendChild(style);
                        }
                        setTimeout(() => {
                            toast.remove();
                            Battle.start(b.farmRuns); 
                        }, 1000);
                        return; 
                    }

                } else { 
                    rewardMsg = "DERROTA"; itemIcon = "üíÄ"; itemQtd = "-"; el('end-mana').innerText = "+0"; 
                    b.farmRuns = 0; 
                }
                
                el('end-title').innerText = rewardMsg; el('end-title').style.color = w ? "var(--gold)" : "var(--danger)";
                el('end-item-icon').innerText = itemIcon; el('end-xp').innerText = itemQtd;
                el('end-gems').innerText = w ? `+${gemsAwarded}` : "+0";
                el('end-acc-xp').innerText = w ? `+${accXpGain}` : "+0";
                el('rune-drop-msg').innerText = runeDrop;

                UI.modal('m-end',1); UI.upd();
            }, 600);
        },
        close: () => { UI.modal('m-end',0); UI.nav('hub'); }
    };
</script>
</body>
</html>
