<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Guardi√µes: Legends Light</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Manrope:wght@400;600;800&family=Titan+One&display=swap');

        :root {
            --c-bg: #f3f4f6;
            --c-panel: rgba(255, 255, 255, 0.95);
            --c-primary: #3b82f6; 
            --c-accent: #8b5cf6; 
            --c-gold: #f59e0b; 
            --c-danger: #ef4444;
            --c-success: #10b981;
            --c-text: #1f2937; 
            --c-text-dim: #6b7280;
            --c-border: #e5e7eb;

            --s-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --dock-height: 80px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background: #eef2f6; font-family: 'Manrope', sans-serif; color: var(--c-text); 
            height: 100dvh; width: 100vw; display: flex; justify-content: center; overflow: hidden; 
        }

        #app { 
            width: 100%; max-width: 500px; height: 100%; position: relative; 
            background: #f9fafb; box-shadow: 0 0 50px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        
        /* BACKGROUND */
        #app::before {
            content:''; position:absolute; inset:0; 
            background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05), transparent 60%);
            z-index: 0; pointer-events: none;
        }

        /* TIPOGRAFIA */
        h1, h2, h3 { font-family: 'Cinzel', serif; text-transform: uppercase; letter-spacing: 0.5px; color: #111827; margin: 0; }
        .text-gold { color: var(--c-gold); }

        /* UI GERAL */
        .screen { 
            position: absolute; inset: 0; 
            display: none; flex-direction: column; z-index: 10; 
            padding-bottom: calc(var(--dock-height) + env(safe-area-inset-bottom)); 
            opacity: 0; transition: opacity 0.3s; background: var(--c-bg); 
            overflow: hidden;
        }
        .screen.active { display: flex; opacity: 1; z-index: 20; }
        
        /* Containers de Scroll */
        .scroll-y { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }

        .panel {
            background: var(--c-panel); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--c-border); border-radius: 20px; box-shadow: var(--s-shadow);
        }

        .btn {
            border: none; padding: 12px 16px; border-radius: 12px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; position: relative; overflow: hidden;
            color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: var(--c-primary); }
        .btn-gold { background: var(--c-gold); }
        .btn-purple { background: var(--c-accent); }
        .btn-red { background: var(--c-danger); }
        .btn-white { background: #fff; color: var(--c-text); border: 1px solid #ddd; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; font-size: 1.2rem; background: #fff; color: #333; border: 1px solid #ddd; box-shadow: var(--s-shadow); flex-shrink: 0; }

        /* HEADER & NAV */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
            z-index: 50; background: rgba(255,255,255,0.95); 
            border-bottom: 1px solid var(--c-border); 
            height: 70px; flex-shrink: 0;
        }
        .currency-tag { display: flex; align-items: center; gap: 6px; background: #fff; border: 1px solid var(--c-border); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .nav-dock { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            height: calc(var(--dock-height) + env(safe-area-inset-bottom));
            background: #fff; border-top: 1px solid var(--c-border); 
            display: flex; justify-content: space-around; align-items: flex-start; 
            padding-top: 10px; z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); 
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--c-text-dim); font-size: 0.6rem; font-weight: 700; width: 20%; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: var(--c-primary); }
        .nav-btn .icon { font-size: 1.4rem; transition: 0.2s; }
        .nav-btn.active { transform: translateY(-5px); color: var(--c-primary); }
        .nav-btn.summon .icon { font-size: 1.8rem; color: var(--c-gold); filter: drop-shadow(0 4px 4px rgba(245, 158, 11, 0.3)); }

        /* ELEMENTOS VISUAIS */
        .hero-slot { width: 60px; height: 60px; position: relative; background: #fff; border-radius: 12px; border: 2px solid #eee; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: var(--s-shadow); flex-shrink: 0; }
        .hero-slot.selected { border-color: var(--c-primary); transform: scale(1.05); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .hero-slot .lvl-badge { position: absolute; bottom: 0; right:0; background: #000; color:#fff; font-size:0.6rem; padding:1px 4px; border-top-left-radius:6px; font-weight:bold; }
        .hero-slot.legendary-glow { box-shadow: 0 0 10px var(--c-gold), inset 0 0 5px var(--c-gold); border-color: var(--c-gold); }
        .stars { display: flex; gap: 1px; justify-content: center; }
        .star { width: 8px; height: 8px; background: var(--c-gold); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .star.p { background: var(--c-accent); }
        
        /* SUPORTE PARA IMAGENS CUSTOMIZADAS */
        .hero-slot img, .custom-img, .visual img { width: 100%; height: 100%; object-fit: contain; }

        /* LOJA CARDS */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; padding: 10px; }
        .shop-card {
            background: #fff; border-radius: 16px; padding: 15px; border: 1px solid #eee;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); text-align: center;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .shop-card:active { transform: scale(0.98); border-color: var(--c-primary); }
        .shop-icon { font-size: 2.2rem; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.1)); }
        .shop-name { font-weight: 800; font-size: 0.8rem; color: var(--c-text); }
        .shop-price { font-size: 0.75rem; color: #666; background: #f3f4f6; padding: 3px 8px; border-radius: 10px; font-weight: bold; width: 100%; }

        /* MISSION CARDS */
        .mission-row { background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mission-info { display: flex; flex-direction: column; gap: 2px; }
        .mission-desc { font-weight: 700; font-size: 0.9rem; color: #333; }
        .mission-prog { font-size: 0.75rem; color: #666; }
        .mission-reward { font-size: 0.75rem; color: var(--c-gold); font-weight: bold; }
        .btn-claim { background: var(--c-success); padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; color: #fff; font-weight: 800; border: none; cursor: pointer; }
        .btn-claim:disabled { background: #ddd; color: #999; cursor: default; }

        /* BATTLE TOGGLES */
        .toggle-btn {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(0,0,0,0.4); color: #fff; border: 2px solid rgba(255,255,255,0.2);
            font-weight: 800; font-size: 0.7rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); transition: 0.2s;
        }
        .toggle-btn.active { background: var(--c-success); border-color: #fff; box-shadow: 0 0 15px var(--c-success); transform: scale(1.1); }
        
        /* RUNE BAG & SLOTS */
        .rune-bag-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; padding: 15px; }
        .rune-slot-bag {
            width: 60px; height: 60px; background: #222; border-radius: 8px;
            position: relative; cursor: pointer; border: 2px solid #444;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 10px #000;
        }
        .rune-slot-bag.filled { background: #333; }
        .rune-slot-bag.rare { border-color: var(--c-primary); }
        .rune-slot-bag.epic { border-color: var(--c-accent); }
        .rune-slot-bag.legend { border-color: var(--c-gold); box-shadow: 0 0 5px var(--c-gold); }
        .rune-lvl-tag { position: absolute; top: 2px; right: 2px; font-size: 0.6rem; background: #000; color: #fff; padding: 0 3px; border-radius: 4px; font-weight: bold; }
        .rune-set-icon { position: absolute; bottom: 2px; left: 2px; font-size: 0.6rem; opacity: 0.7; }
        .rune-up-view { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .rune-preview-large { width: 100px; height: 100px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 3px solid #666; font-size: 3rem; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .rune-preview-large.legend { border-color: var(--c-gold); box-shadow: 0 0 15px var(--c-gold); }
        .stats-comparison { width: 100%; background: #f3f4f6; border-radius: 12px; padding: 15px; font-size: 0.9rem; text-align: left; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .new-val { color: var(--c-success); font-weight: 800; }

        /* MONSTER DETAIL STYLES */
        #mon_detail { background: #f9fafb; z-index: 50; padding-bottom: 85px; }
        .mon-detail-header { background: #fff; padding: 30px 20px; text-align: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); position: relative; overflow: hidden; flex-shrink: 0; }
        .big-model { font-size: 6rem; position: relative; z-index: 2; margin-bottom: 10px; filter: drop-shadow(0 15px 25px rgba(0,0,0,0.15)); animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .mon-info-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); padding: 6px 14px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-weight: 700; font-size: 0.85rem; color: #444; margin-top: 10px; position: relative; z-index: 2; border: 1px solid rgba(0,0,0,0.05); }
        .mon-info-badge.max-lvl { color: #f59e0b; border-color: #f59e0b; background: #fffbeb; }

        .tab-bar { display: flex; justify-content: center; gap: 10px; margin: 20px 0 10px; flex-shrink: 0; position: relative; z-index: 2; }
        .tab-btn { padding: 8px 20px; border-radius: 25px; background: #fff; color: #6b7280; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.85rem; border: 1px solid #e5e7eb; }
        .tab-btn.active { background: var(--c-primary); color: #fff; border-color: var(--c-primary); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .detail-content { flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: none; }
        .detail-content.active { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .stat-box { background: #fff; padding: 15px; border-radius: 16px; border: 1px solid #f0f0f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; flex-direction: column; gap: 5px; }
        .stat-val-group { display: flex; align-items: baseline; gap: 5px; }
        .stat-value { font-size: 1.2rem; font-weight: 800; color: #1f2937; }
        .stat-bonus { font-size: 0.8rem; color: var(--c-success); font-weight: 700; }
        .rune-layout-fancy { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        .rune-slot-fancy { width: 80px; height: 90px; background: #fff; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f9fafb; position: relative; box-shadow: inset 0 0 0 2px #e5e7eb; cursor: pointer; transition: 0.2s; }
        .rune-slot-fancy.filled { background: #fff; box-shadow: inset 0 0 0 3px var(--rune-color, #ccc); }
        .skill-list-container { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .skill-card-detail { background: #fff; border-radius: 16px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; display: flex; gap: 15px; align-items: center; }
        .action-dock { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: space-between; position: absolute; bottom: 0; width: 100%; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); padding-bottom: max(15px, env(safe-area-inset-bottom)); }

        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .filter-btn { padding: 10px; border-radius: 12px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 700; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .filter-btn.active { background: var(--c-primary); color: #fff; border-color: var(--c-primary); }

        /* --- BATTLE (REALISTIC ARENA) --- */
        #battle { background: radial-gradient(circle at 50% 20%, #0f172a 0%, #000 100%); overflow: hidden; padding-bottom: 0; }
        .arena-floor { 
            position: absolute; bottom: -10%; left: -50%; right: -50%; height: 75%;
            background: 
                radial-gradient(ellipse at center, rgba(30, 41, 59, 1) 0%, rgba(15, 23, 42, 1) 60%, #000 100%),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 50px),
                repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 50px);
            transform: perspective(600px) rotateX(60deg); box-shadow: 0 -50px 100px #000 inset; border-top: 2px solid rgba(255,255,255,0.1); z-index: 0;
        }
        .clouds { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; background: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.4; }
        .battle-scene { flex: 1; position: relative; z-index: 5; display: flex; flex-direction: column; justify-content: center; perspective: 800px; padding-bottom: 160px; gap: 40px; }
        .team-row { display: flex; justify-content: center; gap: 10px; min-height: 100px; position: relative; z-index: 5; align-items: flex-end; }
        
        .team-row.enemy .b-unit:nth-child(2) { transform: translateY(-20px); z-index: 1; } 
        .team-row.enemy .b-unit:nth-child(1), .team-row.enemy .b-unit:nth-child(3) { transform: translateY(10px); z-index: 2; }
        .team-row.player .b-unit:nth-child(2) { transform: translateY(20px) scale(1.1); z-index: 10; } 
        .team-row.player .b-unit:nth-child(1), .team-row.player .b-unit:nth-child(3) { transform: translateY(-10px); z-index: 5; }

        .b-unit { width: 80px; height: 80px; position: relative; display: flex; align-items: flex-end; justify-content: center; cursor: pointer; transition: transform 0.3s; z-index: 5; }
        .b-unit .visual { font-size: 3.5rem; filter: drop-shadow(0 15px 8px rgba(0,0,0,0.6)); animation: idle 3s infinite ease-in-out; transition: 0.2s; transform-origin: bottom center; }
        @keyframes idle { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(0.96)} }
        .b-unit.boss { width: 120px; height: 120px; max-width: 120px; max-height: 120px; } .b-unit.boss .visual { font-size: 6rem; }
        .b-unit.dead { pointer-events: none; }
        .b-unit.dead .visual { animation: deathDissolve 1s forwards ease-out; }
        .b-unit.dead .hp-bar-w { opacity: 0; transition: 0.3s; }
        @keyframes deathDissolve { 0% { filter: grayscale(0) brightness(1); opacity: 1; } 100% { filter: grayscale(1) blur(20px); opacity: 0; transform: translateY(-50px) scale(1.5); visibility: hidden; } }

        .b-unit.active-turn { z-index: 100; }
        .b-unit.active-turn .visual { transform: scale(1.2); filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
        .b-unit.actor { z-index: 100 !important; }
        .player .b-unit.actor .visual { animation: lungeP 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .enemy .b-unit.actor .visual { animation: lungeE 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes lungeP { 0%{transform:translateY(0)} 40%{transform:translateY(-80px) scale(1.3)} 100%{transform:translateY(0) scale(1)} }
        @keyframes lungeE { 0%{transform:translateY(0)} 40%{transform:translateY(80px) scale(1.3)} 100%{transform:translateY(0) scale(1)} }
        .b-unit.hit .visual { animation: hit 0.4s; filter: brightness(2) sepia(1) hue-rotate(-50deg); }
        @keyframes hit { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)} 40%{transform:translateX(10px)} 60%{transform:translateX(-10px)} 80%{transform:translateX(10px)} }

        .hp-bar-w { position: absolute; top: -20px; width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 5px #000; }
        .hp-fill { height: 100%; background: #22c55e; width: 100%; transition: width 0.3s; }
        .enemy .hp-fill { background: #ef4444; }
        .target-marker { position: absolute; top: -50px; color: #ef4444; font-size: 2rem; font-weight: bold; animation: bounce 0.5s infinite; text-shadow: 0 0 10px red; z-index: 100; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        .battle-hud { position: absolute; bottom: 0; width: 100%; height: 150px; background: linear-gradient(to top, #1e293b, #0f172a); border-top: 4px solid #334155; border-top-left-radius: 25px; border-top-right-radius: 25px; display: flex; justify-content: center; align-items: center; gap: 20px; transform: translateY(100%); transition: 0.3s; z-index: 20; padding-bottom: 20px; box-shadow: 0 -10px 50px #000; }
        .battle-hud.active { transform: translateY(0); }
        .skill-btn-3d { width: 70px; height: 70px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(145deg, #334155, #1e293b); box-shadow: 5px 5px 10px #0f172a, -5px -5px 10px #475569; color: #fff; cursor: pointer; position: relative; border: 1px solid #475569; }
        .skill-btn-3d:active { box-shadow: inset 5px 5px 10px #0f172a, inset -5px -5px 10px #475569; transform: scale(0.95); }
        .skill-btn-3d.cd { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .dk-badge { position: absolute; bottom: -10px; font-size: 0.6rem; background: #000; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; }
        .dmg-popup { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); font-family: 'Titan One', cursive; font-size: 2.5rem; color: #fbbf24; text-shadow: 2px 2px 0 #000; z-index: 100; pointer-events: none; animation: popUp 0.8s forwards; white-space: nowrap; -webkit-text-stroke: 1px #000; }
        @keyframes popUp { 0%{opacity:0; transform:translate(-50%,0)} 20%{opacity:1; transform:translate(-50%,-50px) scale(1.5)} 100%{opacity:0; transform:translate(-50%,-80px)} }

        /* FLUSH LEGENDARY */
        .flash-legendary { position: fixed; inset: 0; background: #fff; z-index: 400; animation: flashGold 0.8s ease-out forwards; pointer-events: none; opacity: 0; display: none; }
        .flash-legendary.active { display: block; }
        @keyframes flashGold { 0%{opacity:0; background:#fff} 10%{opacity:1; background:#fff} 30%{background:#fbbf24} 100%{opacity:0} }

        /* GRIDS */
        #inv-grid, #prep-grid, #rune-bag-grid, #evo-grid, #skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 10px; padding: 15px; align-content: flex-start; }
        #shop-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; padding: 10px; }

        /* MODALS */
        .modal { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .modal-content { width: 90%; max-width: 350px; background: #fff; border-radius: 20px; padding: 25px; text-align: center; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        /* Prep Buttons Centered */
        .prep-actions { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 15px; background: #fff; border-bottom: 1px solid #eee; }

    </style>
</head>
<body>

<div id="app">
    <div id="flash-fx" class="flash-legendary"></div>
    
    <!-- LOGIN -->
    <div id="login" class="screen active" style="align-items:center; justify-content:center">
        <div class="modal-content">
            <h1 class="text-gold" style="font-size:2rem; margin-bottom:5px">GUARDI√ïES</h1>
            <h3 style="color:var(--c-primary); font-size:0.9rem; margin-bottom:30px; letter-spacing:3px">LEGENDS</h3>
            <input type="text" id="inp-user" style="width:100%; padding:12px; border:2px solid #eee; border-radius:10px; text-align:center; outline:none" placeholder="Nome do Jogador" maxlength="12">
            <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="Game.login()">JOGAR</button>
        </div>
    </div>

    <!-- HUB -->
    <div id="hub" class="screen">
        <div class="top-bar">
            <div style="display:flex; gap:10px; align-items:center">
                <div style="width:40px;height:40px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem">üßô‚Äç‚ôÇÔ∏è</div>
                <div>
                    <div style="font-weight:800; font-size:0.9rem" id="p-name">Player</div>
                    <div style="font-size:0.7rem; color:#666">Lv. <span id="p-lvl">1</span></div>
                </div>
            </div>
            <div style="text-align:right">
                <div class="currency-tag" style="color:var(--c-primary)">üí† <span id="h-mana">0</span></div>
                <div class="currency-tag" style="margin-top:4px; color:var(--c-gold)">üíé <span id="h-gems">0</span></div>
            </div>
        </div>

        <div class="scroll-y" style="padding:20px; display:flex; flex-direction:column; gap:15px">
            <button class="btn btn-gold" onclick="UI.modal('m-missions',1)" style="width:100%">üìú Miss√µes Di√°rias</button>
            <div class="panel" style="padding:20px; display:flex; align-items:center; gap:20px; cursor:pointer; border-left:5px solid var(--c-primary)" onclick="UI.nav('expl')">
                <div style="font-size:2rem">üó∫Ô∏è</div><div><h3>Aventura</h3><small style="color:#666">Hist√≥ria</small></div>
            </div>
            <div class="panel" style="padding:20px; display:flex; align-items:center; gap:20px; cursor:pointer; border-left:5px solid var(--c-danger)" onclick="UI.nav('dung')">
                <div style="font-size:2rem">üè∞</div><div><h3>Masmorra</h3><small style="color:#666">Runas</small></div>
            </div>
            <div class="panel" style="padding:20px; display:flex; align-items:center; gap:20px; cursor:pointer; border-left:5px solid #8b5cf6" onclick="UI.nav('tower')">
                <div style="font-size:2rem">üóº</div><div><h3>Torre</h3><small style="color:#666">Ascens√£o</small></div>
            </div>
            <div class="panel" style="padding:20px; display:flex; align-items:center; gap:20px; cursor:pointer; border-left:5px solid var(--c-accent)" onclick="Core.openRuneBag()">
                <div style="font-size:2rem">üéí</div><div><h3>Invent√°rio</h3><small style="color:#666">Gerir</small></div>
            </div>
            <div class="panel" style="padding:15px; text-align:center; font-size:0.8rem; color:#666" id="boost-status">Booster Inativo</div>
        </div>

        <div class="nav-dock">
            <div class="nav-btn active" onclick="UI.nav('hub')"><div class="icon">üè†</div>In√≠cio</div>
            <div class="nav-btn" onclick="Core.openInv()"><div class="icon">üê∫</div>Box</div>
            <div class="nav-btn summon" onclick="UI.modal('m-gacha',1)"><div class="icon">‚ú®</div></div>
            <div class="nav-btn" onclick="UI.modal('m-shop',1)"><div class="icon">üõí</div>Loja</div>
            <div class="nav-btn" onclick="Game.logout()"><div class="icon">üö™</div>Sair</div>
        </div>
    </div>

    <!-- SCREENS -->
    <div id="expl" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Mundos</h3><div style="width:30px"></div></div>
        <div class="scroll-y">
            <div id="expl-regions" style="padding:20px; display:flex; flex-direction:column; gap:10px"></div>
            <div id="expl-stages-list" style="padding:20px; display:none; flex-direction:column; gap:10px">
                <button class="btn btn-white" onclick="Core.backToExplRegions()">Voltar</button>
                <div id="expl-list-container" style="display:flex; flex-direction:column; gap:10px; margin-top:10px"></div>
            </div>
        </div>
    </div>

    <div id="dung" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Masmorras</h3><div style="width:30px"></div></div>
        <div class="scroll-y" style="padding:20px">
            <div id="dung-select">
                <div class="panel" style="padding:20px; margin-bottom:10px; display:flex; align-items:center; gap:15px; border-left:4px solid #84cc16" onclick="Core.selectDung('golem')"><div style="font-size:2rem">üóø</div><div><h3>Gigante</h3><small>Vida/Defesa</small></div></div>
                <div class="panel" style="padding:20px; display:flex; align-items:center; gap:15px; border-left:4px solid #ef4444" onclick="Core.selectDung('dragon')"><div style="font-size:2rem">üêâ</div><div><h3>Drag√£o</h3><small>Atk/Crit</small></div></div>
            </div>
            <div id="dung-floors" style="display:none; flex-direction:column; gap:10px">
                <button class="btn btn-white" onclick="Core.backToDungSelect()">Voltar</button>
                <div id="dung-list-container" style="display:flex; flex-direction:column; gap:10px; margin-top:10px"></div>
            </div>
        </div>
    </div>

    <div id="tower" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Torre</h3><div style="width:30px"></div></div>
        <div class="scroll-y" style="padding:20px">
             <div id="tower-list-container" style="display:flex; flex-direction:column; gap:10px"></div>
        </div>
    </div>

    <div id="inv" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Monstros</h3><button class="btn-white" style="font-size:0.8rem; padding:5px 10px; border-radius:15px" onclick="UI.modal('m-filter',1)">üå™Ô∏è Filtro</button></div>
        <div id="inv-grid" class="scroll-y"></div>
    </div>

    <div id="mon_detail" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="Core.backToInv()">‚ùÆ</button><h3>Detalhes</h3><div style="width:30px"></div></div>
        <div class="scroll-y" style="padding:0 20px 100px 20px">
            <div class="mon-detail-header">
                <div id="md-vis" class="big-model">üê≤</div>
                <h2 id="md-name" style="margin-bottom:5px">Dragon</h2>
                <div id="md-stars" class="stars" style="position:relative; margin-bottom:5px; width:auto; justify-content:center"></div>
                <div class="mon-info-badge" id="md-badge">Nv. <span id="md-lvl">1</span></div>
            </div>
            <div class="tab-bar">
                <div id="tab-stat" class="tab-btn active" onclick="UI.tab('stat')">Status</div>
                <div id="tab-rune" class="tab-btn" onclick="UI.tab('rune')">Runas</div>
                <div id="tab-skill" class="tab-btn" onclick="UI.tab('skill')">Skills</div>
            </div>
            <div id="cont-stat" class="detail-content active">
                <div class="stat-grid">
                    <div class="stat-box"><span class="stat-label">HP</span><div class="stat-val-group"><span id="st-hp" class="stat-value">1000</span> <span id="bn-hp" class="stat-bonus">(+0)</span></div></div>
                    <div class="stat-box"><span class="stat-label">ATK</span><div class="stat-val-group"><span id="st-atk" class="stat-value">100</span> <span id="bn-atk" class="stat-bonus">(+0)</span></div></div>
                    <div class="stat-box"><span class="stat-label">DEF</span><div class="stat-val-group"><span id="st-def" class="stat-value">50</span> <span id="bn-def" class="stat-bonus">(+0)</span></div></div>
                    <div class="stat-box"><span class="stat-label">CRIT</span><div class="stat-val-group"><span id="st-crit" class="stat-value">15</span>%</div></div>
                </div>
            </div>
            <div id="cont-rune" class="detail-content">
                <div class="rune-layout-fancy">
                    <div id="rs-0" onclick="Core.openRuneSelect(0)" class="rune-slot-fancy"></div>
                    <div id="rs-1" onclick="Core.openRuneSelect(1)" class="rune-slot-fancy"></div>
                    <div id="rs-2" onclick="Core.openRuneSelect(2)" class="rune-slot-fancy"></div>
                    <div id="rs-3" onclick="Core.openRuneSelect(3)" class="rune-slot-fancy"></div>
                </div>
                <p style="text-align:center; font-size:0.75rem; color:#9ca3af; margin-top:20px">Toque no slot para gerenciar</p>
            </div>
            <div id="cont-skill" class="detail-content">
                <div id="skill-desc-list" class="skill-list-container"></div>
            </div>
        </div>
        <div class="action-dock">
            <button class="btn btn-primary" style="flex:1" onclick="Core.pup()">Level Up</button>
            <button class="btn btn-purple" style="flex:1" onclick="Core.openEvo()">Evoluir</button>
            <button class="btn btn-gold" style="flex:1" onclick="Core.openSkill()">Skill</button>
        </div>
    </div>

    <div id="prep" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Sele√ß√£o</h3><div style="width:30px"></div></div>
        <div style="padding:20px; display:flex; justify-content:center; gap:10px; background:#fff">
            <div id="s0" class="hero-slot" style="width:70px; height:70px" onclick="Prep.rem(0)"></div>
            <div id="s1" class="hero-slot" style="width:70px; height:70px" onclick="Prep.rem(1)"></div>
            <div id="s2" class="hero-slot" style="width:70px; height:70px" onclick="Prep.rem(2)"></div>
        </div>
        
        <!-- BOTOES CENTRALIZADOS -->
        <div class="prep-actions">
            <button id="btn-fight" class="btn btn-primary" onclick="Battle.start(0)" style="width:200px; height:50px; font-size:1rem; box-shadow:0 5px 15px rgba(59,130,246,0.4)">‚öîÔ∏è LUTAR</button>
            <div id="btn-farm" style="display:none; width:100%; text-align:center">
                <button class="btn btn-gold" onclick="Battle.start(5)" style="width:200px; height:40px; font-size:0.8rem">‚ö° AUTO x5</button>
            </div>
        </div>

        <div id="prep-grid" class="scroll-y"></div>
    </div>

    <div id="rune_bag" class="screen">
        <div class="top-bar"><button class="btn-icon" style="border:none;background:none;font-size:1.5rem" onclick="UI.nav('hub')">‚ùÆ</button><h3>Runas</h3><div style="width:30px"></div></div>
        <div id="rune-bag-grid" class="rune-bag-container scroll-y"></div>
    </div>

    <!-- BATTLE -->
    <div id="battle" class="screen">
        <div class="arena-floor"></div>
        <div class="clouds"></div>
        
        <div style="position:absolute; top:20px; right:20px; z-index:50; display:flex; gap:10px">
            <button id="btn-spd" class="toggle-btn" onclick="Battle.spd()">x1</button>
            <button id="btn-auto" class="toggle-btn" onclick="Battle.toggleAuto()">A</button>
        </div>
        <div id="farm-ui" style="position:absolute; top:20px; left:20px; color:#fff; font-weight:bold; text-shadow:0 1px 2px #000; display:none; z-index:50">Auto: <span id="farm-count">0</span></div>

        <div class="battle-scene" id="stg">
            <div class="team-row enemy" id="r-ene"></div>
            <div class="team-row player" id="r-pla"></div>
        </div>

        <div id="btl-ui" class="battle-hud">
            <div style="position:absolute; top:-40px; color:#fff; text-shadow:0 1px 3px #000; font-weight:800" id="act-msg"></div>
            <div id="skill-list" style="display:flex; gap:15px"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="m-confirm" class="modal"><div class="modal-content"><h3>Confirmar</h3><p id="confirm-msg"></p><div style="display:flex;gap:10px"><button class="btn btn-white" style="flex:1" onclick="UI.modal('m-confirm',0)">N√£o</button><button class="btn btn-primary" style="flex:1" onclick="Core.execConfirm()">Sim</button></div></div></div>
    
    <!-- MISSIONS MODAL -->
    <div id="m-missions" class="modal">
        <div class="modal-content" style="max-width:400px">
            <h3>Miss√µes Di√°rias</h3>
            <div id="mission-list" style="flex:1; overflow-y:auto; width:100%; text-align:left;"></div>
            <button class="btn btn-white" onclick="UI.modal('m-missions',0)">Fechar</button>
        </div>
    </div>

    <!-- FILTER MODAL -->
    <div id="m-filter" class="modal">
        <div class="modal-content">
            <h3>Filtrar Elemento</h3>
            <div class="filter-grid">
                <div class="filter-btn active" onclick="Core.setInvFilter('all', this)">Todos</div>
                <div class="filter-btn" onclick="Core.setInvFilter('Fogo', this)">üî• Fogo</div>
                <div class="filter-btn" onclick="Core.setInvFilter('√Ågua', this)">üíß √Ågua</div>
                <div class="filter-btn" onclick="Core.setInvFilter('Vento', this)">üçÉ Vento</div>
                <div class="filter-btn" onclick="Core.setInvFilter('Terra', this)">‚õ∞Ô∏è Terra</div>
                <div class="filter-btn" onclick="Core.setInvFilter('Luz', this)">‚òÄÔ∏è Luz</div>
                <div class="filter-btn" onclick="Core.setInvFilter('Trevas', this)">üåô Trevas</div>
            </div>
            <button class="btn btn-white" style="margin-top:10px" onclick="UI.modal('m-filter',0)">Fechar</button>
        </div>
    </div>

    <!-- LOJA -->
    <div id="m-shop" class="modal"><div class="modal-content" style="width:95%; max-width:400px">
        <h3>Mercado</h3>
        <div id="shop-container" class="shop-grid"></div>
        <button class="btn btn-white" onclick="UI.modal('m-shop',0)">Sair</button>
    </div></div>
    
    <!-- GACHA -->
    <div id="m-gacha" class="modal"><div class="modal-content" style="background:#1a1a2e; color:#fff; border:2px solid #4c1d95">
        <div id="portal-visual"><div style="font-size:3rem; z-index:2">üåÄ</div></div>
        <h3 style="color:#a78bfa">Portal Astral</h3>
        <div style="display:grid; grid-template-columns:1fr; gap:10px; width:100%">
            <button class="btn btn-primary" onclick="Core.spin('common',1)">Comum x1 (1üé´)</button>
            <button class="btn btn-gold" onclick="Core.spin('rare',1)">Raro x1 (1üéüÔ∏è)</button>
            <button id="btn-g-10" class="btn btn-gold" onclick="Core.spin('rare',10)" style="display:none">Raro x10 (10üéüÔ∏è)</button>
        </div>
        <div style="margin-top:10px; font-size:0.8rem; color:#888">üé´ <span id="g-tix">0</span> | üéüÔ∏è <span id="g-rare">0</span></div>
        <button class="btn btn-white" style="background:rgba(255,255,255,0.1); color:#fff; border:none; margin-top:10px" onclick="UI.modal('m-gacha',0)">Sair</button>
    </div></div>
    <div id="m-gacha-results" class="modal"><div class="modal-content"><h3>Invocado!</h3><div id="gacha-result-grid" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px; padding:10px"></div><button class="btn btn-primary" onclick="UI.modal('m-gacha-results',0)">Confirmar</button></div></div>

    <div id="m-end" class="modal"><div class="modal-content"><h1 id="end-title">FIM</h1><div style="display:flex; justify-content:space-around; font-size:1.2rem; font-weight:bold"><div>üí† <span id="end-mana">0</span></div><div>üíé <span id="end-gems">0</span></div></div><div id="rune-drop-msg" style="color:var(--c-accent)"></div><button class="btn btn-primary" onclick="Battle.close()">Continuar</button></div></div>

    <!-- RUNE SELECT -->
    <div id="m-rune" class="modal"><div class="modal-content" style="height:70vh"><h3>Runas</h3><div id="rune-list" class="scroll-y" style="display:flex; flex-direction:column; gap:10px"></div><button class="btn btn-white" onclick="UI.modal('m-rune',0)">Fechar</button></div></div>
    
    <!-- RUNE POWER-UP -->
    <div id="m-rune-up" class="modal">
        <div class="modal-content" style="max-width:350px">
            <h3>Melhorar Runa</h3>
            <div class="rune-up-view">
                <div class="rune-preview-large" id="up-rune-visual"></div>
                <div style="text-align:center">
                    <div id="up-rune-type" style="font-weight:800; color:var(--c-primary); text-transform:uppercase"></div>
                    <div id="up-rune-lvl" style="font-size:0.8rem; background:#333; color:#fff; border-radius:10px; padding:2px 8px; display:inline-block; margin-top:5px"></div>
                </div>
            </div>
            <div class="stats-comparison" id="up-stats-comp"></div>
            <div style="margin:5px 0; font-size:0.9rem">Chance: <span id="up-chance" style="font-weight:bold"></span></div>
            <div style="display:flex; gap:10px; width:100%">
                <button class="btn btn-white" style="flex:1" onclick="UI.modal('m-rune-up',0)">Voltar</button>
                <button id="btn-do-up" class="btn btn-gold" style="flex:1" onclick="Core.doUpgrade()">Upar (<span id="up-cost">0</span>)</button>
            </div>
        </div>
    </div>

    <div id="m-evo" class="modal"><div class="modal-content"><h3>Evolu√ß√£o</h3><p>Use <span id="evo-req-c">0</span> monstros <span id="evo-req-s">0</span>‚òÖ</p><div id="evo-slots" style="display:flex; justify-content:center; gap:5px"></div><div id="evo-grid" class="scroll-y" style="height:200px; border:1px solid #eee; border-radius:10px"></div><button id="btn-do-evo" class="btn btn-purple" onclick="Core.doEvolution()" disabled>Evoluir</button><button class="btn btn-white" onclick="UI.modal('m-evo',0)">Fechar</button></div></div>
    
    <div id="m-skill" class="modal"><div class="modal-content"><h3>Skill Up</h3><button class="btn btn-gold" onclick="Core.useGrimoire()">Usar Grim√≥rio (<span id="sk-grim">0</span>)</button><p>Ou Sacrifique C√≥pia:</p><div id="skill-slots" style="display:flex; justify-content:center"></div><div id="skill-grid" class="scroll-y" style="height:150px; border:1px solid #eee; border-radius:10px"></div><button id="btn-do-skill" class="btn btn-primary" onclick="Core.doSkill()" disabled>Sacrificar</button><button class="btn btn-white" onclick="UI.modal('m-skill',0)">Fechar</button></div></div>

</div>

<script>
    /*
    ================================================================================
    >>> GUIA PARA ADICIONAR UM NOVO PERSONAGEM MANUALMENTE <<<
    
    1. Encontre a vari√°vel "const DB = [...]" abaixo.
    2. Adicione um novo objeto na lista seguindo o modelo:

       {
           id: 999,                   // ID √∫nico (use um n√∫mero que n√£o exista na lista)
           nat: 5,                    // Estrelas (1 a 5)
           n: 'Nome do Heroi',        // Nome que aparecer√° no jogo
           type: 'Fogo',              // Elemento: '√Ågua', 'Fogo', 'Vento', 'Terra', 'Luz', 'Trevas'
           img: '',                   // Deixe vazio '' para usar o emoji, ou coloque a URL da imagem (ex: 'https://site.com/imagem.png')
           visual: 'ü§†',              // Emoji (usado se a imagem estiver vazia ou falhar)
           s: [                       // Habilidades (Skills)
               {n:'Ataque 1', m:1, cd:0, ty:'atk'},     // ty: 'atk' (dano), 'aoe' (area), 'heal' (cura)
               {n:'Ataque 2', m:1.5, cd:3, ty:'aoe'}    // m: Multiplicador de dano, cd: Cooldown (Turnos)
           ],
           hp: 100, atk: 50           // Status Base (Vida e Ataque)
       },

    3. Salve o arquivo. O novo personagem aparecer√° no Gacha ou nas batalhas.
    ================================================================================
    */
    const MAX_LVL = {1:10, 2:20, 3:30, 4:40, 5:50, 6:50};
    const EXPL_REGIONS = [ { id: 1, name: "Floresta", icon: "üå≤", color: "#10b981" }, { id: 2, name: "Vulc√£o", icon: "üåã", color: "#ef4444" }, { id: 3, name: "Ru√≠nas", icon: "üèõÔ∏è", color: "#fbbf24" }, { id: 4, name: "Pico", icon: "‚ö°", color: "#a855f7" } ];
    const SHOP_DB = [
        {id:'pot',name:'Po√ß√£o XP',cost:100,currency:'mana',icon:'üß™'},
        {id:'tix',name:'Ticket',cost:1000,currency:'mana',icon:'üé´'},
        {id:'rare',name:'Ticket Raro',cost:100,currency:'gems',icon:'üéüÔ∏è'},
        {id:'grimoire',name:'Grim√≥rio',cost:500,currency:'gems',icon:'üìö'},
        {id:'xpboost',name:'Booster (7m)',cost:50,currency:'gems',icon:'üöÄ'}
    ];
    // Simple missions db
    const MISSIONS_DB = [
        {id:'bat_3', desc:'Vencer 3 Batalhas', target:3, r:{mana:2000, gems:0}, type:'win'},
        {id:'bat_10', desc:'Vencer 10 Batalhas', target:10, r:{mana:0, gems:20}, type:'win'},
        {id:'sum_1', desc:'Invocar 1 Monstro', target:1, r:{mana:3000, gems:0}, type:'sum'},
        {id:'pup_1', desc:'Upar N√≠vel', target:1, r:{mana:2000, gems:0}, type:'pup'},
        {id:'rup_3', desc:'Upar Runa 3x', target:3, r:{mana:3000, gems:0}, type:'rup'},
        {id:'dun_3', desc:'Vencer 3 Masmorras', target:3, r:{mana:0, gems:30}, type:'dun_win'},
        {id:'login', desc:'Login Di√°rio', target:1, r:{mana:5000, gems:10}, type:'login'}
    ];

    const DB = [
        {id:101,nat:1,n:'Slime',type:'√Ågua',img:'',visual:'üíß',s:[{n:'Hit',m:1,cd:0,ty:'atk'}],hp:50,atk:10},
        {id:102,nat:1,n:'Wisp',type:'Fogo',img:'',visual:'üî•',s:[{n:'Burn',m:1,cd:0,ty:'atk'}],hp:45,atk:12},
        {id:201,nat:2,n:'Goblin',type:'Terra',img:'',visual:'üë∫',s:[{n:'Hit',m:1,cd:0,ty:'atk'},{n:'Smash',m:1.5,cd:2,ty:'atk'}],hp:80,atk:18},
        {id:301,nat:3,n:'Golem',type:'Terra',img:'',visual:'üóø',s:[{n:'Hit',m:1,cd:0,ty:'atk'},{n:'Rock',m:1.3,cd:2,ty:'atk'},{n:'Quake',m:2,cd:4,ty:'aoe'}],hp:120,atk:20},
        {id:304,nat:3,n:'Fairy',type:'Luz',img:'',visual:'üßö',s:[{n:'Beam',m:1,cd:0,ty:'atk'},{n:'Heal',m:2.5,cd:3,ty:'heal'}],hp:90,atk:15},
        {id:401,nat:4,n:'Valk',type:'Vento',img:'',visual:'ü¶Ö',s:[{n:'Cut',m:1,cd:0,ty:'atk'},{n:'Storm',m:1.5,cd:3,ty:'aoe'}],hp:150,atk:25},
        {id:502,nat:5,n:'Dragon',type:'√Ågua',img:'',visual:'üêâ',s:[{n:'Bite',m:1.2,cd:0,ty:'atk'},{n:'Tsunami',m:1.8,cd:4,ty:'aoe'}],hp:200,atk:30},
        
        // BOSSES FIXOS E FORTES (APENAS PARA MASMORRA)
        {id:901,nat:6,n:'Golem Ancestral',type:'Terra',img:'',visual:'üóø',s:[{n:'Esmagar',m:1.5,cd:0,ty:'atk'},{n:'Terremoto',m:2.5,cd:4,ty:'aoe'}],hp:5000,atk:100},
        {id:902,nat:6,n:'Drag√£o do Caos',type:'Fogo',img:'',visual:'üê≤',s:[{n:'Baforada',m:1.5,cd:0,ty:'atk'},{n:'Apocalipse',m:3.0,cd:5,ty:'aoe'}],hp:4000,atk:150}
    ];
    
    // Lista BOSS_DB para garantir que s√≥ spawnem nas masmorras
    const BOSS_DB = {
        golem: {id:901,nat:6,n:'Golem Ancestral',type:'Terra',img:'',visual:'üóø',s:[{n:'Esmagar',m:1.5,cd:0,ty:'atk'},{n:'Terremoto',m:2.5,cd:4,ty:'aoe'}],hp:5000,atk:100},
        dragon: {id:902,nat:6,n:'Drag√£o do Caos',type:'Fogo',img:'',visual:'üê≤',s:[{n:'Baforada',m:1.5,cd:0,ty:'atk'},{n:'Apocalipse',m:3.0,cd:5,ty:'aoe'}],hp:4000,atk:150}
    };

    const DEFAULT_STATE = { 
        mana:2000, gems:50, pot:5, tix:0, rare_tix:5, grimoires:0, xp:0, max_xp:100, p_lvl:1, maxStage:1, maxTower: 1, cleared:[], runes_inv:[], roster:[], xp_boost_end_time: 0, first_summon_done: false,
        daily_missions: { last_reset: 0, progress: {}, claimed: [] }
    };
    let s = {}, tmp = { prep:[], selInv:null, mode:'story', lvl:1, selRuneSlot:null, dungType:null, upRune:null, evoFodder:[], skillFodder:[], invFilter: 'all' };
    let b = { p:[], e:[], t:'p', idx:0, spd:1, auto:false, farmRuns:0, skillPending:null, target:null };
    let uidCount=2, runeIdCount=1, currentUser=null, pendingAction=null;

    const el = id => document.getElementById(id);

    const Game = {
        login: () => {
            const u = el('inp-user').value.trim(); if(!u) return;
            currentUser = u;
            const sav = localStorage.getItem(`gl_fix_${u}`);
            s = sav ? JSON.parse(sav) : JSON.parse(JSON.stringify(DEFAULT_STATE));
            if(!s.runes_inv) s.runes_inv=[];
            if(typeof s.xp_boost_end_time === 'undefined') s.xp_boost_end_time = 0;
            if(!s.daily_missions) s.daily_missions = { last_reset: 0, progress: {}, claimed: [] };
            if(!s.maxTower) s.maxTower = 1;

            // Check Daily Reset
            const now = new Date();
            const lastDate = new Date(s.daily_missions.last_reset);
            const isDifferentDay = now.getDate() !== lastDate.getDate() || now.getMonth() !== lastDate.getMonth();
            
            if (isDifferentDay) {
                s.daily_missions = { last_reset: Date.now(), progress: {}, claimed: [] };
            }

            // Auto Login Mission
            Core.updateMission('login', 1);
            
            // Fix Roster if corrupted
            if(!Array.isArray(s.roster)) s.roster = [];
            
            uidCount = s.roster.reduce((m,r)=>Math.max(m,r.uid),0)+1;
            runeIdCount = Math.max((s.runes_inv.reduce((m,r)=>Math.max(m,r.id),0)),100)+1;
            el('p-name').innerText=u; UI.upd(); UI.nav('hub');
            
            setInterval(() => {
                const n = Date.now();
                if (s.xp_boost_end_time > n) {
                    const min = Math.ceil((s.xp_boost_end_time - n) / 60000);
                    el('boost-status').innerText = `XP Boost: ${min}m`;
                    el('boost-status').style.color = '#10b981';
                } else {
                    el('boost-status').innerText = `XP Boost Inativo`;
                    el('boost-status').style.color = '#6b7280';
                }
            }, 1000);
        },
        save: () => { if(currentUser) localStorage.setItem(`gl_fix_${currentUser}`, JSON.stringify(s)); },
        logout: () => { currentUser=null; document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); el('login').classList.add('active'); }
    };

    const UI = {
        nav: scn => { document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); el(scn).classList.add('active'); UI.upd(); if(scn==='expl') Core.renExpl(); if(scn==='dung') Core.renDung(); if(scn==='tower') Core.renTower(); },
        modal: (id,o) => { 
            el(id).className = o ? 'modal open' : 'modal'; 
            if(o && id==='m-shop') Core.renShop(); 
            if(o && id==='m-gacha') el('btn-g-10').style.display = s.rare_tix >= 10 ? 'block' : 'none';
            if(o && id==='m-missions') Core.renMissions();
        },
        tab: (t) => {
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.detail-content').forEach(x=>x.classList.remove('active'));
            el(`tab-${t}`).classList.add('active'); el(`cont-${t}`).classList.add('active');
        },
        toast: (m) => { const d=document.createElement('div'); d.style.cssText=`position:fixed;top:10%;left:50%;transform:translate(-50%,-50%);background:#333;color:#fff;padding:10px;border-radius:10px;z-index:999`; d.innerText=m; document.body.appendChild(d); setTimeout(()=>d.remove(),1500); },
        upd: () => { el('h-mana').innerText=s.mana; el('h-gems').innerText=s.gems; el('p-lvl').innerText=s.p_lvl; el('g-tix').innerText=s.tix; el('g-rare').innerText=s.rare_tix; el('sk-grim').innerText=s.grimoires; },
        getVis: (d) => d.img ? `<img src="${d.img}">` : d.visual,
        renMon: (m) => {
            const d = DB.find(x=>x.id===m.id)||DB[0];
            let stars = ''; for(let i=0;i<m.star;i++) stars+=`<div class="star"></div>`;
            return `<div class="stars" style="position:absolute;top:2px;width:100%">${stars}</div><div style="font-size:2rem;filter:drop-shadow(0 2px 2px rgba(0,0,0,0.1))">${UI.getVis(d)}</div><div class="lvl-badge">${m.lvl}</div>`;
        }
    };

    const Core = {
        updateMission: (type, amount=1) => {
            if(!s.daily_missions) return;
            MISSIONS_DB.forEach(m => {
                if(m.type === type) {
                    if(!s.daily_missions.progress[m.id]) s.daily_missions.progress[m.id] = 0;
                    if(s.daily_missions.progress[m.id] < m.target) {
                        s.daily_missions.progress[m.id] += amount;
                        if(s.daily_missions.progress[m.id] >= m.target) UI.toast(`Miss√£o Completa: ${m.desc}`);
                    }
                }
            });
            Game.save();
        },
        renMissions: () => {
            const list = el('mission-list'); list.innerHTML = '';
            MISSIONS_DB.forEach(m => {
                const prog = s.daily_missions.progress[m.id] || 0;
                const done = prog >= m.target;
                const claimed = s.daily_missions.claimed.includes(m.id);
                const rw = m.r.mana ? `${m.r.mana} üí†` : `${m.r.gems} üíé`;
                
                const div = document.createElement('div'); div.className = 'mission-row';
                div.innerHTML = `
                    <div class="mission-info">
                        <div class="mission-desc">${m.desc}</div>
                        <div class="mission-prog">Progresso: ${prog}/${m.target}</div>
                        <div class="mission-reward">Recompensa: ${rw}</div>
                    </div>
                    <button class="btn-claim" onclick="Core.claimMission('${m.id}')" ${claimed ? 'disabled' : (done ? '' : 'disabled')}>${claimed ? 'Recebido' : 'Resgatar'}</button>
                `;
                list.appendChild(div);
            });
        },
        claimMission: (mid) => {
            if(s.daily_missions.claimed.includes(mid)) return;
            s.daily_missions.claimed.push(mid);
            const m = MISSIONS_DB.find(x => x.id === mid);
            s.mana += m.r.mana; s.gems += m.r.gems;
            Game.save(); UI.upd(); Core.renMissions(); UI.toast("Recompensa Resgatada!");
        },

        setInvFilter: (filter, el) => {
            tmp.invFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            Core.openInv();
            UI.modal('m-filter', 0); 
        },
        openInv: () => {
            UI.nav('inv'); const g=el('inv-grid'); g.innerHTML='';
            let filteredRoster = s.roster;
            if (tmp.invFilter !== 'all') {
                filteredRoster = s.roster.filter(m => {
                    const d = DB.find(x => x.id === m.id);
                    return d.type === tmp.invFilter;
                });
            }
            const elemOrder = {'√Ågua':1, 'Fogo':2, 'Vento':3, 'Luz':4, 'Trevas':5, 'Terra':6};
            filteredRoster.sort((a,b)=>{
                const da=DB.find(x=>x.id===a.id), db=DB.find(x=>x.id===b.id);
                if (tmp.invFilter === 'all') {
                    const ea=elemOrder[da.type]||99, eb=elemOrder[db.type]||99;
                    if(ea!==eb) return ea-eb;
                }
                if(b.star!==a.star) return b.star-a.star;
                return b.lvl-a.lvl;
            });
            filteredRoster.forEach(m=>{ const d=document.createElement('div'); d.className='hero-slot'; if(m.star===5) d.classList.add('legendary-glow'); d.innerHTML=UI.renMon(m); d.onclick=()=>Core.selInv(m.uid); g.appendChild(d); });
        },
        selInv: (uid) => {
            tmp.selInv=uid; const m=s.roster.find(x=>x.uid===uid); const d=DB.find(x=>x.id===m.id); UI.nav('mon_detail');
            let elemColor = d.type==='Fogo'?'#ef4444':d.type==='√Ågua'?'#3b82f6':'#10b981';
            el('mon_detail').style.setProperty('--elem-bg', elemColor);
            el('md-vis').innerHTML=UI.getVis(d); el('md-name').innerText=d.n;
            
            let typeIcon = d.type === 'Fogo' ? 'üî•' : (d.type === '√Ågua' ? 'üíß' : (d.type === 'Vento' ? 'üçÉ' : (d.type === 'Terra' ? '‚õ∞Ô∏è' : (d.type === 'Luz' ? '‚òÄÔ∏è' : 'üåô'))));
            let maxLvl = MAX_LVL[m.star] || 50;
            let isMax = m.lvl >= maxLvl;
            el('md-badge').innerHTML = `${typeIcon} Nv. ${m.lvl} ${isMax ? '<span style="color:#f59e0b; font-weight:800">(MAX)</span>' : ''}`;
            if (isMax) el('md-badge').classList.add('max-lvl'); else el('md-badge').classList.remove('max-lvl');

            let stars = ''; for(let i=0;i<m.star;i++) stars+=`<div class="star" style="width:12px;height:12px"></div>`;
            el('md-stars').innerHTML=stars;
            
            let sm = 1 + m.lvl*0.1;
            let bon = {hp:0, atk:0, def:0, crit:0};
            m.runes.forEach(r => { if(r) { bon[r.type] += r.val; if(r.subs) r.subs.forEach(s => bon[s.type] += s.val); } });

            const baseHp = Math.floor(d.hp * sm);
            const baseAtk = Math.floor(d.atk * sm);
            const baseDef = Math.floor(10 + (m.lvl)); 
            
            el('st-hp').innerText = baseHp; el('bn-hp').innerText = `(+${bon.hp})`;
            el('st-atk').innerText = baseAtk; el('bn-atk').innerText = `(+${bon.atk})`;
            el('st-def').innerText = baseDef; el('bn-def').innerText = `(+${bon.def})`;
            el('st-crit').innerText = 15;

            [0,1,2,3].forEach(i=>{ 
                const r=m.runes[i]; const rx=el(`rs-${i}`); 
                if(r) { rx.className='rune-slot-fancy filled'; rx.style.setProperty('--rune-color',r.type==='hp'?'#ef4444':'#3b82f6'); rx.innerHTML=`<div class="icon" style="color:${r.type==='hp'?'#ef4444':'#3b82f6'}">‚¨¢</div><div class="lvl">+${r.lvl}</div>`; } 
                else { rx.className='rune-slot-fancy'; rx.innerHTML='<div style="color:#ddd;font-size:1.5rem">‚¨°</div>'; }
            });
            const sl=el('skill-desc-list'); sl.innerHTML='';
            d.s.forEach((sk,i)=>{
                const c=document.createElement('div'); c.className='skill-card-detail';
                c.innerHTML=`<div class="skill-icon-large">${i===0?'‚öîÔ∏è':i===1?'‚ö°':'üî•'}</div><div><div style="font-weight:bold">${sk.n} <small style="color:#666">Lv.${m.skLvl[i]}</small></div><div style="font-size:0.75rem;color:#888">${sk.ty.toUpperCase()} - CD:${sk.cd}</div></div>`;
                sl.appendChild(c);
            });
        },
        backToInv: () => UI.nav('inv'),
        pup: () => { 
            const m=s.roster.find(x=>x.uid===tmp.selInv); 
            if(s.pot<1 || m.lvl>=(MAX_LVL[m.star]||50)) return; 
            s.pot--; m.lvl++; Game.save(); Core.selInv(m.uid); UI.upd();
            Core.updateMission('pup');
        },
        openEvo: () => { const m=s.roster.find(x=>x.uid===tmp.selInv); if(m.star>=6) return; tmp.evoTarget=tmp.selInv; tmp.evoFodder=[]; el('evo-req-c').innerText=m.star; el('evo-req-s').innerText=m.star; UI.modal('m-evo',1); Core.renEvo(); },
        renEvo: () => {
            const t=s.roster.find(x=>x.uid===tmp.evoTarget); const g=el('evo-grid'); g.innerHTML='';
            el('evo-slots').innerHTML=Array(t.star).fill(0).map((_,i)=>`<div class="hero-slot" style="width:40px;height:40px;border-style:dashed">${tmp.evoFodder[i]?UI.renMon(s.roster.find(x=>x.uid===tmp.evoFodder[i])):''}</div>`).join('');
            s.roster.filter(m=>m.star===t.star && m.uid!==t.uid).forEach(m=>{
                const d=document.createElement('div'); d.className=`hero-slot ${tmp.evoFodder.includes(m.uid)?'selected':''}`;
                d.innerHTML=UI.renMon(m); d.onclick=()=>{ if(tmp.evoFodder.includes(m.uid)) tmp.evoFodder=tmp.evoFodder.filter(x=>x!==m.uid); else if(tmp.evoFodder.length<t.star) tmp.evoFodder.push(m.uid); Core.renEvo(); };
                g.appendChild(d);
            });
            el('btn-do-evo').disabled = tmp.evoFodder.length<t.star;
        },
        doEvolution: () => {
            const t=s.roster.find(x=>x.uid===tmp.evoTarget);
            s.roster=s.roster.filter(m=>!tmp.evoFodder.includes(m.uid));
            tmp.prep=tmp.prep.filter(u=>!tmp.evoFodder.includes(u)); 
            t.star++; t.lvl=1; Game.save(); UI.modal('m-evo',0); Core.selInv(t.uid); UI.toast("Evolu√ß√£o Sucesso!");
            Core.openInv(); 
        },
        openSkill: () => { tmp.skillFodder=[]; UI.modal('m-skill',1); Core.renSkill(); },
        renSkill: () => {
            const t=s.roster.find(x=>x.uid===tmp.selInv); const g=el('skill-grid'); g.innerHTML='';
            el('skill-slots').innerHTML=`<div class="hero-slot" style="width:40px;height:40px;border-style:dashed">${tmp.skillFodder[0]?UI.renMon(s.roster.find(x=>x.uid===tmp.skillFodder[0])):''}</div>`;
            s.roster.filter(m=>m.id===t.id && m.uid!==t.uid).forEach(m=>{
                const d=document.createElement('div'); d.className=`hero-slot ${tmp.skillFodder.includes(m.uid)?'selected':''}`;
                d.onclick=()=>{ tmp.skillFodder=tmp.skillFodder.includes(m.uid)?[]:[m.uid]; Core.renSkill(); };
                g.appendChild(d);
            });
            el('btn-do-skill').disabled=tmp.skillFodder.length===0;
        },
        doSkill: () => {
            const t=s.roster.find(x=>x.uid===tmp.selInv);
            s.roster=s.roster.filter(m=>!tmp.skillFodder.includes(m.uid));
            tmp.prep=tmp.prep.filter(u=>!tmp.skillFodder.includes(u));
            t.skLvl[0]++; Game.save(); UI.modal('m-skill',0); Core.selInv(t.uid); UI.toast("Skill UP!");
            Core.openInv(); 
        },
        useGrimoire: () => {
            if(s.grimoires<1) return; s.grimoires--; const t=s.roster.find(x=>x.uid===tmp.selInv);
            t.skLvl[0]++; Game.save(); UI.modal('m-skill',0); UI.upd(); Core.selInv(t.uid);
        },
        openRuneBag: () => {
            UI.nav('rune_bag'); const g=el('rune-bag-grid'); g.innerHTML='';
            s.runes_inv.forEach(r=>{
                const rarityColor = r.rarity === 'Lendario' ? 'border-color:var(--c-gold); box-shadow:0 0 5px var(--c-gold)' : (r.rarity === 'Epico' ? 'border-color:var(--c-accent)' : 'border-color:var(--c-primary)');
                const d=document.createElement('div'); d.className='rune-slot-bag'; d.style.cssText = rarityColor;
                d.innerHTML=`
                    <div class="rune-content"><div class="rune-img" style="color:${r.type==='hp'?'#ef4444':'#3b82f6'}">‚¨¢</div></div>
                    <div class="rune-lvl-tag">+${r.lvl}</div><div class="rune-set-icon">${r.type.toUpperCase()}</div>
                `;
                d.onclick = () => Core.popRuneUp(r.id);
                g.appendChild(d);
            });
        },
        sellRune: (rid, p) => { s.runes_inv=s.runes_inv.filter(r=>r.id!==rid); s.mana+=p; Game.save(); UI.upd(); Core.openRuneBag(); },
        openRuneSelect: (slot) => { tmp.selRuneSlot=slot; UI.modal('m-rune',1); Core.renRuneList(); },
        renRuneList: () => {
            const l=el('rune-list'); l.innerHTML='';
            const m=s.roster.find(x=>x.uid===tmp.selInv);
            if(m.runes[tmp.selRuneSlot]) { l.innerHTML+=`<div class="panel" style="padding:10px;border-left:4px solid red" onclick="Core.unequipRune()">Remover Atual</div>`; }
            s.runes_inv.forEach(r=>{
                const d=document.createElement('div'); d.className='panel'; d.style.padding='10px'; d.style.cursor='pointer';
                d.innerHTML=`+${r.lvl} ${r.type} <small>${r.rarity}</small>`; d.onclick=()=>Core.equipRune(r.id);
                l.appendChild(d);
            });
        },
        equipRune: (rid) => {
            const m=s.roster.find(x=>x.uid===tmp.selInv); const idx=s.runes_inv.findIndex(r=>r.id===rid);
            if(m.runes[tmp.selRuneSlot]) s.runes_inv.push(m.runes[tmp.selRuneSlot]);
            m.runes[tmp.selRuneSlot]=s.runes_inv[idx]; s.runes_inv.splice(idx,1);
            Game.save(); UI.modal('m-rune',0); Core.selInv(m.uid);
        },
        unequipRune: () => {
            if(s.mana<1000) return UI.toast("Mana!"); s.mana-=1000;
            const m=s.roster.find(x=>x.uid===tmp.selInv); s.runes_inv.push(m.runes[tmp.selRuneSlot]); m.runes[tmp.selRuneSlot]=null;
            Game.save(); UI.modal('m-rune',0); Core.selInv(m.uid); UI.upd();
        },
        
        // --- RUNE POWER UP (NEW) ---
        popRuneUp: (rid) => {
            let r = s.runes_inv.find(x=>x.id===rid);
            if(!r) s.roster.forEach(m => m.runes.forEach(eq=>{if(eq&&eq.id===rid) r=eq}));
            if(!r) return;
            tmp.upRune = r;
            const rClass = r.rarity==='Lendario'?'legend':'';
            const iconColor = r.type==='hp'?'#ef4444':'#3b82f6';
            el('up-rune-visual').innerHTML = `<div style="color:${iconColor}">‚¨¢</div>`;
            el('up-rune-visual').className = `rune-preview-large ${rClass}`;
            el('up-rune-type').innerText = r.type; el('up-rune-lvl').innerText = `+${r.lvl}`;
            const nextVal = Math.ceil(r.val * 1.1);
            let html = `<div class="stat-line"><span>${r.type.toUpperCase()}</span><div>${r.val} <span class="stat-arrow">‚ûú</span> <span class="new-val">${nextVal}</span></div></div>`;
            if(r.subs) r.subs.forEach(s => html += `<div class="stat-line" style="color:#666; font-size:0.8rem"><span>${s.type}</span><span>+${s.val}</span></div>`); 
            if(r.lvl % 3 === 0 && r.lvl < 15) html += `<div style="text-align:center; color:var(--c-accent); font-weight:bold; margin-top:5px">Pr√≥ximo: Substat Bonus!</div>`;
            el('up-stats-comp').innerHTML = html;
            let cost = 500 + (r.lvl*500); el('up-cost').innerText = cost;
            let chance = 100 - (r.lvl * 5); if(chance<5) chance=5;
            el('up-chance').innerText = `${chance}%`;
            UI.modal('m-rune-up',1);
        },
        doUpgrade: () => {
            const r = tmp.upRune; if(r.lvl>=15) return UI.toast("Max!");
            const cost = 500 + (r.lvl*500); if(s.mana<cost) return UI.toast("Mana!");
            s.mana-=cost; UI.upd();
            Core.updateMission('rup');
            let chance = 100 - (r.lvl * 5); if(chance<5) chance=5;
            if(Math.random() * 100 < chance) {
                r.lvl++; r.val = Math.ceil(r.val*1.1);
                if(r.lvl%3===0) {
                    if(!r.subs) r.subs=[];
                    if(r.subs.length<4) r.subs.push({type:['atk','def','hp','crit'][Math.floor(Math.random()*4)], val:5}); 
                    else r.subs[Math.floor(Math.random()*r.subs.length)].val+=5;
                }
                Game.save(); Core.popRuneUp(r.id); UI.toast("Sucesso!"); 
                if(el('mon_detail').classList.contains('active')) Core.selInv(tmp.selInv);
                if(el('rune_bag').classList.contains('active')) Core.openRuneBag();
            } else UI.toast("Falha...");
        },
        renShop: () => {
            const c=el('shop-container'); c.innerHTML='';
            SHOP_DB.forEach(i=>{ const d=document.createElement('div'); d.className='shop-card'; d.innerHTML=`<div class="shop-icon">${i.icon}</div><div class="shop-name">${i.name}</div><button class="shop-price" onclick="Core.buy('${i.id}',${i.cost},'${i.currency}')">${i.cost}${i.currency==='mana'?'üí†':'üíé'}</button>`; c.appendChild(d); });
        },
        buy: (id,c,curr) => {
            if(curr==='mana'&&s.mana<c || curr==='gems'&&s.gems<c) return UI.toast("Falta grana");
            if (id === 'xpboost') { s.xp_boost_end_time = Date.now() + (7 * 60 * 1000); s.gems -= c; Game.save(); UI.upd(); return UI.toast("Booster Ativo por 7min!"); }
            if(curr==='mana') s.mana-=c; else s.gems-=c;
            if(id==='pot') s.pot++; else if(id==='tix') s.tix++; else if(id==='rare') s.rare_tix++; else s.grimoires++;
            Game.save(); UI.upd(); UI.toast("Comprado!");
        },
        spin: (type, n) => {
            let k=type==='common'?'tix':'rare_tix'; if(s[k]<n) return UI.toast("Sem tickets");
            s[k]-=n; UI.upd(); 
            el('portal-visual').style.animation='spin 0.2s infinite linear'; 
            setTimeout(()=>{
                el('portal-visual').style.animation='none';
                let res=[]; let hasLegend = false;
                for(let i=0;i<n;i++) {
                    let nat=1; const r=Math.random()*100;
                    if(type==='common') { if(r > 98) nat=3; else if(r > 75) nat=2; else nat=1; } 
                    else { if (!s.first_summon_done && i === 0) { if (r > 50) nat=5; else nat=4; s.first_summon_done = true; } else { if (r > 99.5) nat=5; else if (r > 91.5) nat=4; else nat=3; } }
                    if(nat === 5) hasLegend = true;
                    // Exclui IDs 901 e 902 (Chefes) da roleta
                    let p = DB.filter(x=>x.nat===nat && x.id !== 901 && x.id !== 902); 
                    if(p.length===0) p=DB.filter(x=>x.nat===1); 
                    let m = p[Math.floor(Math.random()*p.length)];
                    let nm={uid:uidCount++, id:m.id, lvl:1, star:nat, skLvl:m.s.map(()=>1), runes:[null,null,null,null]};
                    s.roster.push(nm); res.push(nm);
                }
                if(hasLegend) { el('flash-fx').classList.add('active'); setTimeout(() => el('flash-fx').classList.remove('active'), 1500); }
                Game.save(); const g=el('gacha-result-grid'); g.innerHTML='';
                res.forEach(r=>{ const d=document.createElement('div'); d.className='hero-slot'; if(r.star===5) d.classList.add('legendary-glow'); d.innerHTML=UI.renMon(r); g.appendChild(d); });
                UI.modal('m-gacha-results',1);
                Core.updateMission('sum', n);
            }, 400);
        },
        renExpl: () => {
            const c=el('expl-regions'); c.innerHTML='';
            EXPL_REGIONS.forEach(r=>{
                const d=document.createElement('div'); d.className='panel'; d.style.padding='15px'; d.style.display='flex'; d.style.gap='10px'; d.style.borderLeft=`4px solid ${r.color}`;
                d.innerHTML=`<div style="font-size:1.5rem">${r.icon}</div><div><b>${r.name}</b></div>`;
                d.onclick=()=>{ el('expl-regions').style.display='none'; el('expl-stages-list').style.display='flex'; Core.renStageList(r.id); };
                c.appendChild(d);
            });
        },
        backToExplRegions: () => { el('expl-stages-list').style.display='none'; el('expl-regions').style.display='flex'; },
        renStageList: (rid) => {
            const c=el('expl-list-container'); c.innerHTML='';
            for(let i=1;i<=8;i++) {
                const gid=(rid-1)*8+i; const locked=gid>s.maxStage;
                const d=document.createElement('div'); d.className=`panel ${locked?'locked':''}`; d.style.padding='10px';
                d.innerHTML=`Fase ${rid}-${i} ${locked?'üîí':''}`; if(!locked) d.onclick=()=>Core.prep('story',gid);
                c.appendChild(d);
            }
        },
        renDung: () => { el('dung-select').style.display='block'; el('dung-floors').style.display='none'; },
        selectDung: (t) => {
            tmp.dungType=t; el('dung-select').style.display='none'; el('dung-floors').style.display='flex';
            const c=el('dung-list-container'); c.innerHTML='';
            for(let i=1;i<=10;i++) {
                const pk=`d-${t}-${i-1}`; const locked = i>1 && !s.cleared.includes(pk);
                const d=document.createElement('div'); d.className=`panel ${locked?'locked':''}`; d.style.padding='15px'; d.innerHTML=`Andar B${i} ${locked?'üîí':''}`;
                if(!locked) d.onclick=()=>Core.prep('dung',i); 
                c.appendChild(d);
            }
        },
        renTower: () => {
            const c=el('tower-list-container'); c.innerHTML='';
            for(let i=1;i<=50;i++) {
                 const locked = i > s.maxTower;
                 const isBoss = i % 10 === 0;
                 const d=document.createElement('div'); d.className=`panel ${locked?'locked':''}`; d.style.padding='15px'; 
                 d.style.borderColor = isBoss ? 'var(--c-gold)' : '#e5e7eb';
                 d.innerHTML=`<div style="display:flex;justify-content:space-between"><span>${isBoss?'üëë ':''}Andar ${i}</span><span>${locked?'üîí':'‚öîÔ∏è'}</span></div>`;
                 if(!locked) d.onclick=()=>Core.prep('tower',i);
                 c.appendChild(d);
            }
        },
        backToDungSelect: () => { el('dung-floors').style.display='none'; el('dung-select').style.display='block'; },
        prep: (m,l) => { tmp.mode=m; tmp.lvl=l; tmp.prep=[]; UI.nav('prep'); Prep.render(); },
        reqConfirm: (m,a) => { el('confirm-msg').innerText=m; pendingAction=a; UI.modal('m-confirm',1); },
        execConfirm: () => { if(pendingAction) pendingAction(); UI.modal('m-confirm',0); }
    };

    const Prep = {
        render: () => {
            [0,1,2].forEach(i=>el(`s${i}`).innerHTML=tmp.prep[i]?UI.renMon(s.roster.find(x=>x.uid===tmp.prep[i])):'+');
            const g=el('prep-grid'); g.innerHTML='';
            s.roster.sort((a,b)=>(b.star-a.star)||(b.lvl-a.lvl));
            s.roster.forEach(m=>{
                const d=document.createElement('div'); d.className=`hero-slot ${tmp.prep.includes(m.uid)?'selected':''}`;
                d.innerHTML=UI.renMon(m); d.onclick=()=>{ if(tmp.prep.includes(m.uid)) tmp.prep=tmp.prep.filter(x=>x!==m.uid); else if(tmp.prep.length<3) tmp.prep.push(m.uid); Prep.render(); };
                g.appendChild(d);
            });
            const sk = tmp.mode==='story'?`s-${tmp.lvl}`:`d-${tmp.dungType}-${tmp.lvl}`;
            el('btn-farm').style.display = s.cleared.includes(sk) ? 'block' : 'none';
        },
        rem: (i) => { if(tmp.prep[i]) { tmp.prep.splice(i,1); Prep.render(); } }
    };

    const Battle = {
        spd: () => { 
            let next = b.spd === 1 ? 2 : (b.spd === 2 ? 3 : 1);
            if (next === 3 && s.p_lvl < 5) { UI.toast("3x libera no Nv. 5"); next = 1; }
            b.spd = next;
            el('btn-spd').innerText = 'x' + b.spd;
        },
        toggleAuto: () => { 
            if (s.p_lvl < 2) return UI.toast("Auto libera no Nv. 2");
            b.auto=!b.auto; 
            if(b.auto) el('btn-auto').classList.add('active'); else el('btn-auto').classList.remove('active');
            if(b.auto) Battle.turn(); 
        },
        start: (n) => {
            if(!tmp.prep.length) return UI.toast("Selecione monstros!");
            b.farmRuns=n; b.auto=n>0; b.spd=n>0?5:1; el('farm-ui').style.display=n>0?'block':'none';
            // INIT BATTLE STATE
            b.p = tmp.prep.map((uid,i) => {
                const m=s.roster.find(x=>x.uid===uid); const d=DB.find(x=>x.id===m.id);
                let sm=1+m.lvl*0.1; let rs={hp:0,atk:0,def:0,crit:0};
                m.runes.forEach(r=>{if(r){rs[r.type]+=r.val}});
                return {...d, max:Math.floor(d.hp*sm+rs.hp), cur:Math.floor(d.hp*sm+rs.hp), atk:Math.floor(d.atk*sm+rs.atk), idx:i, side:'p', dead:false, cds:d.s.map(()=>0), skLvl:m.skLvl};
            });
            b.e = Array(tmp.mode==='story'?3:1).fill(0).map((_,i)=>{
                let d; let sm;
                // CHEFE MASMORRA FIXO
                if (tmp.mode==='dung') {
                    if (tmp.dungType === 'golem') d = BOSS_DB.golem;
                    else d = BOSS_DB.dragon;
                    sm = 1 + (tmp.lvl * 0.5); // Escala agressiva masmorra
                } else if (tmp.mode === 'tower') {
                     // TOWER LOGIC
                     if (tmp.lvl % 10 === 0) { // Boss Floor
                        d = BOSS_DB.dragon; // Placeholder Boss
                        sm = 1 + (tmp.lvl * 0.3);
                     } else {
                        const commonDB = DB.filter(x => x.id !== 901 && x.id !== 902);
                        d = commonDB[Math.floor(Math.random()*commonDB.length)];
                        sm = 1 + (tmp.lvl * 0.15);
                     }
                } else {
                    // FILTRO DE SEGURAN√áA: NUNCA SPAWNAR BOSS EM HIST√ìRIA
                    const commonDB = DB.filter(x => x.id !== 901 && x.id !== 902);
                    d = commonDB[Math.floor(Math.random()*commonDB.length)]; 
                    sm = 1 + (tmp.lvl * 0.2); // Escala suave historia
                }
                // Clonar objeto para evitar refer√™ncia
                return {...d, max:Math.floor(d.hp*sm), cur:Math.floor(d.hp*sm), atk:Math.floor(d.atk*sm), idx:i, side:'e', dead:false, cds:d.s.map(()=>0), skLvl:[1]};
            });
            b.t='p'; b.idx=0; b.target=null; 
            UI.nav('battle'); Battle.initBoard(); Battle.turn();
        },
        initBoard: () => {
            const ren = (u) => `
                <div id="${u.side}${u.idx}" class="b-unit" onclick="Battle.clk('${u.side}',${u.idx})">
                    <div class="hp-bar-w"><div class="hp-fill" style="width:100%"></div></div>
                    <div class="visual">${UI.getVis(u)}</div>
                    ${u.side==='e'?'<div id="tgt-'+u.idx+'" class="target-marker" style="display:none">‚ñº</div>':''}
                </div>`;
            el('r-pla').innerHTML = b.p.map(ren).join('');
            el('r-ene').innerHTML = b.e.map(ren).join('');
        },
        updateVisuals: () => {
            const update = (list) => {
                list.forEach(u => {
                    const d = el(`${u.side}${u.idx}`);
                    if(d) {
                        d.querySelector('.hp-fill').style.width = `${(u.cur/u.max)*100}%`;
                        // Remove animations if dead
                        if(u.dead) { 
                            d.classList.add('dead'); 
                            d.querySelector('.hp-bar-w').style.display='none'; 
                        } else {
                            d.classList.remove('dead');
                            d.querySelector('.hp-bar-w').style.display='block';
                        }
                    }
                    if(u.side==='e') el(`tgt-${u.idx}`).style.display = b.target===u.idx ? 'block' : 'none';
                });
            };
            update(b.p); update(b.e);
        },
        clk: (side, idx) => {
            if (b.skillPending && side === 'p') {
                const u = b.p[b.idx];
                const skillIdx = b.skillPending.sIdx;
                Battle.execSkill(u, b.p[idx], skillIdx);
                b.skillPending = null;
                el('act-msg').innerText = `Turno de ${u.n}`;
                document.querySelectorAll('.b-unit.selectable').forEach(e => e.classList.remove('selectable'));
                return;
            }
            if(b.t!=='p' || b.auto) return;
            if(side==='e' && !b.e[idx].dead) {
                b.target = idx; // JUST SELECT TARGET
                Battle.updateVisuals();
            }
        },
        turn: () => {
            if(b.e.every(x=>x.dead)) return Battle.end(1); if(b.p.every(x=>x.dead)) return Battle.end(0);
            
            document.querySelectorAll('.b-unit').forEach(u=>u.classList.remove('actor'));
            document.querySelectorAll('.b-unit').forEach(u=>u.classList.remove('active-turn'));
            Battle.updateVisuals();

            if(b.t==='p') {
                if(b.idx>=b.p.length) { b.t='e'; b.idx=0; return Battle.turn(); }
                const u = b.p[b.idx]; 
                if(u.dead) { b.idx++; return Battle.turn(); }
                
                u.cds = u.cds.map(c=>Math.max(0, c-1));

                if(b.auto) {
                    el('btl-ui').classList.remove('active');
                    setTimeout(() => {
                        let t = b.e.find(x=>!x.dead); // Simple AI
                        Battle.execSkill(u, t, 0); // Use skill 1
                    }, 500/b.spd);
                } else {
                    el('act-msg').innerText = `Turno de ${u.n}`;
                    el(`${u.side}${u.idx}`).classList.add('active-turn'); // Highlight only

                    el('skill-list').innerHTML = u.s.map((s,i) => `
                        <div class="skill-btn-3d ${u.cds[i]>0?'cd':''}" onclick="${u.cds[i]>0?'':'Battle.act('+i+')'}">
                            <div class="sk-icon">${i===0?'‚öîÔ∏è':'‚ö°'}</div>
                            <div class="dk-badge">${s.ty.toUpperCase()}</div>
                            ${u.cds[i]>0 ? `<div style="position:absolute;font-size:2rem;color:white;font-weight:900;text-shadow:0 0 5px #000">${u.cds[i]}</div>`:''}
                        </div>`).join('');
                    el('btl-ui').classList.add('active');
                }
            } else {
                el('btl-ui').classList.remove('active');
                if(b.idx>=b.e.length) { b.t='p'; b.idx=0; return Battle.turn(); }
                const u = b.e[b.idx];
                if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c=>Math.max(0, c-1));
                setTimeout(() => {
                    const t = b.p.find(x=>!x.dead);
                    Battle.execSkill(u, t||u, 0);
                }, 800/b.spd);
            }
        },
        act: (si) => {
            const u = b.p[b.idx];
            const sk = u.s[si];
            if (sk.ty === 'heal') {
                b.skillPending = { sIdx: si };
                el('act-msg').innerText = "Selecione um Aliado";
                document.querySelectorAll('#r-pla .b-unit').forEach(e => { if (!e.classList.contains('dead')) e.classList.add('selectable'); });
                return;
            }
            if (sk.ty === 'heal_aoe') { el('btl-ui').classList.remove('active'); Battle.execSkill(u, u, si); return; }
            let t = null;
            if(b.target !== null && !b.e[b.target].dead) t = b.e[b.target];
            else t = b.e.find(x=>!x.dead); // Auto pick first if no target selected

            if(!t) return; // No targets
            
            el('btl-ui').classList.remove('active');
            Battle.execSkill(u, t, si);
        },
        execSkill: (atk, def, si) => {
            const sk = atk.s[si];
            atk.cds[si] = sk.cd + 1;
            
            const aEl = el(`${atk.side}${atk.idx}`);
            aEl.classList.remove('active-turn');
            if(aEl) aEl.classList.add('actor'); // Trigger attack anim

            // Apply Dmg Delay
            setTimeout(() => {
                if(aEl) aEl.classList.remove('actor');
                
                let targets = [def];
                if (sk.ty === 'aoe') targets = atk.side==='p' ? b.e : b.p;
                if (sk.ty === 'heal_aoe') targets = atk.side==='p' ? b.p : b.e;

                targets.forEach(t => {
                    if(t && !t.dead) {
                        const tEl = el(`${t.side}${t.idx}`);
                        if(tEl) {
                            if (sk.ty === 'heal' || sk.ty === 'heal_aoe') {
                                const healAmount = Math.floor(atk.atk * sk.m);
                                t.cur = Math.min(t.max, t.cur + healAmount);
                                const popup = document.createElement('div'); popup.className='dmg-popup'; popup.innerHTML = `+${healAmount}`; popup.style.color = '#22c55e';
                                tEl.appendChild(popup); setTimeout(()=>popup.remove(), 800);
                            } else {
                                tEl.classList.add('hit'); setTimeout(()=>tEl.classList.remove('hit'), 300);
                                let mult = 1; let txtColor = '#fff'; let txtExtra = '';
                                const at = atk.type; const dt = t.type;
                                if ((at=='√Ågua' && dt=='Fogo') || (at=='Fogo' && dt=='Vento') || (at=='Vento' && dt=='Terra') || (at=='Terra' && dt=='√Ågua') || (at=='Luz' && dt=='Trevas') || (at=='Trevas' && dt=='Luz')) { mult = 1.2; txtColor = '#facc15'; txtExtra = 'CRUSH! '; } 
                                else if ((at=='Fogo' && dt=='√Ågua') || (at=='Vento' && dt=='Fogo') || (at=='Terra' && dt=='Vento') || (at=='√Ågua' && dt=='Terra')) { mult = 0.8; txtColor = '#9ca3af'; txtExtra = 'Glance... '; }
                                const dmg = Math.floor(atk.atk * sk.m * mult);
                                t.cur = Math.max(0, t.cur - dmg);
                                if(t.cur===0) t.dead = true;
                                const popup = document.createElement('div'); popup.className='dmg-popup'; popup.innerHTML = `<span style="font-size:0.5em">${txtExtra}</span>${dmg}`; popup.style.color = txtColor;
                                tEl.appendChild(popup); setTimeout(()=>popup.remove(), 800);
                            }
                        }
                    }
                });
                Battle.updateVisuals();
                b.idx++; 
                setTimeout(Battle.turn, 500/b.spd);
            }, 300/b.spd);
        },
        end: (w) => {
            setTimeout(() => {
                if(w) {
                    const boostActive = s.xp_boost_end_time && Date.now() < s.xp_boost_end_time;
                    const gainScale = tmp.lvl || 1;
                    const rMana = (300 + (gainScale * 50)) * (boostActive ? 1.5 : 1);
                    const rXP = (100 + (gainScale * 20)) * (boostActive ? 2 : 1);
                    
                    // SAVE PROGRESS (CORRIGIDO)
                    const stageKey = tmp.mode==='story'?`s-${tmp.lvl}`:`d-${tmp.dungType}-${tmp.lvl}`;
                    const isFirst = !s.cleared.includes(stageKey);
                    if(isFirst) s.cleared.push(stageKey);
                    
                    // UNLOCK NEXT STAGE STORY
                    if(tmp.mode === 'story' && tmp.lvl === s.maxStage) {
                        s.maxStage++;
                        UI.toast("Nova Fase Desbloqueada!");
                    }
                    if(tmp.mode === 'tower' && tmp.lvl === s.maxTower) {
                         s.maxTower++;
                    }

                    const rGems = isFirst ? 50 : 5;
                    s.mana += rMana; s.xp += rXP; s.gems += rGems;
                    Core.updateMission('win');
                    if(tmp.mode==='dung') Core.updateMission('dun_win');

                    if (s.xp >= s.max_xp) {
                        s.xp -= s.max_xp; s.p_lvl++; s.gems += 100; s.max_xp = Math.floor(s.max_xp * 1.5);
                        UI.toast(`LEVEL UP! +100 üíé`);
                    }
                    el('end-mana').innerText = `+${Math.floor(rMana)}`; el('end-gems').innerText = `+${rGems}`; el('rune-drop-msg').innerText = `+${Math.floor(rXP)} XP Conta`;
                    if(tmp.mode==='dung') {
                        let rType = 'Raro'; const roll = Math.random() * 100;
                        if (tmp.lvl <= 3) { if (roll > 90) rType = 'Epico'; } 
                        else if (tmp.lvl <= 7) { if (roll > 95) rType = 'Lendario'; else if (roll > 60) rType = 'Epico'; } 
                        else { if (roll > 80) rType = 'Lendario'; else if (roll > 40) rType = 'Epico'; }
                        const r = {id:runeIdCount++, type:['hp','atk','def'][Math.floor(Math.random()*3)], val:10 + (tmp.lvl * 2), lvl:0, rarity:rType};
                        s.runes_inv.push(r); el('rune-drop-msg').innerText += ` | ${r.type} ${r.rarity}`;
                    }
                    if(b.farmRuns>1) { b.farmRuns--; el('farm-count').innerText=b.farmRuns; setTimeout(()=>Battle.start(b.farmRuns), 1000); return; }
                }
                el('end-title').innerText = w ? "VIT√ìRIA" : "DERROTA";
                UI.modal('m-end',1); Game.save(); UI.upd();
            }, 1000);
        },
        close: () => { 
            UI.modal('m-end',0); 
            if(tmp.mode === 'story') {
                UI.nav('expl');
                const rid = Math.ceil(tmp.lvl/8);
                // Force view to stages
                el('expl-regions').style.display='none';
                el('expl-stages-list').style.display='flex';
                Core.renStageList(rid);
            } else if (tmp.mode === 'dung') {
                UI.nav('dung');
                // Force view to floors
                // Note: UI.nav('dung') calls renDung() which resets to select. We override immediately.
                Core.selectDung(tmp.dungType);
            } else if (tmp.mode === 'tower') {
                 UI.nav('tower'); // renTower handles list
            } else {
                UI.nav('hub');
            }
        }
    };
</script>
</body>
</html>
