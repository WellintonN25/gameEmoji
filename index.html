<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guardi√µes: Legends</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700;800&display=swap');

        :root { --bg: #0f172a; --panel: #1e293b; --accent: #3b82f6; --gold: #f59e0b; --danger: #ef4444; --success: #10b981; --purple: #a855f7; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; color: white; }

        #app {
            width: 100%; max-width: 800px; height: 100%; position: relative;
            background: linear-gradient(to bottom, #111827, #000);
            box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden;
        }

        /* --- UI HELPERS --- */
        .shake-screen { animation: shake-screen 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-screen { 10%, 90% { transform: translate3d(-2px, -2px, 0); } 20%, 80% { transform: translate3d(2px, 2px, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 2px, 0); } 40%, 60% { transform: translate3d(4px, -2px, 0); } }

        /* --- TELAS --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; z-index: 10; background: #0f172a; }
        .screen.active { display: flex; animation: fade 0.3s ease-out; }
        @keyframes fade { from{opacity:0} to{opacity:1} }
        
        #login { background: url('https://images.unsplash.com/photo-1533134486753-c833f0ed4866?w=800&q=60') center/cover; align-items: center; justify-content: center; }
        #hub { background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?w=800&q=60') center/cover; }
        #battle { background: url('https://images.unsplash.com/photo-1518066000714-58c45f1a2c0a?w=800&q=60') center/cover; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 0; pointer-events: none; }

        /* --- UI LOGIN --- */
        .login-box { background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; border: 2px solid var(--accent); text-align: center; z-index: 2; width: 90%; max-width: 350px; backdrop-filter: blur(5px); }
        .login-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: white; border-radius: 8px; font-size: 1.2rem; text-align: center; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* --- UI GERAL --- */
        .btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 8px 12px; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; font-size: 0.85rem;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .btn-gold { background: var(--gold); color: #000; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .btn-green { background: var(--success); border: none; }
        .btn-purple { background: var(--purple); border: none; box-shadow: 0 0 10px var(--purple); }
        .btn-blue { background: var(--accent); border: none; box-shadow: 0 0 10px var(--accent); }
        .btn-red { background: var(--danger); border: none; box-shadow: 0 0 10px var(--danger); }
        .btn-crystal { background: #0ea5e9; border: none; box-shadow: 0 0 15px #0ea5e9; }
        .btn-shop-item { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:15px; height:auto; gap:5px; background:#334155; border:1px solid #475569; }
        
        .top-bar { position: relative; z-index: 10; display: flex; flex-direction: column; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 5px 15px; height: 75px; flex-shrink: 0; justify-content: center; }
        .top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2px; }
        .currency { display: flex; gap: 10px; font-size: 0.8rem; font-weight: bold; text-shadow: 0 2px 2px black; align-items: center; }
        .mana-icon { color: #00ffff; text-shadow: 0 0 10px #00ffff; margin-right: 2px; }
        
        .xp-bar-container { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: 2px; position: relative; }
        .xp-fill { height: 100%; background: var(--gold); width: 0%; transition: 0.5s; box-shadow: 0 0 5px var(--gold); }

        /* --- MAPAS & EST√ÅGIOS --- */
        .stage-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; overflow-y: auto; }
        .stage-btn { aspect-ratio: 1; background: #222; border: 2px solid #555; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; position: relative; transition: 0.2s; }
        .stage-btn.locked { opacity: 0.3; pointer-events: none; border-color: #333; }
        .stage-btn.cleared { border-color: var(--success); color: var(--success); }
        .stage-btn.boss { border-color: var(--danger); color: var(--danger); }
        .stage-btn:active { transform: scale(0.9); }
        .first-clear-badge { position: absolute; top: -5px; right: -5px; background: var(--gold); color: black; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

        /* --- MONSTROS --- */
        .mon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 5px; padding: 8px; overflow-y: auto; align-content: start; }
        .mon-slot { width: 50px; height: 50px; background: #222; border: 2px solid #555; border-radius: 6px; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; overflow: hidden; }
        .mon-slot.selected { border-color: var(--gold); box-shadow: 0 0 8px var(--gold); background: #333; }
        .mon-slot.fodder { border-color: var(--danger); opacity: 0.5; filter: grayscale(1); }
        .mon-slot.skill-up { border-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
        .mon-visual { font-size: 2rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .mon-visual img { width: 100%; height: 100%; object-fit: cover; }
        .mon-lvl { position: absolute; bottom: 0; right: 0; background: #000; color: #fff; font-size: 0.6rem; padding: 0 3px; border-top-left-radius: 3px; z-index: 2; }
        .stars-row { position: absolute; top: 0; width: 100%; text-align: center; display: flex; justify-content: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); z-index: 2; }
        .star { font-size: 0.6rem; color: var(--gold); text-shadow: 0 1px 2px black; margin: 0 -1px; }
        .star.purple { color: var(--purple); }

        /* --- INVENT√ÅRIO --- */
        .inv-container { flex: 1; display: flex; position: relative; z-index: 2; overflow: hidden; }
        .inv-list-panel { width: 45%; background: rgba(0,0,0,0.85); border-right: 1px solid #444; display: flex; flex-direction: column; }
        .inv-detail-panel { width: 55%; padding: 15px; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle at center, rgba(30, 41, 59, 0.9), rgba(0,0,0,0.95)); overflow-y: auto; }
        .detail-model { width: 120px; height: 120px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 5rem; animation: float 3s infinite ease-in-out; border-radius: 10px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); overflow: hidden; }
        .detail-model img { width: 100%; height: 100%; object-fit: cover; }
        .detail-stats { width: 100%; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 4px 0; font-size: 0.8rem; }
        .stat-bonus { color: var(--success); font-weight: bold; font-size: 0.7rem; }
        .btn-grp { display: grid; gap: 8px; width: 100%; margin-top: 5px; }

        /* --- PREP --- */
        .prep-stage { height: 35%; display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; z-index: 2; }
        .prep-slot { width: 70px; height: 70px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); cursor: pointer; overflow: hidden; }
        .prep-slot.filled { border-style: solid; border-color: var(--success); background: rgba(16, 185, 129, 0.2); }
        .prep-list { height: 65%; background: rgba(0,0,0,0.9); padding: 10px; z-index: 2; border-top: 2px solid #444; }

        /* --- BATALHA --- */
        .stage { flex: 1; position: relative; perspective: 1000px; overflow: hidden; z-index: 1; transition: 0.3s; }
        .ground-shadow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160%; height: 60%; background: radial-gradient(ellipse at center, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 40%, transparent 70%); z-index: 0; pointer-events: none; }
        .row { display: flex; justify-content: center; gap: 20px; position: absolute; width: 100%; transition: 0.6s; }
        .enemies { top: 25%; z-index: 5; transform: scale(0.85); }
        .players { top: 55%; z-index: 10; } 
        .unit { position: relative; width: 70px; height: 70px; text-align: center; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s; cursor: pointer; }
        .unit.boss-unit { width: 120px; height: 120px; z-index: 6; }
        .players .unit { transform: scaleX(-1); cursor: default; }
        .unit-sprite { width: 100%; height: 100%; font-size: 3.5rem; filter: drop-shadow(0 10px 5px rgba(0,0,0,0.5)); transition: 0.2s; display: flex; align-items: center; justify-content: center; position: relative; z-index: 2; }
        .boss-unit .unit-sprite { font-size: 6rem; }
        .unit-sprite img { width: 100%; height: 100%; object-fit: contain; }
        .hp-container { position: absolute; top: -15px; width: 100%; z-index: 20; opacity: 1; transition: opacity 0.3s; }
        .boss-unit .hp-container { top: -25px; width: 150%; left: -25%; }
        .hp-bar { height: 6px; background: #111; border: 1px solid #444; border-radius: 3px; position: relative; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.3s ease-out; }
        .enemies .hp-fill { background: var(--danger); }
        .unit.dead { opacity: 0 !important; filter: none !important; pointer-events: none !important; transform: translateY(30px) scale(0.8) !important; transition: opacity 0.5s, transform 0.5s; }
        .stage.cinematic .unit { filter: blur(2px) brightness(0.4) grayscale(0.8); opacity: 0.7; transform: scale(0.9); }
        .stage.cinematic .players .unit { transform: scaleX(-1) scale(0.9); }
        .stage.cinematic .unit.actor { filter: brightness(1.2) drop-shadow(0 0 15px var(--gold)); transform: scale(1.2) translateY(-10px); z-index: 100; opacity: 1; }
        .stage.cinematic .players .unit.actor { transform: scaleX(-1) scale(1.2) translateY(-10px); }
        .stage.cinematic .unit.target-focus { filter: brightness(1.2) drop-shadow(0 0 15px var(--danger)); transform: scale(1.1); z-index: 90; opacity: 1; }
        .stage.cinematic .players .unit.target-focus { transform: scaleX(-1) scale(1.1); }
        .target-marker { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); color: var(--danger); font-size: 1.5rem; animation: bounce 0.5s infinite; text-shadow: 0 0 5px red; z-index: 100; pointer-events: none; }
        @keyframes bounce { 0%,100%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-10px)} }
        .attacking-p .unit-sprite { animation: atk-p 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .attacking-e .unit-sprite { animation: atk-e 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes atk-p { 0%{transform:translate(0,0)} 50%{transform:translate(0, -80px) scale(1.4)} 100%{transform:translate(0,0)} }
        @keyframes atk-e { 0%{transform:translate(0,0)} 50%{transform:translate(0, 80px) scale(1.4)} 100%{transform:translate(0,0)} }
        .hit-anim .unit-sprite { animation: hit-flash 0.4s ease-out; }
        @keyframes hit-flash { 0% { transform: scale(1.1); filter: brightness(10) sepia(0) grayscale(1); } 20% { transform: translate(-5px, 0); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(5px, 0); } 60% { transform: translate(-5px, 0); } 100% { transform: scale(1); filter: none; } }
        .dmg-txt { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 3rem; font-weight: 800; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; animation: dmg-pop 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; z-index: 200; pointer-events: none; }
        @keyframes dmg-pop { 0%{transform:translate(-50%,0) scale(0.5); opacity:0} 30%{transform:translate(-50%,-40px) scale(1.5); opacity:1; color: #ffeb3b;} 100%{opacity:0; transform:translate(-50%, -80px) scale(1);} }

        /* SKILLS */
        .skills-ui { position: absolute; bottom: 20px; right: 20px; left: 20px; z-index: 100; display: flex; justify-content: space-between; align-items: flex-end; transform: translateY(150%); transition: 0.3s; }
        .skills-ui.active { transform: translateY(0); }
        .skill-btns { display: flex; gap: 10px; }
        .skill-btn { width: 65px; height: 65px; border-radius: 50%; background: #222; border: 3px solid #555; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s; }
        .skill-btn:active { transform: scale(0.9); }
        .skill-btn.main { border-color: var(--gold); }
        .skill-btn.spec { border-color: var(--accent); }
        .skill-btn.ulti { border-color: #a855f7; }
        .skill-btn.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .cd-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white; }
        .skill-btn small { position: absolute; bottom: -18px; font-size: 0.6rem; font-weight: bold; width: 100px; text-align: center; text-shadow: 0 1px 2px black; }
        
        .speed-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid var(--accent); color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; }
        .auto-btn { position: absolute; top: 20px; right: 70px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 2px solid #555; color: #aaa; font-weight: bold; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 100; font-size: 0.7rem; }
        .auto-btn.active { border-color: var(--success); color: var(--success); background: rgba(16,185,129,0.2); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .modal.open { display: flex; }
        .evo-box { background: #1e293b; border: 2px solid var(--purple); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .skill-box { background: #1e293b; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .evo-materials { display: flex; justify-content: center; gap: 10px; margin: 20px 0; min-height: 50px; }
        .mat-slot { width: 50px; height: 50px; border: 2px dashed #555; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #aaa; }
        .gacha-box { background: #1e293b; border: 2px solid var(--gold); padding: 25px; border-radius: 20px; width: 320px; text-align: center; }
        .card { width: 140px; height: 200px; border: 3px solid var(--gold); border-radius: 15px; font-size: 4rem; display: flex; align-items: center; justify-content: center; background: #111; transition: 0.5s; margin: 0 auto 15px; }
        .card img { width: 90%; height: 90%; object-fit: contain; }
        .reward-box { background: #1e293b; padding: 25px; border-radius: 20px; width: 300px; text-align: center; border: 2px solid var(--gold); box-shadow: 0 0 50px rgba(245, 158, 11, 0.3); animation: popIn 0.3s; }
        @keyframes popIn { from{transform:scale(0.5)} to{transform:scale(1)} }
        .reward-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; font-size: 1.2rem; }

    </style>
</head>
<body>

<div id="app">

    <!-- TELA DE LOGIN -->
    <div id="login" class="screen active">
        <div class="login-box">
            <h1 style="color:var(--gold); font-size:2.5rem; text-shadow:0 0 20px rgba(245,158,11,0.5)">GUARDI√ïES</h1>
            <h3 style="color:var(--accent); margin-bottom:20px; letter-spacing:3px">LEGENDS</h3>
            <input type="text" id="inp-user" class="login-input" placeholder="Nome do Her√≥i" maxlength="12">
            <button class="btn btn-gold" style="width:100%; height:50px; font-size:1.2rem" onclick="Game.login()">JOGAR</button>
        </div>
    </div>

    <!-- MODAL EVOLU√á√ÉO -->
    <div id="m-evo" class="modal">
        <div class="evo-box">
            <h2 style="color:var(--purple); margin-bottom:5px">Evolu√ß√£o</h2>
            <p style="font-size:0.9rem; color:#ccc">Sacrifique <b id="evo-req-c">0</b> monstros de <b id="evo-req-s">0</b>‚òÖ</p>
            <div id="evo-slots" class="evo-materials"></div>
            <div style="height:200px; overflow-y:auto; border:1px solid #444; border-radius:8px; padding:10px; text-align:left; margin-bottom:10px">
                <div id="evo-grid" class="mon-grid"></div>
            </div>
            <p style="font-size:0.8rem; color:var(--accent); margin-bottom:5px">üí° Dica: Sacrificar um monstro igual aumenta a Skill!</p>
            <button id="btn-do-evo" class="btn btn-purple" style="width:100%" disabled onclick="Core.doEvolution()">EVOLUIR</button>
            <button class="btn" style="margin-top:10px; width:100%" onclick="UI.modal('m-evo',0)">Cancelar</button>
        </div>
    </div>

    <!-- MODAL SKILL UP -->
    <div id="m-skill" class="modal">
        <div class="skill-box">
            <h2 style="color:var(--accent); margin-bottom:5px">Skill Up</h2>
            <p style="font-size:0.9rem; color:#ccc">Sacrifique duplicatas ou use Grim√≥rios</p>
            <div style="display:flex; justify-content:center; margin-bottom:15px">
                <button class="btn btn-gold" onclick="Core.useGrimoire()">Usar üìö Grim√≥rio (Possui: <span id="sk-grim">0</span>)</button>
            </div>
            <div id="skill-slots" class="evo-materials"></div>
            <div style="height:200px; overflow-y:auto; border:1px solid #444; border-radius:8px; padding:10px; text-align:left; margin-bottom:10px">
                <div id="skill-grid" class="mon-grid"></div>
            </div>
            <button id="btn-do-skill" class="btn btn-blue" style="width:100%" disabled onclick="Core.doSkill()">APRIMORAR (Duplicata)</button>
            <button class="btn" style="margin-top:10px; width:100%" onclick="UI.modal('m-skill',0)">Cancelar</button>
        </div>
    </div>

    <!-- MODAL GACHA -->
    <div id="m-gacha" class="modal">
        <div class="gacha-box">
            <div id="g-card" class="card">?</div>
            <h2 id="g-res" style="color:var(--gold); margin-bottom:10px">???</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
                <button class="btn btn-blue" style="flex-direction:column; padding:10px" onclick="Core.spin('common')">
                    <span style="font-size:0.8rem">INVOCAR COMUM</span>
                    <div style="display:flex;align-items:center;gap:3px">‚ö™ x1</div>
                </button>
                <button class="btn btn-crystal" style="flex-direction:column; padding:10px" onclick="Core.spin('rare')">
                    <span style="font-size:0.8rem">INVOCAR RARO</span>
                    <div style="display:flex;align-items:center;gap:3px">üü° x1</div>
                </button>
            </div>
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px">
                Possui: ‚ö™ <span id="g-tix">0</span> | üü° <span id="g-rare">0</span>
            </div>

            <button class="btn" style="width:100%; background:#333" onclick="UI.modal('m-gacha',0)">Sair</button>
        </div>
    </div>

    <!-- MODAL LOJA -->
    <div id="m-shop" class="modal">
        <div style="background:#1e293b; padding:20px; border-radius:10px; width:340px; text-align:center; border:1px solid #444">
            <h2 style="color:var(--gold); margin-bottom:10px">Loja</h2>
            <div style="margin-bottom:15px; font-size:0.9rem; display:flex; justify-content:center; gap:10px">
                <span>üí† <span id="s-mana">0</span></span>
                <span>üíé <span id="s-gems">0</span></span>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                <button class="btn btn-shop-item" onclick="Core.buy('pot', 100)">
                    <span>üß™ Po√ß√£o</span> <span style="color:var(--gold)">100 üí†</span>
                </button>
                <button class="btn btn-shop-item" onclick="Core.buy('xpboost', 50, 'gems')">
                    <span>üöÄ Booster XP (3x)</span> <span style="color:var(--accent)">50 üíé</span>
                </button>
                <button class="btn btn-shop-item" onclick="Core.buy('tix', 1000)">
                    <span>‚ö™ Cristal Comum</span> <span style="color:var(--gold)">1k üí†</span>
                </button>
                <button class="btn btn-shop-item" onclick="Core.buy('tix_pack', 10000)">
                    <span>‚ö™ Pack Comum (11x)</span> <span style="color:var(--gold)">10k üí†</span>
                </button>
                <button class="btn btn-shop-item" onclick="Core.buy('rare', 100, 'gems')">
                    <span>üü° Cristal Raro</span> <span style="color:var(--accent)">100 üíé</span>
                </button>
                <button class="btn btn-shop-item" onclick="Core.buy('grimoire', 500, 'gems')">
                    <span>üìö Grim√≥rio</span> <span style="color:var(--accent)">500 üíé</span>
                </button>
            </div>
            <button class="btn" style="margin-top:15px; background:#333; width:100%" onclick="UI.modal('m-shop',0)">Sair</button>
        </div>
    </div>

    <!-- MODAL RECOMPENSA -->
    <div id="m-end" class="modal">
        <div class="reward-box">
            <h2 id="end-title" style="color:var(--gold)">VIT√ìRIA!</h2>
            <div class="reward-row">
                <div style="display:flex;align-items:center;flex-direction:column"><span class="mana-icon" style="font-size:2rem">üí†</span><div id="end-mana">+100</div></div>
                <div style="display:flex;align-items:center;flex-direction:column"><span style="font-size:2rem">üíé</span><div id="end-gems">+0</div></div>
                <div style="display:flex;align-items:center;flex-direction:column"><span id="end-item-icon" style="font-size:2rem">üß™</span><div id="end-xp">+1</div></div>
            </div>
            <div style="font-size:0.8rem; color:#aaa; margin-top:5px">XP Conta: <span id="end-acc-xp">+0</span></div>
            <button class="btn btn-gold" style="width:100%; margin-top:10px" onclick="Battle.close()">Continuar</button>
        </div>
    </div>

    <!-- HUB -->
    <div id="hub" class="screen">
        <div class="overlay"></div>
        <div class="top-bar">
            <div class="top-row">
                <div><span id="p-name" style="color:var(--accent)">Hero</span> (Nv. <span id="p-lvl">1</span>)</div>
                <div class="currency">
                    <span><span class="mana-icon">üí†</span><span id="h-mana">0</span></span>
                    <span>üíé <span id="h-gems">0</span></span>
                </div>
            </div>
            <div class="top-row" style="justify-content:flex-start; gap:15px; font-size:0.75rem">
                <span>‚ö™ <span id="h-tix">0</span></span>
                <span>üü° <span id="h-rare">0</span></span>
                <span>üìö <span id="h-grim">0</span></span>
                <span>üöÄ <span id="h-boost">0</span></span>
                <span>üìñ <span id="h-books">0</span></span>
            </div>
            <div class="xp-bar-container"><div id="p-xp-bar" class="xp-fill"></div></div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2">
            <div style="font-size:6rem; animation:float 3s infinite ease-in-out">üë§</div>
            <h1 style="color:var(--accent); margin-top:10px">L√≠der</h1>
            <button class="btn" style="margin-top:10px; font-size:0.7rem; opacity:0.7" onclick="Game.logout()">Sair</button>
        </div>
        <div style="padding:20px; z-index:2; display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn btn-gold" onclick="UI.nav('expl')">üó∫Ô∏è Explorar</button>
            <button class="btn btn-red" onclick="UI.nav('dung')">üëπ Masmorra</button>
            <button class="btn" onclick="Core.openInv()">üéí Monstros</button>
            <button class="btn" onclick="UI.modal('m-shop',1)">üõí Loja</button>
            <button class="btn" style="grid-column:span 2" onclick="UI.modal('m-gacha',1)">‚ú® Invocar</button>
        </div>
    </div>

    <!-- EXPLORA√á√ÉO -->
    <div id="expl" class="screen">
        <div class="top-bar"><button class="btn" onclick="UI.nav('hub')">‚¨Ö</button><span>MAPA MUNDI</span><span></span></div>
        <div class="inv-container" style="flex-direction:column">
            <div style="padding:15px; text-align:center; color:#aaa">Ven√ßa para desbloquear e ganhar Cristais!</div>
            <div id="expl-grid" class="stage-grid"></div>
        </div>
    </div>

    <!-- MASMORRA -->
    <div id="dung" class="screen">
        <div class="top-bar"><button class="btn" onclick="UI.nav('hub')">‚¨Ö</button><span>MASMORRA</span><span>üìñ <span id="d-books">0</span></span></div>
        <div class="inv-container" style="flex-direction:column; background: linear-gradient(to bottom, #2e1065, #000);">
            <div style="padding:15px; text-align:center; color:#fca5a5">Derrote os Chefes para ganhar Livros Antigos!</div>
            <div id="dung-grid" class="stage-grid"></div>
        </div>
    </div>

    <!-- INVENT√ÅRIO -->
    <div id="inv" class="screen">
        <div class="top-bar"><button class="btn" style="padding:5px 10px" onclick="UI.nav('hub')">‚¨Ö</button><span>BOX</span><span>üìñ <span id="inv-books">0</span></span></div>
        <div class="inv-container">
            <div class="inv-list-panel"><div class="inv-filters">Total: <span id="inv-count">0</span></div><div id="inv-grid" class="mon-grid"></div></div>
            <div id="inv-detail" class="inv-detail-panel"><div style="color:#aaa; margin-top:50px">Selecione</div></div>
        </div>
    </div>

    <!-- PREPARA√á√ÉO -->
    <div id="prep" class="screen">
        <div class="top-bar"><button class="btn" onclick="UI.nav('hub')">‚¨Ö</button><span>TIME</span><button id="btn-fight" class="btn btn-gold" onclick="Battle.start()">LUTAR</button></div>
        <div class="prep-stage"><div id="s0" class="prep-slot" onclick="Prep.rem(0)"></div><div id="s1" class="prep-slot" onclick="Prep.rem(1)"></div><div id="s2" class="prep-slot" onclick="Prep.rem(2)"></div></div>
        <div class="prep-list"><div id="prep-grid" class="mon-grid"></div></div>
    </div>

    <!-- BATALHA -->
    <div id="battle" class="screen">
        <div class="overlay"></div>
        <button id="btn-spd" class="speed-btn" onclick="Battle.spd()">x1</button>
        <button id="btn-auto" class="auto-btn" onclick="Battle.toggleAuto()">AUTO</button>
        <div id="stg" class="stage">
            <div class="ground-shadow"></div>
            <div class="row enemies" id="r-ene"></div>
            <div class="row players" id="r-pla"></div>
        </div>
        <div id="btl-ui" class="skills-ui">
            <div style="background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; border-left:3px solid var(--accent)">
                <div id="act-name" style="color:var(--accent); font-weight:bold">Nome</div>
                <div style="font-size:0.7rem; color:#fff">Sua Vez - <span id="act-target" style="color:var(--danger)">Selecione Alvo</span></div>
            </div>
            <div id="skill-list" class="skill-btns"></div>
        </div>
    </div>

</div>

<script>
    const MAX_LVL = { 1:5, 2:10, 3:20, 4:30, 5:40, 6:50 };
    
    // --- BANCO DE DADOS (MONSTROS POR RARIDADE) ---
    // ty: 'heal' = Cura aliado com menor HP. ty: 'turn' = D√° turno extra a aliado aleat√≥rio (exceto self).
    const DB = [
        // --- 1 ESTRELA (COMUNS) ---
        { id:101, nat:1, n:'Slime', type:'√Ågua', img:'', visual:'üíß', s:[{n:'Pancada',m:1,cd:0}], hp:50, atk:10, color:'#3b82f6' },
        { id:102, nat:1, n:'Wisp', type:'Fogo', img:'', visual:'üî•', s:[{n:'Queimar',m:1,cd:0}], hp:45, atk:12, color:'#ef4444' },
        { id:103, nat:1, n:'Rat', type:'Terra', img:'', visual:'üêÄ', s:[{n:'Mordida',m:1,cd:0}], hp:55, atk:11, color:'#10b981' },
        // --- 2 ESTRELAS (INCOMUNS) ---
        { id:201, nat:2, n:'Goblin', type:'Terra', img:'', visual:'üë∫', s:[{n:'Clava',m:1,cd:0},{n:'F√∫ria',m:1.3,cd:2}], hp:80, atk:18, color:'#10b981' },
        { id:202, nat:2, n:'Bat', type:'Vento', img:'', visual:'ü¶á', s:[{n:'Suga Sangue',m:1,cd:0},{n:'S√¥nico',m:1.2,cd:2}], hp:70, atk:20, color:'#a855f7' },
        { id:203, nat:2, n:'Wolf', type:'√Ågua', img:'', visual:'üê∫', s:[{n:'Mordida',m:1,cd:0},{n:'Uivo',m:1.3,cd:2}], hp:85, atk:19, color:'#3b82f6' },
        { id:204, nat:2, n:'Dryad', type:'Natureza', img:'', visual:'üßö', s:[{n:'Espinhos',m:1,cd:0},{n:'Curar',m:2,cd:3,ty:'heal'}], hp:90, atk:15, color:'#10b981' },
        // --- 3 ESTRELAS (RAROS) ---
        { id:301, nat:3, n:'Golem', type:'Terra', img:'', visual:'üóø', s:[{n:'Esmagar',m:1,cd:0},{n:'Pedregulho',m:1.3,cd:2},{n:'Terremoto',m:2.8,cd:4}], hp:180, atk:25, color:'#10b981' },
        { id:302, nat:3, n:'Mage', type:'Trov√£o', img:'', visual:'üßô', s:[{n:'Raio',m:1,cd:0},{n:'Choque',m:1.5,cd:2},{n:'Trov√£o',m:3,cd:4}], hp:140, atk:35, color:'#f59e0b' },
        { id:303, nat:3, n:'Kraken', type:'√Ågua', img:'', visual:'üêô', s:[{n:'Tent√°culo',m:1,cd:0},{n:'Jato',m:1.4,cd:2},{n:'Tsunami',m:2.5,cd:4}], hp:160, atk:28, color:'#3b82f6' },
        { id:304, nat:3, n:'Oracle', type:'Luz', img:'', visual:'üîÆ', s:[{n:'Orbe',m:1,cd:0},{n:'Grande Cura',m:3,cd:3,ty:'heal'}], hp:150, atk:20, color:'#facc15' },
        // --- 4 ESTRELAS (√âPICOS) ---
        { id:401, nat:4, n:'Sylph', type:'Vento', img:'', visual:'ü¶Ö', s:[{n:'Bico',m:1,cd:0},{n:'Ventania',m:1.4,cd:2},{n:'Tornado',m:2.6,cd:4}], hp:250, atk:50, color:'#a855f7' },
        { id:402, nat:4, n:'Raijin', type:'Trov√£o', img:'', visual:'‚ö°', s:[{n:'Choque',m:1,cd:0},{n:'Raio',m:1.6,cd:2},{n:'Tempestade',m:3.2,cd:4}], hp:240, atk:55, color:'#f59e0b' },
        { id:403, nat:4, n:'Phoenix', type:'Fogo', img:'', visual:'üê¶‚Äçüî•', s:[{n:'Bico',m:1,cd:0},{n:'Chama',m:1.5,cd:2},{n:'Renascer',m:3,cd:4}], hp:230, atk:58, color:'#ef4444' },
        { id:404, nat:4, n:'TimeKeeper', type:'Trevas', img:'', visual:'‚è≥', s:[{n:'Tique',m:1,cd:0},{n:'Acelerar',m:0,cd:4,ty:'turn'}], hp:220, atk:45, color:'#a855f7' },
        { id:405, nat:4, n:'Paladin', type:'Luz', img:'', visual:'üõ°Ô∏è', s:[{n:'Golpe',m:1,cd:0},{n:'Impor M√£os',m:4,cd:4,ty:'heal'}], hp:300, atk:35, color:'#facc15' },
        // --- 5 ESTRELAS (LEND√ÅRIOS) ---
        { id:501, nat:5, n:'Bahamut', type:'Fogo', img:'', visual:'ü¶ñ', s:[{n:'Garra',m:1.2,cd:0},{n:'Mega Flare',m:2,cd:3},{n:'Apocalipse',m:4,cd:5}], hp:600, atk:100, color:'#ef4444' },
        { id:502, nat:5, n:'Leviathan', type:'√Ågua', img:'', visual:'üêâ', s:[{n:'Mordida',m:1.2,cd:0},{n:'Tuf√£o',m:2,cd:3},{n:'Dil√∫vio',m:4,cd:5}], hp:650, atk:90, color:'#3b82f6' },
        { id:503, nat:5, n:'Zeus', type:'Trov√£o', img:'', visual:'üå©Ô∏è', s:[{n:'Martelo',m:1.2,cd:0},{n:'Rel√¢mpago',m:2.2,cd:3},{n:'Ira Divina',m:4.5,cd:5}], hp:550, atk:110, color:'#f59e0b' },
        { id:504, nat:5, n:'Seraphim', type:'Luz', img:'', visual:'üëº', s:[{n:'Luz',m:1.2,cd:0},{n:'Reden√ß√£o',m:4,cd:3,ty:'heal'},{n:'Milagre',m:0,cd:5,ty:'turn'}], hp:580, atk:85, color:'#facc15' }
    ];

    const DEFAULT_STATE = { 
        mana:5000, gems:200, pot:10, books:2, 
        tix: 2, rare_tix: 1, xp_boosters: 0, grimoires: 0,
        xp: 0, max_xp: 100, p_lvl: 1, 
        maxStage: 1, cleared: [],
        roster:[
            {uid:1, id:101, lvl:1, star:1, skLvl:[1], bonus:{hp:0, atk:0}}, 
            {uid:2, id:102, lvl:1, star:1, skLvl:[1], bonus:{hp:0, atk:0}}, 
            {uid:3, id:201, lvl:1, star:2, skLvl:[1,1], bonus:{hp:0, atk:0}}
        ]
    };
    
    let s = {};
    let tmp = { prep:[], selInv:null, evoTarget:null, evoFodder:[], skillFodder:[], mode:'story', lvl:1 };
    let b = { p:[], e:[], t:'p', idx:0, spd:1, target:null, auto: false };
    let uidCount = 4;
    let currentUser = null;

    const el = id => document.getElementById(id);

    /* --- GAME SYSTEM --- */
    const Game = {
        login: () => {
            const user = el('inp-user').value.trim();
            if(!user) return alert("Digite um nome!");
            currentUser = user;
            const saved = localStorage.getItem(`g_legend_${user}`);
            if(saved) {
                s = JSON.parse(saved);
                if(!s.gems) s.gems = 0; if(!s.cleared) s.cleared = []; if(!s.tix) s.tix = 0;
                if(!s.rare_tix) s.rare_tix = 0; if(!s.xp_boosters) s.xp_boosters = 0; if(!s.grimoires) s.grimoires = 0;
                if(!s.xp) s.xp = 0; if(!s.max_xp) s.max_xp = 100; if(!s.p_lvl) s.p_lvl = 1;
                uidCount = s.roster.reduce((max, r) => Math.max(max, r.uid), 0) + 1;
            } else {
                s = JSON.parse(JSON.stringify(DEFAULT_STATE));
            }
            el('p-name').innerText = user;
            UI.upd(); UI.nav('hub');
        },
        save: () => {
            if(currentUser) localStorage.setItem(`g_legend_${currentUser}`, JSON.stringify(s));
        },
        logout: () => {
            currentUser = null; el('inp-user').value = '';
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
            el('login').classList.add('active');
        }
    };

    /* --- UI --- */
    const UI = {
        nav: scn => { 
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); 
            el(scn).classList.add('active'); UI.upd();
            if(scn === 'expl') Core.renExpl(); if(scn === 'dung') Core.renDung();
        },
        modal: (id,o) => { el(id).className=o?'modal open':'modal'; if(o) UI.upd(); },
        upd: () => {
            const safeSet = (id, val) => { const e = el(id); if(e) e.innerText = val; };
            safeSet('h-mana', s.mana); safeSet('s-mana', s.mana);
            safeSet('h-gems', s.gems); safeSet('s-gems', s.gems);
            safeSet('h-books', s.books); safeSet('d-books', s.books); safeSet('inv-books', s.books);
            safeSet('h-tix', s.tix); safeSet('g-tix', s.tix);
            safeSet('h-rare', s.rare_tix); safeSet('g-rare', s.rare_tix);
            safeSet('h-boost', s.xp_boosters); safeSet('h-grim', s.grimoires); safeSet('sk-grim', s.grimoires);
            safeSet('inv-count', s.roster.length); safeSet('p-lvl', s.p_lvl);
            const pct = Math.min(100, (s.xp / s.max_xp) * 100); 
            const xpBar = el('p-xp-bar'); if(xpBar) xpBar.style.width = `${pct}%`;
        },
        renStars: (star) => {
            let h = '<div class="stars-row">';
            for(let i=0; i<star; i++) h += `<div class="star ${star>=5?'purple':''}">‚òÖ</div>`;
            return h+'</div>';
        },
        getVis: (d) => d.img ? `<img src="${d.img}">` : d.visual,
        renMon: (m) => {
            const d = DB.find(x=>x.id===m.id) || DB[0]; // Fallback
            return `${UI.renStars(m.star)}<div class="mon-visual">${UI.getVis(d)}</div><div class="mon-lvl">${m.lvl}</div>`;
        }
    };

    /* --- CORE LOGIC --- */
    const Core = {
        buy: (type, cost, currency='mana') => {
            if(currency === 'mana' && s.mana < cost) return alert('Mana insuficiente!');
            if(currency === 'gems' && s.gems < cost) return alert('Cristais insuficientes!');
            if(currency === 'mana') s.mana -= cost; else s.gems -= cost;
            if(type === 'pot') s.pot++;
            if(type === 'tix') s.tix++;
            if(type === 'tix_pack') s.tix += 11;
            if(type === 'rare') s.rare_tix++;
            if(type === 'rare_pack') s.rare_tix += 11;
            if(type === 'xpboost') s.xp_boosters++;
            if(type === 'grimoire') s.grimoires++;
            Game.save(); UI.upd(); 
        },
        spin: (type) => {
            let minNat = 1, maxNat = 3;
            if (type === 'common') {
                if(s.tix < 1) return alert('Sem Cristais Comuns! Compre na Loja.');
                s.tix--;
            } else if (type === 'rare') {
                if(s.rare_tix < 1) return alert('Sem Cristais Raros! Compre na Loja.');
                s.rare_tix--;
            }
            UI.upd(); 

            let c=0, cd=el('g-card');
            const t = setInterval(()=>{
                cd.style.transform=`rotateY(${++c*180}deg)`;
                if(c>5) {
                    clearInterval(t);
                    let targetNat = 1;
                    const r = Math.random() * 100;
                    if (type === 'common') {
                        if (r < 70) targetNat = 1; else if (r < 95) targetNat = 2; else targetNat = 3;
                    } else {
                        if (r < 70) targetNat = 3; else if (r < 95) targetNat = 4; else targetNat = 5;
                    }
                    const pool = DB.filter(m => m.nat === targetNat);
                    const h = pool[Math.floor(Math.random()*pool.length)];
                    const initSkills = h.s.map(() => 1);
                    cd.innerHTML=UI.getVis(h); 
                    el('g-res').innerText=`${h.n} ${h.nat}‚òÖ`;
                    s.roster.push({uid:uidCount++, id:h.id, lvl:1, star:h.nat, skLvl:initSkills, bonus:{hp:0, atk:0}});
                    Game.save(); UI.upd();
                }
            }, 150);
        },
        
        openInv: () => { 
            UI.nav('inv'); const grid = el('inv-grid'); grid.innerHTML = '';
            const frag = document.createDocumentFragment();
            const sorted = [...s.roster].sort((a,b) => (b.star - a.star) || (b.lvl - a.lvl));
            sorted.forEach(m => {
                const div = document.createElement('div');
                div.className = `mon-slot ${tmp.selInv===m.uid?'selected':''}`;
                div.onclick = () => Core.selInv(m.uid); div.innerHTML = UI.renMon(m);
                frag.appendChild(div);
            });
            grid.appendChild(frag);
        },
        selInv: (uid) => {
            tmp.selInv = uid; Core.openInv(); 
            const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
            const max = MAX_LVL[m.star] || 50; const isMax = m.lvl>=max;
            if(!m.skLvl) m.skLvl = d.s.map(()=>1); if(!m.bonus) m.bonus = {hp:0, atk:0};

            // Calculate cost: floor(lvl/5) + 1
            const pupCost = Math.floor(m.lvl / 5) + 1;

            let btnPup = `<button class="btn btn-green" onclick="Core.pup(${uid})">Level Up (${pupCost}üß™)</button>`;
            let btnEvo = isMax && m.star<6 ? `<button class="btn btn-purple" onclick="Core.openEvo(${uid})">Evoluir</button>` : '';
            let btnSkl = `<button class="btn btn-blue" onclick="Core.openSkill(${uid})">Skill Up</button>`;
            let btnBook = `<button class="btn btn-gold" onclick="Core.useBook(${uid})">Ler Livro (${s.books}üìñ)</button>`;
            
            el('inv-detail').innerHTML = `<div class="detail-model">${UI.getVis(d)}</div><h1 style="color:${d.color}">${d.n}</h1>
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px">Elemento: ${d.type} | Nat: ${d.nat}‚òÖ</div>
                <div style="margin-bottom:10px">${UI.renStars(m.star)}</div>
                <div class="detail-stats">
                    <div class="stat-row"><span>Lv</span> <b>${m.lvl}/${max}</b></div>
                    <div class="stat-row"><span>Skills</span> <b>${m.skLvl.join('/')}</b></div>
                    <div class="stat-row"><span>B√¥nus</span> <span class="stat-bonus">+${m.bonus.atk} ATK / +${m.bonus.hp} HP</span></div>
                </div>
                <div class="btn-grp">${btnPup} ${btnSkl} ${btnBook} ${btnEvo}</div>`;
        },
        pup: (uid) => {
            const m = s.roster.find(x=>x.uid===uid);
            const cost = Math.floor(m.lvl / 5) + 1;
            if(s.pot<cost) return alert(`Precisa de ${cost} po√ß√µes!`);
            if(m.lvl >= (MAX_LVL[m.star]||50)) return alert("Max Lv!");
            s.pot-=cost; m.lvl++; Game.save(); UI.upd(); Core.selInv(uid);
        },
        useBook: (uid) => {
            if(s.books < 1) return alert("Sem Livros!");
            const m = s.roster.find(x=>x.uid===uid); s.books--; m.bonus.hp += 20; m.bonus.atk += 5;
            Game.save(); UI.upd(); Core.selInv(uid); alert("Livro lido! Status aumentados.");
        },
        
        // --- MAPAS ---
        renExpl: () => {
            const grid = el('expl-grid'); grid.innerHTML = ''; const frag = document.createDocumentFragment();
            for(let i=1; i<=12; i++) {
                const locked = i > s.maxStage;
                const cleared = s.cleared.includes(`story-${i}`);
                const div = document.createElement('div');
                div.className = `stage-btn ${locked?'locked':''} ${i<s.maxStage?'cleared':''}`;
                div.onclick = () => Core.prepFight('story', i);
                let badge = !cleared && !locked ? `<div class="first-clear-badge">50üíé</div>` : '';
                div.innerHTML = `${i<s.maxStage ? '‚úîÔ∏è' : i} ${badge} <div style="font-size:0.6rem; color:#888">N√≠vel ${i}</div>`;
                frag.appendChild(div);
            }
            grid.appendChild(frag);
        },
        renDung: () => {
            const grid = el('dung-grid'); grid.innerHTML = ''; const frag = document.createDocumentFragment();
            for(let i=1; i<=7; i++) {
                const cleared = s.cleared.includes(`dungeon-${i}`);
                const div = document.createElement('div');
                div.className = `stage-btn boss`;
                div.onclick = () => Core.prepFight('dungeon', i);
                let badge = !cleared ? `<div class="first-clear-badge">50üíé</div>` : '';
                div.innerHTML = `üëπ ${badge} <div style="font-size:0.6rem; color:#f87171">Andar ${i}</div>`;
                frag.appendChild(div);
            }
            grid.appendChild(frag);
        },
        prepFight: (mode, level) => {
            tmp.mode = mode; tmp.lvl = level; tmp.prep = []; UI.nav('prep'); Prep.render();
        },

        // --- EVOLUTION & SKILL UP ---
        openEvo: (uid) => { tmp.evoTarget=uid; tmp.evoFodder=[]; el('evo-req-c').innerText=s.roster.find(x=>x.uid===uid).star; el('evo-req-s').innerText=s.roster.find(x=>x.uid===uid).star; UI.modal('m-evo',1); Core.renEvo(); },
        renEvo: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('evo-grid'); grid.innerHTML = ''; const slots = el('evo-slots'); slots.innerHTML = '';
            const fragGrid = document.createDocumentFragment(); const fragSlots = document.createDocumentFragment();
            for(let i=0; i<tgt.star; i++) { 
                const f=tmp.evoFodder[i]; const d = document.createElement('div');
                if(f) { d.className='mon-slot'; d.onclick=()=>Core.togFodder(f); d.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); }
                else { d.className='mat-slot'; d.innerText='Slot'; }
                fragSlots.appendChild(d);
            }
            slots.appendChild(fragSlots);
            s.roster.filter(m=>m.star===tgt.star&&m.uid!==tgt.uid).forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-slot ${tmp.evoFodder.includes(m.uid)?'fodder':''} ${m.id===tgt.id?'skill-up':''}`;
                d.onclick = () => Core.togFodder(m.uid); d.innerHTML = UI.renMon(m);
                fragGrid.appendChild(d);
            });
            grid.appendChild(fragGrid);
            el('btn-do-evo').disabled=tmp.evoFodder.length<tgt.star; el('btn-do-evo').style.opacity=tmp.evoFodder.length<tgt.star?0.5:1;
        },
        togFodder: (uid) => {
            if(tmp.evoFodder.includes(uid)) tmp.evoFodder=tmp.evoFodder.filter(x=>x!==uid); else if(tmp.evoFodder.length<s.roster.find(x=>x.uid===tmp.evoTarget).star) tmp.evoFodder.push(uid);
            Core.renEvo();
        },
        doEvolution: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            let skillUps = 0;
            tmp.evoFodder.forEach(fid => { const f = s.roster.find(x=>x.uid===fid); if(f.id === t.id) skillUps++; });
            s.roster = s.roster.filter(m=>!tmp.evoFodder.includes(m.uid));
            t.star++; t.lvl=1; 
            for(let i=0; i<skillUps; i++) { const rnd = Math.floor(Math.random()*t.skLvl.length); if(t.skLvl[rnd]<5) t.skLvl[rnd]++; }
            Game.save(); UI.modal('m-evo',0); Core.openInv(); alert(`Evolu√≠do! +${skillUps} Skills.`);
        },
        openSkill: (uid) => { tmp.evoTarget=uid; tmp.skillFodder=[]; UI.modal('m-skill',1); Core.renSkill(); },
        renSkill: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('skill-grid'); grid.innerHTML = ''; const slots = el('skill-slots'); slots.innerHTML = '';
            const fragGrid = document.createDocumentFragment(); const fragSlots = document.createDocumentFragment();
            const f = tmp.skillFodder[0]; const dS = document.createElement('div');
            if(f) { dS.className='mon-slot'; dS.onclick=()=>Core.togSkill(f); dS.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); }
            else { dS.className='mat-slot'; dS.innerText='Dupe'; }
            fragSlots.appendChild(dS); slots.appendChild(fragSlots);
            const dupes = s.roster.filter(m => m.id === tgt.id && m.uid !== tgt.uid);
            if(dupes.length) {
                dupes.forEach(m => {
                    const d = document.createElement('div'); d.className = `mon-slot ${tmp.skillFodder.includes(m.uid)?'fodder':''}`;
                    d.onclick = () => Core.togSkill(m.uid); d.innerHTML = UI.renMon(m); fragGrid.appendChild(d);
                });
            } else { grid.innerHTML = '<div style="color:#aaa; padding:10px">Sem duplicatas.</div>'; }
            if(dupes.length) grid.appendChild(fragGrid);
            el('btn-do-skill').disabled = tmp.skillFodder.length === 0; el('btn-do-skill').style.opacity = tmp.skillFodder.length === 0 ? 0.5 : 1;
        },
        togSkill: (uid) => {
            if(tmp.skillFodder.includes(uid)) tmp.skillFodder=[]; else if(tmp.skillFodder.length<1) tmp.skillFodder.push(uid);
            Core.renSkill();
        },
        doSkill: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            s.roster = s.roster.filter(m=>!tmp.skillFodder.includes(m.uid));
            const rnd = Math.floor(Math.random()*t.skLvl.length);
            if(t.skLvl[rnd] < 5) t.skLvl[rnd]++; else { const notMax = t.skLvl.map((l,i)=>({l,i})).filter(x=>x.l<5); if(notMax.length) t.skLvl[notMax[Math.floor(Math.random()*notMax.length)].i]++; }
            Game.save(); UI.modal('m-skill',0); Core.selInv(t.uid); alert(`Skill aprimorada!`);
        },
        useGrimoire: () => {
            if(s.grimoires < 1) return alert("Sem Grim√≥rios!");
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            const notMax = t.skLvl.map((l,i)=>({l,i})).filter(x=>x.l<5);
            if(notMax.length === 0) return alert("Todas as skills est√£o no m√°ximo!");
            s.grimoires--; const rnd = Math.floor(Math.random()*notMax.length); t.skLvl[notMax[rnd].i]++;
            Game.save(); UI.upd(); UI.modal('m-skill',0); Core.selInv(t.uid); alert("Skill Aprimorada com Grim√≥rio!");
        }
    };

    const Prep = {
        render: () => {
            const grid = el('prep-grid'); grid.innerHTML = ''; const frag = document.createDocumentFragment();
            [0,1,2].forEach(i => {
                const uid = tmp.prep[i]; const sl = el(`s${i}`);
                sl.className = uid ? 'prep-slot filled' : 'prep-slot';
                sl.innerHTML = uid ? UI.renMon(s.roster.find(x=>x.uid===uid)) : '+';
            });
            const sorted = [...s.roster].sort((a,b) => (b.star - a.star) || (b.lvl - a.lvl));
            sorted.forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-slot ${tmp.prep.includes(m.uid)?'selected':''}`;
                d.onclick = () => Prep.pick(m.uid); d.innerHTML = UI.renMon(m); frag.appendChild(d);
            });
            grid.appendChild(frag); el('btn-fight').disabled = tmp.prep.length===0;
        },
        pick: (uid) => {
            if(tmp.prep.includes(uid)) tmp.prep=tmp.prep.filter(x=>x!==uid); else if(tmp.prep.length<3) tmp.prep.push(uid);
            Prep.render();
        },
        rem: (i) => { if(tmp.prep[i]) { tmp.prep.splice(i,1); Prep.render(); } }
    };

    /* --- BATALHA --- */
    const Battle = {
        spd: () => { b.spd=b.spd===1?2:1; el('btn-spd').innerText='x'+b.spd; },
        toggleAuto: () => {
            b.auto = !b.auto;
            const btn = el('btn-auto');
            if (b.auto) { btn.classList.add('active'); Battle.turn(); } 
            else btn.classList.remove('active');
        },
        start: () => {
            if(tmp.prep.length===0) return;
            b.spd=1; el('btn-spd').innerText='x1';
            
            // Auto Button Logic
            const btnAuto = el('btn-auto');
            if (s.p_lvl >= 2) {
                btnAuto.style.display = 'flex';
                btnAuto.classList.remove('active');
                b.auto = false;
            } else {
                btnAuto.style.display = 'none';
            }

            b.p = tmp.prep.map((uid,i) => {
                const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
                const sm = 1 + m.lvl*0.1 + (m.star * 0.3);
                const finalHp = Math.floor((d.hp*sm) + m.bonus.hp);
                const finalAtk = Math.floor((d.atk*sm) + m.bonus.atk);
                return {...d, max:finalHp, cur:finalHp, atk:finalAtk, idx:i, side:'p', dead:false, cds:d.s.map(()=>0), skLvl:m.skLvl};
            });

            if(tmp.mode === 'story') {
                // CURVA DE DIFICULDADE (EXPONENCIAL SUAVE)
                // In√≠cio (Nv 1): F√°cil. Fim (Nv 12): Dif√≠cil.
                const diff = 1 + (tmp.lvl * 0.5); 
                b.e = Array(3).fill(0).map((_,i) => {
                    // Pool restrita por n√≠vel (Fases iniciais s√≥ t√™m monstros fracos)
                    const maxNat = Math.min(3, Math.ceil(tmp.lvl/3));
                    const pool = DB.filter(x => x.nat <= maxNat);
                    const base = pool[Math.floor(Math.random()*pool.length)];
                    return {
                        ...base, 
                        max: Math.floor(base.hp * diff), cur: Math.floor(base.hp * diff), atk: Math.floor(base.atk * diff), 
                        idx:i, side:'e', dead:false, cds:base.s.map(()=>0), skLvl:base.s.map(()=>1), isBoss:false
                    };
                });
            } else {
                // CURVA MASMORRA (BOSS)
                const diff = 1 + (tmp.lvl * 1.5);
                const bossPool = DB.filter(x => x.nat >= 3);
                const bossBase = bossPool[Math.floor(Math.random()*bossPool.length)];
                b.e = [{
                    ...bossBase,
                    max: Math.floor(bossBase.hp * 5 * diff), cur: Math.floor(bossBase.hp * 5 * diff), atk: Math.floor(bossBase.atk * 1.5 * diff),
                    idx:0, side:'e', dead:false, cds:bossBase.s.map(()=>0), skLvl:bossBase.s.map(()=>3), isBoss:true
                }];
            }

            b.t='p'; b.idx=0; b.target=null;
            UI.nav('battle'); Battle.draw(); Battle.turn();
        },
        draw: () => {
            el('r-ene').innerHTML = b.e.map(u => Battle.renUnit(u)).join('');
            el('r-pla').innerHTML = b.p.map(u => Battle.renUnit(u)).join('');
        },
        renUnit: (u) => {
            const isAct = !u.dead && ((b.t==='p' && u.side==='p' && b.idx===u.idx) || (b.t==='e' && u.side==='e' && b.idx===u.idx));
            const isTgt = !u.dead && b.target===u.idx && u.side==='e';
            return `
                <div id="${u.side}${u.idx}" class="unit ${u.isBoss?'boss-unit':''} ${u.dead?'dead':''} ${isAct?'actor':''} ${isTgt?'targeted':''}" onclick="Battle.target(${u.idx})">
                    ${isTgt ? '<div class="target-marker">üéØ</div>' : ''}
                    <div class="hp-container"><div class="hp-bar"><div class="hp-fill" style="width:${(u.cur/u.max)*100}%; background:${u.side==='e'?'var(--danger)':'var(--success)'}"></div></div></div>
                    <div class="unit-sprite">${UI.getVis(u)}</div>
                </div>`;
        },
        target: (i) => { if(b.t==='p' && !b.e[i].dead) { b.target = b.target===i ? null : i; Battle.draw(); } },
        turn: () => {
            if(b.e.every(x=>x.dead)) return Battle.end(1); if(b.p.every(x=>x.dead)) return Battle.end(0);
            el('stg').classList.remove('cinematic');
            document.querySelectorAll('.unit').forEach(u => {
                u.classList.remove('actor', 'target-focus', 'hit-anim', 'attacking-p', 'attacking-e');
                if(u.classList.contains('dead')) { u.style.pointerEvents='none'; }
            });
            Battle.draw();
            
            if(b.t==='p') {
                if(b.idx>=b.p.length) { b.t='e'; b.idx=0; return Battle.turn(); }
                const u = b.p[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));

                if (b.auto) {
                    el('btl-ui').classList.remove('active');
                    setTimeout(() => {
                        let skillIdx = 0;
                        const hasS3 = u.s[2] && u.cds[2] === 0;
                        const hasS2 = u.s[1] && u.cds[1] === 0;
                        if (hasS3) skillIdx = 2; else if (hasS2) skillIdx = 1;
                        
                        const skill = u.s[skillIdx];
                        let target = null;

                        if (skill.ty === 'heal') {
                            target = b.p.filter(a => !a.dead).sort((a,b) => (a.cur/a.max) - (b.cur/b.max))[0];
                        } else if (skill.ty === 'turn') {
                            const allies = b.p.filter(a => !a.dead && a.idx !== u.idx);
                            target = allies.length ? allies[Math.floor(Math.random()*allies.length)] : u; 
                        } else {
                            const enemies = b.e.filter(e => !e.dead);
                            target = enemies[Math.floor(Math.random() * enemies.length)];
                        }
                        
                        u.cds[skillIdx] = u.s[skillIdx].cd + 1;
                        Battle.hit(u, target, u.s[skillIdx].m, u.skLvl[skillIdx], u.s[skillIdx].ty);
                        
                    }, 500 / b.spd);
                    return;
                }

                el('act-name').innerText=u.n; el('btl-ui').classList.add('active');
                el('skill-list').innerHTML = u.s.map((sk,i) => {
                    const cd = u.cds[i]>0;
                    let typeText = 'ATQ'; let typeColor = '#f87171';
                    if (sk.ty === 'heal') { typeText = 'CURA'; typeColor = '#4ade80'; }
                    else if (sk.ty === 'turn') { typeText = 'SUP'; typeColor = '#60a5fa'; }
                    
                    return `<div class="skill-btn ${i===0?'main':i===1?'spec':'ulti'} ${cd?'cooldown':''}" onclick="${cd?'':'Battle.act('+i+')'}">
                        <div style="margin-bottom:6px">${i===0?'‚öîÔ∏è':i===1?'‚ö°':'üî•'}</div>
                        ${cd?`<div class="cd-overlay">${u.cds[i]}</div>`:''} 
                        <div style="position:absolute; bottom:6px; font-size:0.6rem; font-weight:900; color:${typeColor}; text-shadow:0 1px 1px black">${typeText}</div>
                        <small>Lv.${u.skLvl[i]}</small>
                    </div>`;
                }).join('');
            } else {
                el('btl-ui').classList.remove('active');
                if(b.idx>=b.e.length) { b.t='p'; b.idx=0; return Battle.turn(); }
                const u = b.e[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));
                setTimeout(() => {
                    const tg = b.p.filter(x=>!x.dead);
                    if(tg.length) {
                        const avail = u.s.map((s,i)=>({i, ...s})).filter(s => u.cds[s.i]===0);
                        const skill = avail.length ? avail[Math.floor(Math.random()*avail.length)] : {i:0, m:1, cd:0};
                        u.cds[skill.i] = skill.cd + 1;
                        Battle.hit(u, tg[Math.floor(Math.random()*tg.length)], skill.m, 1);
                    } else { b.idx++; Battle.turn(); }
                }, 800/b.spd);
            }
        },
        act: (i) => { 
            const u = b.p[b.idx]; u.cds[i] = u.s[i].cd + 1; el('btl-ui').classList.remove('active');
            let t = null; const skill = u.s[i];
            if (skill.ty === 'heal' || skill.ty === 'turn') {
                t = b.p.filter(a => !a.dead).sort((a,b) => (a.cur/a.max) - (b.cur/b.max))[0];
            } else {
                if(b.target!==null && !b.e[b.target].dead) t = b.e[b.target]; 
                else { const l = b.e.filter(x=>!x.dead); if(l.length) t=l[0]; }
            }
            if(t) Battle.hit(u,t,skill.m, u.skLvl[i], skill.ty); else { b.idx++; Battle.turn(); }
            b.target=null; 
        },
        hit: (atk, def, baseMult, skillLvl, type) => {
            el('stg').classList.add('cinematic');
            const aEl = el(`${atk.side}${atk.idx}`); const dEl = el(`${def.side}${def.idx}`);
            aEl.classList.add('actor', atk.side==='p'?'attacking-p':'attacking-e'); dEl.classList.add('target-focus');
            setTimeout(() => {
                aEl.classList.remove('attacking-p','attacking-e'); 
                if (type === 'heal') {
                    const healAmount = Math.floor(atk.atk * baseMult * (1 + (skillLvl-1)*0.2));
                    def.cur = Math.min(def.max, def.cur + healAmount);
                    const txt = document.createElement('div'); txt.className='dmg-txt'; 
                    txt.style.color = '#10b981'; txt.innerText = `+${healAmount}`;
                    dEl.appendChild(txt); setTimeout(()=>txt.remove(), 1000/b.spd);
                    dEl.querySelector('.hp-fill').style.width = `${(def.cur/def.max)*100}%`;
                } else if (type === 'turn') {
                    const txt = document.createElement('div'); txt.className='dmg-txt'; 
                    txt.style.color = '#3b82f6'; txt.style.fontSize = '1.5rem'; txt.innerText = "TURNO EXTRA!";
                    dEl.appendChild(txt); setTimeout(()=>txt.remove(), 1000/b.spd);
                    setTimeout(() => {
                        const enemies = b.e.filter(e => !e.dead);
                        if(enemies.length) {
                            const target = enemies[Math.floor(Math.random()*enemies.length)];
                            Battle.hit(def, target, def.s[0].m, def.skLvl[0]);
                            return; 
                        }
                    }, 500/b.spd);
                } else {
                    dEl.classList.add('hit-anim'); el('app').classList.add('shake-screen'); setTimeout(()=>el('app').classList.remove('shake-screen'), 300);
                    const bonus = (skillLvl - 1) * 0.2; const finalMult = baseMult + bonus; const dmg = Math.floor(atk.atk * finalMult);
                    def.cur = Math.max(0, def.cur-dmg); 
                    const txt = document.createElement('div'); txt.className='dmg-txt'; if(skillLvl > 1) txt.style.color = '#ffff00'; txt.innerText=dmg; dEl.appendChild(txt);
                    setTimeout(()=>txt.remove(), 1000/b.spd);
                    dEl.querySelector('.hp-fill').style.width = `${(def.cur/def.max)*100}%`;
                    if(def.cur===0) { def.dead=true; dEl.classList.remove('target-focus', 'hit-anim'); dEl.classList.add('dead'); }
                }
                if (type !== 'turn') { b.idx++; setTimeout(Battle.turn, 800/b.spd); }
            }, 300/b.spd);
        },
        end: (w) => {
            el('stg').classList.remove('cinematic');
            setTimeout(() => {
                let rewardMsg = "", itemIcon = "", itemQtd = "", gemsAwarded = 0, accXpGain = 0;
                if(w) {
                    const stageKey = `${tmp.mode}-${tmp.lvl}`;
                    const firstClear = !s.cleared.includes(stageKey);
                    if(firstClear) { s.cleared.push(stageKey); gemsAwarded = 50; } else { gemsAwarded = 5; }
                    s.gems += gemsAwarded;
                    let xpBase = 50; if(s.xp_boosters > 0) { xpBase *= 3; s.xp_boosters--; }
                    accXpGain = xpBase; s.xp += accXpGain;
                    if(s.xp >= s.max_xp) { s.p_lvl++; s.xp -= s.max_xp; s.max_xp = Math.floor(s.max_xp * 1.5); s.gems += 100; alert("LEVEL UP! +100 Cristais üíé"); }
                    if(tmp.mode === 'story') {
                        const rMana = 20 * tmp.lvl; const rPot = Math.floor(tmp.lvl / 2) + 1; s.mana += rMana; s.pot += rPot;
                        itemIcon = "üß™"; itemQtd = `+${rPot}`; el('end-mana').innerText = `+${rMana}`; rewardMsg = "VIT√ìRIA!";
                        if(tmp.lvl === s.maxStage) s.maxStage++;
                    } else { s.books++; itemIcon = "üìñ"; itemQtd = "+1"; el('end-mana').innerText = "+0"; rewardMsg = "CHEFE DERROTADO!"; }
                    Game.save();
                } else { rewardMsg = "DERROTA"; itemIcon = "üíÄ"; itemQtd = "-"; el('end-mana').innerText = "+0"; }
                el('end-title').innerText = rewardMsg; el('end-title').style.color = w ? "var(--gold)" : "var(--danger)";
                el('end-item-icon').innerText = itemIcon; el('end-xp').innerText = itemQtd;
                el('end-gems').innerText = w ? `+${gemsAwarded}` : "+0";
                el('end-acc-xp').innerText = w ? `+${accXpGain}` : "+0";
                UI.modal('m-end',1); UI.upd();
            }, 600);
        },
        close: () => { UI.modal('m-end',0); UI.nav('hub'); }
    };
</script>
</body>
</html>

