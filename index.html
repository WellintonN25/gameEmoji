<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guardi√µes: Legends Redux</title>
    <!-- Fontes Premium -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(20, 20, 25, 0.7);
            --bg-panel-solid: #141419;
            --primary: #fbbf24; /* Ouro */
            --primary-glow: rgba(251, 191, 36, 0.5);
            --accent: #3b82f6; /* Azul Magia */
            --accent-glow: rgba(59, 130, 246, 0.5);
            --danger: #ef4444;
            --success: #10b981;
            --rare: #3b82f6;
            --epic: #a855f7;
            --leg: #f59e0b;
            --font-title: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, #31081f 0%, transparent 40%);
            height: 100vh;
            overflow: hidden;
            color: #e2e8f0;
            font-family: var(--font-body);
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 600px; /* Mais estreito para focar na experi√™ncia mobile */
            height: 100%;
            position: relative;
            background: rgba(0,0,0,0.2);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        /* --- UTILIT√ÅRIOS --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
        }

        .text-gold { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
        .text-accent { color: var(--accent); text-shadow: 0 0 10px var(--accent-glow); }
        .title-font { font-family: var(--font-title); text-transform: uppercase; letter-spacing: 1px; }

        /* --- BUTTONS --- */
        .btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            font-family: var(--font-body);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .btn-gold { 
            background: linear-gradient(135deg, #b45309, #f59e0b); 
            border: 1px solid #fcd34d; 
            color: #fff; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-gold:hover { background: linear-gradient(135deg, #d97706, #fbbf24); box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }

        .btn-action-round {
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            backdrop-filter: blur(4px);
        }

        /* --- TELAS --- */
        .screen {
            position: absolute; inset: 0;
            display: none; flex-direction: column;
            z-index: 10;
            opacity: 0; transition: opacity 0.4s ease;
            padding-bottom: 80px; /* Espa√ßo para Dock */
        }
        .screen.active { display: flex; opacity: 1; }
        
        /* LOGIN */
        #login {
            background: url('https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?w=800&q=60') center/cover;
            align-items: center; justify-content: center;
            z-index: 50; /* Above dock */
            padding-bottom: 0;
        }
        .login-card {
            padding: 40px 30px;
            width: 90%; max-width: 380px;
            text-align: center;
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: rgba(0, 0, 0, 0.75);
        }
        .login-input {
            width: 100%; padding: 15px; margin: 25px 0;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 8px;
            font-size: 1.1rem; text-align: center;
            font-family: var(--font-title);
            transition: 0.3s;
        }
        .login-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 15px var(--primary-glow); background: rgba(0,0,0,0.5); }

        /* HUB */
        #hub { 
            background: url('https://images.unsplash.com/photo-1542256851-e1293fb84338?w=800&q=60') center/cover;
            padding-bottom: 90px;
        }
        .hub-header {
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .profile-section { display: flex; align-items: center; gap: 15px; }
        .avatar-frame {
            width: 55px; height: 55px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            background: #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 0 15px var(--primary-glow);
        }
        .player-info h3 { margin: 0; font-size: 1.1rem; line-height: 1; }
        .level-pill {
            font-size: 0.7rem; background: var(--primary); color: #000;
            padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px;
            vertical-align: middle;
        }
        .xp-container {
            width: 100px; height: 4px; background: rgba(255,255,255,0.2);
            margin-top: 6px; border-radius: 2px; overflow: hidden;
        }
        .xp-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        .currency-pills { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
        .currency {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;
            display: flex; align-items: center; gap: 6px;
        }

        .hub-grid {
            flex: 1; padding: 20px;
            display: grid; gap: 15px; align-content: center;
            grid-template-columns: 1fr;
        }
        .feature-card {
            height: 80px;
            display: flex; align-items: center; padding: 0 20px; gap: 20px;
            cursor: pointer; position: relative; overflow: hidden;
            transition: 0.3s;
        }
        .feature-card::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transform: translateX(-100%); transition: 0.5s;
        }
        .feature-card:hover::before { transform: translateX(100%); }
        .feature-card:hover { border-color: var(--primary); transform: scale(1.02); }
        .feature-icon { font-size: 2rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        .feature-texts h4 { font-size: 1.1rem; margin-bottom: 2px; }
        .feature-texts p { font-size: 0.75rem; color: #94a3b8; }

        /* DOCK NAVIGATION */
        .dock {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 85px;
            background: rgba(5, 5, 10, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; z-index: 100;
            backdrop-filter: blur(10px);
        }
        .dock-item {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            color: #64748b; font-size: 0.7rem; font-weight: 700;
            cursor: pointer; transition: 0.3s; width: 60px;
        }
        .dock-item.active, .dock-item:hover { color: #e2e8f0; }
        .dock-icon { font-size: 1.6rem; transition: 0.3s; position: relative; }
        .dock-item:hover .dock-icon { transform: translateY(-5px); text-shadow: 0 0 15px currentColor; }
        .dock-item.main .dock-icon { 
            font-size: 2.2rem; 
            background: linear-gradient(135deg, var(--bg-dark), #1e293b);
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-top: -30px; border: 2px solid var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
            color: #fff;
        }

        /* --- LISTAS E GRIDS --- */
        .page-header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 15px;
        }
        .page-title { font-family: var(--font-title); font-size: 1.4rem; color: #fff; }
        
        .scroll-container {
            flex: 1; overflow-y: auto; padding: 20px;
            background: linear-gradient(to bottom, #0f172a, #020617);
        }

        /* MONSTER CARDS (Used in Inv, Prep, etc) */
        .mon-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); 
            gap: 10px; padding: 5px; 
        }
        .mon-card {
            aspect-ratio: 1;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            position: relative; cursor: pointer;
            transition: 0.2s; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .mon-card.selected { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); }
        .mon-card.fodder { opacity: 0.4; filter: grayscale(1); border-color: var(--danger); }
        .mon-visual { font-size: 2.2rem; z-index: 1; }
        .mon-stars { 
            position: absolute; top: 2px; left: 0; width: 100%; 
            display: flex; justify-content: center; gap: 1px;
            z-index: 2;
        }
        .star-dot { font-size: 0.5rem; color: var(--primary); }
        .star-dot.purple { color: var(--epic); }
        .mon-lvl { 
            position: absolute; bottom: 0; right: 0; 
            background: rgba(0,0,0,0.8); color: white; 
            font-size: 0.6rem; padding: 2px 4px; 
            border-top-left-radius: 4px; font-weight: bold;
        }

        /* --- BATTLE ARENA --- */
        #battle { background: url('https://images.unsplash.com/photo-1518066000714-58c45f1a2c0a?w=800&q=60') center/cover; }
        .battle-stage {
            flex: 1; position: relative;
            perspective: 800px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .floor-plane {
            position: absolute; width: 200%; height: 100%; left: -50%; top: 20%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.6) 0%, transparent 70%);
            transform: rotateX(60deg); pointer-events: none;
        }
        
        .battle-row {
            display: flex; justify-content: center; gap: 25px;
            min-height: 100px; padding: 20px; z-index: 5;
            transition: 0.5s;
        }
        .battle-row.enemies { align-items: flex-end; margin-bottom: 20px; }
        .battle-row.players { align-items: flex-start; }

        .unit {
            width: 80px; height: 80px;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }
        .unit.boss { width: 140px; height: 140px; }
        .unit-sprite {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
            transition: 0.2s;
        }
        .boss .unit-sprite { font-size: 6rem; }
        
        /* HP BAR */
        .hp-wrapper {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 120%; height: 8px;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px; overflow: hidden;
        }
        .hp-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .enemies .hp-fill { background: var(--danger); }

        /* Battle Animations */
        .unit.dead { opacity: 0; transform: translateY(20px) scale(0.5); pointer-events: none; }
        .unit.hit-anim { animation: shake 0.4s; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(3); }
        .unit.attacking-p { transform: translateY(-60px) scale(1.2); z-index: 10; }
        .unit.attacking-e { transform: translateY(60px) scale(1.2); z-index: 10; }
        @keyframes shake { 0%, 100% {transform:translateX(0)} 25% {transform:translateX(-5px)} 75% {transform:translateX(5px)} }

        /* Floating Damage Text */
        .dmg-float {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            font-size: 2rem; font-weight: 900; color: #fff;
            text-shadow: 2px 2px 0 #000;
            animation: floatUp 0.8s forwards; pointer-events: none; z-index: 100;
            font-family: var(--font-title);
        }
        @keyframes floatUp { 0% {opacity:0; transform:translate(-50%, 0) scale(0.5)} 20% {opacity:1; transform:translate(-50%, -30px) scale(1.5)} 100% {opacity:0; transform:translate(-50%, -60px) scale(1)} }

        /* BATTLE UI */
        .battle-ui {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            transform: translateY(110%); transition: 0.4s;
            display: flex; flex-direction: column; gap: 10px;
        }
        .battle-ui.active { transform: translateY(0); }
        .skill-bar { display: flex; justify-content: center; gap: 15px; }
        .skill-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: #1e293b; border: 2px solid #475569;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: 0.2s;
        }
        .skill-btn:active { transform: scale(0.9); }
        .skill-btn.main { border-color: var(--primary); }
        .skill-btn.ult { border-color: var(--epic); }
        .skill-btn.cd { filter: grayscale(1); opacity: 0.6; cursor: default; }
        .skill-icon { font-size: 1.8rem; }
        .skill-cd-ovl { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.7); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.5rem;
        }
        
        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box {
            width: 100%; max-width: 400px;
            background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
            text-align: center;
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        /* GACHA ANIMATION */
        .gacha-card {
            width: 160px; height: 240px; margin: 0 auto 20px;
            background: #0f172a; border: 3px solid #334155; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; color: #fff;
            position: relative; 
            transform-style: preserve-3d; transition: 0.6s;
        }
        .gacha-card.reveal { animation: flipReveal 1s ease forwards; }
        @keyframes flipReveal { 0% {transform: rotateY(0)} 50% {transform: rotateY(90deg) scale(0.8)} 100% {transform: rotateY(0) scale(1.1); border-color: var(--primary); box-shadow: 0 0 30px var(--primary);} }
        .flash-screen { animation: flashWhite 0.5s; }
        @keyframes flashWhite { 0% {background:rgba(255,255,255,0)} 50% {background:rgba(255,255,255,0.8)} 100% {background:rgba(255,255,255,0)} }

        /* RUNE STYLES */
        .rune-grid-item {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            cursor: pointer;
        }
        .rune-icon {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); border-radius: 6px;
            font-size: 1.2rem; border: 1px solid rgba(255,255,255,0.1);
        }
        .rune-rare { border-color: var(--rare); color: var(--rare); box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.2); }
        .rune-epic { border-color: var(--epic); color: var(--epic); box-shadow: inset 0 0 10px rgba(168, 85, 247, 0.2); }
        .rune-leg { border-color: var(--leg); color: var(--leg); box-shadow: inset 0 0 10px rgba(245, 158, 11, 0.2); animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% {box-shadow: 0 0 0 rgba(245,158,11,0)} 50% {box-shadow: 0 0 10px rgba(245,158,11,0.5)} 100% {box-shadow: 0 0 0 rgba(245,158,11,0)} }

        /* STAGE SELECTION */
        .map-node {
            background: rgba(30, 41, 59, 0.9);
            margin-bottom: 10px; padding: 15px; border-radius: 12px;
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; border: 1px solid transparent;
        }
        .map-node:hover { border-color: var(--primary); background: #334155; }
        .map-node.locked { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="flash-layer" style="position:absolute;inset:0;pointer-events:none;z-index:999"></div>

    <!-- TELA LOGIN -->
    <div id="login" class="screen active">
        <div class="login-card glass-panel">
            <h1 class="title-font text-gold" style="font-size: 3rem; margin-bottom: 5px;">Guardi√µes</h1>
            <h2 class="title-font text-accent" style="font-size: 1.2rem; letter-spacing: 5px; margin-bottom: 30px;">Legends</h2>
            
            <input type="text" id="inp-user" class="login-input" placeholder="Nome do Her√≥i" maxlength="12">
            
            <button class="btn btn-gold" style="width: 100%; height: 50px; font-size: 1.1rem;" onclick="Game.login()">
                <span>Entrar no Mundo</span>
            </button>
        </div>
    </div>

    <!-- TELA HUB -->
    <div id="hub" class="screen">
        <div class="hub-header">
            <div class="profile-section">
                <div class="avatar-frame">üõ°Ô∏è</div>
                <div class="player-info">
                    <h3 class="title-font"><span id="p-name">Player</span><span class="level-pill">Lv.<span id="p-lvl">1</span></span></h3>
                    <div class="xp-container"><div id="p-xp-bar" class="xp-fill"></div></div>
                </div>
            </div>
            <div class="currency-pills">
                <div class="currency text-accent">üí† <span id="h-mana">0</span></div>
                <div class="currency text-gold">üíé <span id="h-gems">0</span></div>
            </div>
        </div>

        <div class="hub-grid">
            <div class="feature-card glass-panel" onclick="UI.nav('expl')">
                <div class="feature-icon">üó∫Ô∏è</div>
                <div class="feature-texts">
                    <h4 class="title-font text-gold">Explorar</h4>
                    <p>Campanha Principal</p>
                </div>
            </div>
            
            <div class="feature-card glass-panel" onclick="UI.nav('dung')">
                <div class="feature-icon">üè∞</div>
                <div class="feature-texts">
                    <h4 class="title-font text-danger" style="color:#f87171">Masmorra</h4>
                    <p>Desafios & Chefes</p>
                </div>
            </div>
            
            <div class="feature-card glass-panel" onclick="Core.openRuneBag()">
                <div class="feature-icon">üéí</div>
                <div class="feature-texts">
                    <h4 class="title-font text-accent" style="color:#a855f7">Runas</h4>
                    <p>Gerenciar Invent√°rio</p>
                </div>
            </div>
        </div>

        <!-- Dock Navigation -->
        <div class="dock">
            <div class="dock-item" onclick="Core.openInv()">
                <div class="dock-icon">üê∫</div>
                <span>Monstros</span>
            </div>
            <div class="dock-item main" onclick="UI.modal('m-gacha',1)">
                <div class="dock-icon">‚ú®</div>
            </div>
            <div class="dock-item" onclick="UI.modal('m-shop',1)">
                <div class="dock-icon">üõí</div>
                <span>Loja</span>
            </div>
            <div class="dock-item" onclick="Game.logout()">
                <div class="dock-icon">üö™</div>
                <span>Sair</span>
            </div>
        </div>

        <!-- Hidden counters for JS compatibility -->
        <div style="display:none">
            <span id="h-tix">0</span><span id="g-tix">0</span>
            <span id="h-rare">0</span><span id="g-rare">0</span>
            <span id="h-grim">0</span><span id="sk-grim">0</span>
            <span id="h-boost">0</span>
        </div>
    </div>

    <!-- TELA EXPLORATION -->
    <div id="expl" class="screen">
        <div class="page-header">
            <button class="btn-action-round" onclick="UI.nav('hub')">‚ùÆ</button>
            <span class="page-title">Mapa Mundi</span>
        </div>
        <div id="expl-regions" class="scroll-container">
            <!-- JS will populate -->
        </div>
        <div id="expl-stages-list" class="scroll-container" style="display:none">
            <button class="btn" style="margin-bottom:15px" onclick="Core.backToExplRegions()">‚ùÆ Voltar Regi√µes</button>
            <div id="expl-list-container"></div>
        </div>
    </div>

    <!-- TELA DUNGEON -->
    <div id="dung" class="screen">
        <div class="page-header">
            <button class="btn-action-round" onclick="UI.nav('hub')">‚ùÆ</button>
            <span class="page-title">Masmorras</span>
        </div>
        <div id="dung-select" class="scroll-container" style="display:flex; flex-direction:column; gap:15px; align-items:center;">
             <div class="feature-card glass-panel" style="width:100%" onclick="Core.selectDung('golem')">
                <div class="feature-icon">üóø</div>
                <div class="feature-texts">
                    <h4 class="title-font text-success" style="color:#84cc16">Gigante</h4>
                    <p>Drops: HP & DEF</p>
                </div>
            </div>
            <div class="feature-card glass-panel" style="width:100%" onclick="Core.selectDung('dragon')">
                <div class="feature-icon">üêâ</div>
                <div class="feature-texts">
                    <h4 class="title-font text-danger">Drag√£o</h4>
                    <p>Drops: ATK & CRIT</p>
                </div>
            </div>
        </div>
        <div id="dung-floors" class="scroll-container" style="display:none">
            <button class="btn" style="margin-bottom:15px" onclick="Core.backToDungSelect()">‚ùÆ Voltar</button>
            <div id="dung-list-container"></div>
        </div>
    </div>

    <!-- TELA INVENTORY -->
    <div id="inv" class="screen">
        <div class="page-header">
            <button class="btn-action-round" onclick="UI.nav('hub')">‚ùÆ</button>
            <span class="page-title">Cole√ß√£o (<span id="inv-count">0</span>)</span>
        </div>
        <div class="scroll-container" style="padding:10px;">
            <div id="inv-grid" class="mon-grid"></div>
        </div>
        <!-- Detail Panel (Fixed Bottom) -->
        <div id="inv-detail" class="glass-panel" style="height:45%; border-radius: 20px 20px 0 0; padding:20px; overflow-y:auto; border-bottom:0;">
            <div style="color:#aaa; text-align:center; margin-top:50px">Selecione um monstro</div>
        </div>
    </div>

    <!-- TELA RUNAS -->
    <div id="rune_bag" class="screen">
        <div class="page-header">
            <button class="btn-action-round" onclick="UI.nav('hub')">‚ùÆ</button>
            <span class="page-title">Invent√°rio de Runas</span>
        </div>
        <div id="rune-bag-grid" class="scroll-container" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(90px,1fr)); gap:10px; align-content:start;"></div>
    </div>

    <!-- TELA PREP -->
    <div id="prep" class="screen">
        <div class="page-header" style="justify-content: space-between;">
            <div style="display:flex; align-items:center; gap:10px">
                <button class="btn-action-round" onclick="UI.nav('hub')">‚ùÆ</button>
                <span class="page-title">Equipe</span>
            </div>
            <button id="btn-fight" class="btn btn-gold" onclick="Battle.start(0)">LUTAR</button>
            <button id="btn-farm" class="btn" style="background:#10b981; display:none" onclick="Battle.start(5)">Auto x5</button>
        </div>
        
        <div style="padding:20px; display:flex; justify-content:center; gap:20px; background:rgba(0,0,0,0.3);">
            <div id="s0" class="mon-card" style="width:70px; height:70px; border-style:dashed;" onclick="Prep.rem(0)">+</div>
            <div id="s1" class="mon-card" style="width:70px; height:70px; border-style:dashed;" onclick="Prep.rem(1)">+</div>
            <div id="s2" class="mon-card" style="width:70px; height:70px; border-style:dashed;" onclick="Prep.rem(2)">+</div>
        </div>
        
        <div class="scroll-container">
            <div id="prep-grid" class="mon-grid"></div>
        </div>
    </div>

    <!-- TELA BATTLE -->
    <div id="battle" class="screen">
        <div id="farm-ui" class="farm-status" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); padding:5px 15px; border-radius:20px; color:#10b981; font-weight:bold; display:none; z-index:100; border:1px solid #10b981;">AUTO x<span id="farm-count">0</span></div>
        
        <button id="btn-spd" class="btn-action-round" style="position:absolute; top:20px; right:20px; z-index:100;" onclick="Battle.spd()">x1</button>
        <button id="btn-auto" class="btn-action-round" style="position:absolute; top:20px; right:75px; z-index:100; font-size:0.7rem; display:none" onclick="Battle.toggleAuto()">AUTO</button>

        <div id="stg" class="battle-stage">
            <div class="floor-plane"></div>
            <div class="battle-row enemies" id="r-ene"></div>
            <div class="battle-row players" id="r-pla"></div>
        </div>

        <div id="btl-ui" class="battle-ui glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:bold; color:var(--accent); font-size:1.1rem;" id="act-name">Heroi</div>
                <div style="font-size:0.8rem; color:#aaa;" id="act-target">Sua Vez</div>
            </div>
            <div id="skill-list" class="skill-bar"></div>
        </div>
    </div>

    <!-- --- MODALS --- -->
    
    <!-- MODAL GACHA -->
    <div id="m-gacha" class="modal-overlay">
        <div class="modal-box gacha-box">
            <h2 class="title-font text-gold" style="margin-bottom:20px;">Portal de Invoca√ß√£o</h2>
            <div id="g-card" class="gacha-card">?</div>
            <h3 id="g-res" style="color:#aaa; min-height:1.5em; margin-bottom:20px;">...</h3>
            
            <div id="gacha-controls" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="btn" style="flex-direction:column; padding:15px 5px;" onclick="Core.spin('common')">
                    <span style="font-size:1.5rem">üé´</span>
                    <span>Comum</span>
                </button>
                <button class="btn" style="flex-direction:column; padding:15px 5px; border-color:var(--primary);" onclick="Core.spin('rare')">
                    <span style="font-size:1.5rem">üéüÔ∏è</span>
                    <span class="text-gold">Raro</span>
                </button>
            </div>
            <button class="btn" onclick="UI.modal('m-gacha',0)">Fechar</button>
        </div>
    </div>

    <!-- MODAL CONFIRM -->
    <div id="m-confirm" class="modal-overlay">
        <div class="modal-box">
            <h3 id="confirm-msg" style="margin-bottom:20px;">Tem certeza?</h3>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn" style="background:var(--danger); border:none;" onclick="UI.modal('m-confirm',0)">N√£o</button>
                <button class="btn" style="background:var(--success); border:none;" onclick="Core.execConfirm()">Sim</button>
            </div>
        </div>
    </div>

    <!-- MODAL LEVEL/EVO/SKILL (Reusing Generic Structure logic from JS) -->
    <!-- We need specific IDs for JS to inject content -->
    <div id="m-evo" class="modal-overlay">
        <div class="modal-box">
            <h2 class="title-font text-epic" style="color:var(--epic); margin-bottom:10px;">Evolu√ß√£o</h2>
            <p style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">Requer: <span id="evo-req-c">0</span> monstros <span id="evo-req-s">0</span>‚òÖ</p>
            <div id="evo-slots" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;"></div>
            <div style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; margin-bottom:15px;">
                <div id="evo-grid" class="mon-grid"></div>
            </div>
            <button id="btn-do-evo" class="btn" style="width:100%; background:var(--epic); margin-bottom:10px;" onclick="Core.doEvolution()">EVOLUIR</button>
            <button class="btn" onclick="UI.modal('m-evo',0)">Cancelar</button>
        </div>
    </div>

    <div id="m-skill" class="modal-overlay">
        <div class="modal-box">
            <h2 class="title-font text-accent" style="margin-bottom:10px;">Skill Up</h2>
            <button class="btn btn-gold" style="margin-bottom:15px;" onclick="Core.useGrimoire()">Usar Grim√≥rio</button>
            <div id="skill-slots" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
            <div style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; margin-bottom:15px;">
                <div id="skill-grid" class="mon-grid"></div>
            </div>
            <button id="btn-do-skill" class="btn" style="width:100%; background:var(--accent); margin-bottom:10px;" onclick="Core.doSkill()">Aprimorar</button>
            <button class="btn" onclick="UI.modal('m-skill',0)">Cancelar</button>
        </div>
    </div>

    <!-- MODAL SHOP -->
    <div id="m-shop" class="modal-overlay">
        <div class="modal-box" style="max-width:500px;">
            <h2 class="title-font text-gold" style="margin-bottom:10px;">Mercado Negro</h2>
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px; font-weight:bold;">
                <span class="text-accent">üí† <span id="s-mana">0</span></span>
                <span class="text-gold">üíé <span id="s-gems">0</span></span>
            </div>
            <div id="shop-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            <button class="btn" style="margin-top:20px; width:100%" onclick="UI.modal('m-shop',0)">Sair</button>
        </div>
    </div>

    <!-- MODAL END BATTLE -->
    <div id="m-end" class="modal-overlay">
        <div class="modal-box flash-screen">
            <h2 id="end-title" class="title-font" style="font-size:2rem; margin-bottom:20px;">VIT√ìRIA</h2>
            <div style="display:flex; justify-content:space-around; margin-bottom:20px; font-size:1.2rem; font-weight:bold;">
                <div>üí† <div id="end-mana">+0</div></div>
                <div>üíé <div id="end-gems">+0</div></div>
                <div><span id="end-item-icon"></span> <div id="end-xp">+0</div></div>
            </div>
            <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">XP Conta: <span id="end-acc-xp">0</span></div>
            <div id="rune-drop-msg" style="color:var(--epic); font-weight:bold; margin-bottom:20px;"></div>
            <button class="btn btn-gold" style="width:100%" onclick="Battle.close()">Continuar</button>
        </div>
    </div>

    <!-- MODAL RUNE SELECT -->
    <div id="m-rune" class="modal-overlay">
        <div class="modal-box">
            <h2 class="title-font">Gerenciar Runas</h2>
            <div id="rune-list" style="margin-top:15px; text-align:left;"></div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="UI.modal('m-rune',0)">Fechar</button>
        </div>
    </div>

    <!-- MODAL RUNE UPGRADE -->
    <div id="m-rune-up" class="modal-overlay">
        <div class="modal-box" id="rune-up-content">
            <h2 class="title-font text-gold">Reforjar Runa</h2>
            <div style="margin:20px auto; width:80px; height:80px; display:flex; align-items:center; justify-content:center; border:2px solid #555; border-radius:10px; font-size:2rem;" id="up-rune-icon"></div>
            <div id="up-rune-main" style="font-weight:bold; font-size:1.2rem; margin-bottom:10px;"></div>
            <div id="up-rune-subs" style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; text-align:left; font-size:0.9rem; margin-bottom:15px;"></div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:0.9rem;">
                <span>Custo: <span id="up-cost" class="text-accent">0</span></span>
                <span>Chance: <span id="up-chance">100%</span></span>
            </div>

            <button class="btn btn-gold" style="width:100%" onclick="Core.doUpgrade()">Melhorar</button>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="UI.modal('m-rune-up',0)">Cancelar</button>
        </div>
    </div>

</div>

<!-- LOGIC SCRIPT (Preserved from Original) -->
<script>
    const MAX_LVL = { 1:5, 2:10, 3:20, 4:30, 5:40, 6:50 };
    
    const EXPL_REGIONS = [
        { id: 1, name: "Floresta Slime", icon: "üå≤", color: "#10b981", type: "Natureza" },
        { id: 2, name: "Vulc√£o Ativo", icon: "üåã", color: "#ef4444", type: "Fogo" },
        { id: 3, name: "Ru√≠nas Antigas", icon: "üèõÔ∏è", color: "#fbbf24", type: "Terra" },
        { id: 4, name: "Pico Tempestade", icon: "‚ö°", color: "#a855f7", type: "Vento" },
        { id: 5, name: "Castelo Obscuro", icon: "üëª", color: "#64748b", type: "Trevas" },
        { id: 6, name: "Santu√°rio de Luz", icon: "‚ú®", color: "#facc15", type: "Luz" },
        { id: 7, name: "Dimens√£o Caos", icon: "üåå", color: "#3b82f6", type: "Caos" }
    ];

    const SHOP_DB = [
        { id: 'pot', name: 'Po√ß√£o XP', desc: 'Sobe n√≠vel instant.', cost: 100, currency: 'mana', icon: 'üß™' },
        { id: 'xpboost', name: 'Booster XP', desc: '3x XP (pr√≥x. luta)', cost: 50, currency: 'gems', icon: 'üöÄ' },
        { id: 'grimoire', name: 'Grim√≥rio', desc: 'Sobe Skill aleat√≥ria', cost: 500, currency: 'gems', icon: 'üìö' },
        { id: 'tix', name: 'Ticket Comum', desc: 'Invoca 1-3 Estrelas', cost: 1000, currency: 'mana', icon: 'üé´' },
        { id: 'tix_pack', name: 'Pack Comum', desc: '11 Tickets Comuns', cost: 10000, currency: 'mana', icon: 'üì¶' },
        { id: 'rare', name: 'Ticket Raro', desc: 'Invoca 3-5 Estrelas', cost: 100, currency: 'gems', icon: 'üéüÔ∏è' },
        { id: 'rare_pack', name: 'Pack Raro', desc: '11 Tickets Raros', cost: 1000, currency: 'gems', icon: 'üëë' }
    ];

    const DB = [
        { id:101, nat:1, n:'Slime', type:'√Ågua', img:'', visual:'üíß', s:[{n:'Pancada',m:1,cd:0}], hp:50, atk:10, color:'#3b82f6' },
        { id:102, nat:1, n:'Wisp', type:'Fogo', img:'', visual:'üî•', s:[{n:'Queimar',m:1,cd:0}], hp:45, atk:12, color:'#ef4444' },
        { id:103, nat:1, n:'Rat', type:'Terra', img:'', visual:'üêÄ', s:[{n:'Mordida',m:1,cd:0}], hp:55, atk:11, color:'#10b981' },
        { id:201, nat:2, n:'Goblin', type:'Terra', img:'', visual:'üë∫', s:[{n:'Clava',m:1,cd:0},{n:'F√∫ria',m:1.3,cd:2}], hp:80, atk:18, color:'#10b981' },
        { id:202, nat:2, n:'Bat', type:'Vento', img:'', visual:'ü¶á', s:[{n:'Suga Sangue',m:1,cd:0},{n:'S√¥nico',m:1.2,cd:2}], hp:70, atk:20, color:'#a855f7' },
        { id:203, nat:2, n:'Wolf', type:'√Ågua', img:'', visual:'üê∫', s:[{n:'Mordida',m:1,cd:0},{n:'Uivo',m:1.3,cd:2}], hp:85, atk:19, color:'#3b82f6' },
        { id:204, nat:2, n:'Dryad', type:'Natureza', img:'', visual:'üßö', s:[{n:'Espinhos',m:1,cd:0},{n:'Curar',m:2,cd:3,ty:'heal'}], hp:90, atk:15, color:'#10b981' },
        { id:301, nat:3, n:'Golem', type:'Terra', img:'', visual:'üóø', s:[{n:'Esmagar',m:1,cd:0},{n:'Pedregulho',m:1.3,cd:2},{n:'Terremoto',m:2.8,cd:4}], hp:120, atk:22, color:'#10b981' },
        { id:302, nat:3, n:'Mage', type:'Trov√£o', img:'', visual:'üßô', s:[{n:'Raio',m:1,cd:0},{n:'Choque',m:1.5,cd:2},{n:'Trov√£o',m:3,cd:4}], hp:100, atk:30, color:'#f59e0b' },
        { id:303, nat:3, n:'Kraken', type:'√Ågua', img:'', visual:'üêô', s:[{n:'Tent√°culo',m:1,cd:0},{n:'Jato',m:1.4,cd:2},{n:'Tsunami',m:2.5,cd:4}], hp:110, atk:24, color:'#3b82f6' },
        { id:304, nat:3, n:'Oracle', type:'Luz', img:'', visual:'üîÆ', s:[{n:'Orbe',m:1,cd:0},{n:'Grande Cura',m:3,cd:3,ty:'heal'}], hp:105, atk:18, color:'#facc15' },
        { id:401, nat:4, n:'Sylph', type:'Vento', img:'', visual:'ü¶Ö', s:[{n:'Bico',m:1,cd:0},{n:'Ventania',m:1.4,cd:2},{n:'Tornado',m:1.3,cd:4, ty:'aoe'}], hp:160, atk:22, color:'#a855f7' },
        { id:402, nat:4, n:'Raijin', type:'Trov√£o', img:'', visual:'‚ö°', s:[{n:'Choque',m:1,cd:0},{n:'Raio',m:1.6,cd:2},{n:'Tempestade',m:1.4,cd:4, ty:'aoe'}], hp:160, atk:24, color:'#f59e0b' },
        { id:403, nat:4, n:'Phoenix', type:'Fogo', img:'', visual:'üê¶‚Äçüî•', s:[{n:'Bico',m:1,cd:0},{n:'Chama',m:1.1,cd:2, ty:'aoe'},{n:'Renascer',m:3,cd:4}], hp:140, atk:25, color:'#ef4444' },
        { id:404, nat:4, n:'TimeKeeper', type:'Trevas', img:'', visual:'‚è≥', s:[{n:'Tique',m:1,cd:0},{n:'Acelerar',m:0,cd:4,ty:'turn'}], hp:140, atk:20, color:'#a855f7' },
        { id:405, nat:4, n:'Paladin', type:'Luz', img:'', visual:'üõ°Ô∏è', s:[{n:'Golpe',m:1,cd:0},{n:'Impor M√£os',m:4,cd:4,ty:'heal'}], hp:180, atk:18, color:'#facc15' },
        { id:501, nat:5, n:'Bahamut', type:'Fogo', img:'', visual:'ü¶ñ', s:[{n:'Garra',m:1.2,cd:0},{n:'Mega Flare',m:1.4,cd:3, ty:'aoe'},{n:'Apocalipse',m:1.8,cd:5, ty:'aoe'}], hp:180, atk:25, color:'#ef4444' },
        { id:502, nat:5, n:'Leviathan', type:'√Ågua', img:'', visual:'üêâ', s:[{n:'Mordida',m:1.2,cd:0},{n:'Tuf√£o',m:1.4,cd:3, ty:'aoe'},{n:'Dil√∫vio',m:1.8,cd:5, ty:'aoe'}], hp:200, atk:22, color:'#3b82f6' },
        { id:503, nat:5, n:'Zeus', type:'Trov√£o', img:'', visual:'üå©Ô∏è', s:[{n:'Martelo',m:1.2,cd:0},{n:'Rel√¢mpago',m:1.4,cd:3, ty:'aoe'},{n:'Ira Divina',m:1.8,cd:5, ty:'aoe'}], hp:170, atk:28, color:'#f59e0b' },
        { id:504, nat:5, n:'Seraphim', type:'Luz', img:'', visual:'üëº', s:[{n:'Luz',m:1.2,cd:0},{n:'Reden√ß√£o',m:4,cd:3,ty:'heal'},{n:'Milagre',m:0,cd:5,ty:'turn'}], hp:180, atk:22, color:'#facc15' },
        { id:901, nat:6, n:'Golem Ancestral', type:'Terra', img:'', visual:'üóø', s:[{n:'Esmagar',m:1,cd:0},{n:'Pele de Pedra',m:0,cd:3,ty:'turn'}], hp:500, atk:15, color:'#a3e635' },
        { id:902, nat:6, n:'Drag√£o do Caos', type:'Fogo', img:'', visual:'üêâ', s:[{n:'Baforada',m:1.5,cd:0},{n:'Cataclismo',m:2.5,cd:4,ty:'aoe'}], hp:400, atk:40, color:'#f87171' }
    ];

    const DEFAULT_STATE = { 
        mana:5000, gems:200, pot:10, 
        tix: 2, rare_tix: 1, xp_boosters: 0, grimoires: 0,
        xp: 0, max_xp: 100, p_lvl: 1, 
        maxStage: 1, cleared: [],
        runes_inv: [], 
        roster:[
            {uid:1, id:101, lvl:1, star:1, skLvl:[1], runes:[null,null,null,null]}, 
            {uid:2, id:102, lvl:1, star:1, skLvl:[1], runes:[null,null,null,null]}, 
            {uid:3, id:201, lvl:1, star:2, skLvl:[1,1], runes:[null,null,null,null]}
        ]
    };
    
    let s = {};
    let tmp = { prep:[], selInv:null, evoTarget:null, evoFodder:[], skillFodder:[], mode:'story', lvl:1, selRuneSlot:null, dungType: null, upRune: null, explRegion: null };
    let b = { p:[], e:[], t:'p', idx:0, spd:1, target:null, auto: false, farmRuns: 0, skillPending: null };
    let uidCount = 4;
    let runeIdCount = 1;
    let currentUser = null;
    let pendingAction = null; 

    const el = id => document.getElementById(id);

    /* --- GAME SYSTEM --- */
    const Game = {
        login: () => {
            const user = el('inp-user').value.trim();
            if(!user) return UI.toast("Digite um nome!", 'error');
            currentUser = user;
            const saved = localStorage.getItem(`g_legend_${user}`);
            if(saved) {
                s = JSON.parse(saved);
                if(!s.runes_inv) s.runes_inv = [];
                s.roster.forEach(m => {
                    if(!m.runes) m.runes = [null,null,null,null];
                    m.runes.forEach((r, i) => { if(r) { if (typeof r.lvl === 'undefined') r.lvl = 0; if (!r.subs) r.subs = []; } });
                });
                s.runes_inv.forEach(r => { if (typeof r.lvl === 'undefined') r.lvl = 0; if (!r.subs) r.subs = []; });
                uidCount = s.roster.reduce((max, r) => Math.max(max, r.uid), 0) + 1;
                const maxRuneIdInv = s.runes_inv.reduce((max, r) => Math.max(max, r.id), 0);
                let maxRuneIdEquip = 0;
                s.roster.forEach(m => { m.runes.forEach(r => { if(r) maxRuneIdEquip = Math.max(maxRuneIdEquip, r.id); }); });
                runeIdCount = Math.max(maxRuneIdInv, maxRuneIdEquip) + 1;
            } else {
                s = JSON.parse(JSON.stringify(DEFAULT_STATE));
            }
            el('p-name').innerText = user;
            UI.upd(); UI.nav('hub');
        },
        save: () => { if(currentUser) localStorage.setItem(`g_legend_${currentUser}`, JSON.stringify(s)); },
        logout: () => {
            currentUser = null; el('inp-user').value = '';
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
            el('login').classList.add('active');
        }
    };

    /* --- UI UPDATED FOR NEW DESIGN --- */
    const UI = {
        nav: scn => { 
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active')); 
            el(scn).classList.add('active'); UI.upd();
            if(scn === 'expl') { tmp.explRegion = null; Core.renExplRegions(); }
            if(scn === 'dung') { tmp.dungType = null; Core.renDungSelect(); }
        },
        modal: (id,o) => { 
            el(id).className = o ? 'modal-overlay open' : 'modal-overlay'; 
            if(o) { UI.upd(); if (id === 'm-shop') Core.renderShop(); }
        },
        toast: (msg, type='info') => {
            const toast = document.createElement('div');
            const color = type === 'error' ? '#ef4444' : '#10b981';
            toast.style.cssText = `position:absolute; top:10%; left:50%; transform:translate(-50%, -50%); background:${color}; color:white; padding:10px 20px; border-radius:30px; z-index:1000; font-weight:bold; box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: floatUp 1.5s forwards; font-family: var(--font-body);`;
            toast.innerHTML = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1500);
        },
        upd: () => {
            const safeSet = (id, val) => { const e = el(id); if(e) e.innerText = val; };
            safeSet('h-mana', s.mana); safeSet('s-mana', s.mana);
            safeSet('h-gems', s.gems); safeSet('s-gems', s.gems);
            safeSet('h-tix', s.tix); safeSet('g-tix', s.tix);
            safeSet('h-rare', s.rare_tix); safeSet('g-rare', s.rare_tix);
            safeSet('h-boost', s.xp_boosters); safeSet('h-grim', s.grimoires); safeSet('sk-grim', s.grimoires);
            safeSet('inv-count', s.roster.length); safeSet('p-lvl', s.p_lvl);
            const pct = Math.min(100, (s.xp / s.max_xp) * 100); 
            const xpBar = el('p-xp-bar'); if(xpBar) xpBar.style.width = `${pct}%`;
        },
        renStars: (star) => {
            let h = '<div class="mon-stars">';
            for(let i=0; i<star; i++) h += `<div class="star-dot ${star>=5?'purple':''}">‚òÖ</div>`;
            return h+'</div>';
        },
        getVis: (d) => { return d.visual || d.icon; },
        
        // --- NEW CARD RENDERER ---
        renMon: (m) => {
            const d = DB.find(x=>x.id===m.id) || DB[0]; 
            return `${UI.renStars(m.star)}<div class="mon-visual">${UI.getVis(d)}</div><div class="mon-lvl">Lv.${m.lvl}</div>`;
        },
        
        renRuneDetails: (r) => {
            const rClass = r.rarity === 'Lendario' ? 'rune-leg' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
            let icon = r.type==='hp'?'‚ù§Ô∏è': r.type==='atk'?'‚öîÔ∏è': r.type==='def'?'üõ°Ô∏è':'üí•';
            
            el('up-rune-icon').className = `rune-icon ${rClass}`;
            el('up-rune-icon').innerHTML = icon;
            el('up-rune-main').innerText = `${r.type.toUpperCase()} +${r.val} (Lv.${r.lvl})`;

            let subsHtml = '';
            if(r.subs && r.subs.length > 0) {
                r.subs.forEach(sub => {
                   subsHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.05)"><span>${sub.type.toUpperCase()}</span><span>+${sub.val}</span></div>`; 
                });
            } else {
                subsHtml = '<div style="color:#666; font-size:0.8rem">Sem substatus</div>';
            }
            el('up-rune-subs').innerHTML = subsHtml;
        }
    };

    /* --- CORE LOGIC --- */
    const Core = {
        reqConfirm: (msg, action) => {
            el('confirm-msg').innerText = msg;
            pendingAction = action;
            UI.modal('m-confirm', 1);
        },
        execConfirm: () => { if(pendingAction) pendingAction(); pendingAction = null; UI.modal('m-confirm', 0); },

        renderShop: () => {
            const container = el('shop-container'); container.innerHTML = '';
            SHOP_DB.forEach(item => {
                const div = document.createElement('div');
                div.className = 'glass-panel';
                div.style.padding = '15px'; div.style.display='flex'; div.style.flexDirection='column'; div.style.alignItems='center'; div.style.gap='10px';
                const priceDisplay = item.cost >= 1000 ? (item.cost / 1000) + 'k' : item.cost;
                div.innerHTML = `<div style="font-size:2rem">${item.icon}</div>
                                <div style="font-weight:bold; font-size:0.9rem">${item.name}</div>
                                <button class="btn" style="font-size:0.8rem; padding:8px" onclick="Core.buy('${item.id}', ${item.cost}, '${item.currency}')">${priceDisplay} ${item.currency==='mana'?'üí†':'üíé'}</button>`;
                container.appendChild(div);
            });
        },
        buy: (type, cost, currency='mana') => {
            if(currency === 'mana' && s.mana < cost) return UI.toast('Mana insuficiente!', 'error');
            if(currency === 'gems' && s.gems < cost) return UI.toast('Cristais insuficientes!', 'error');
            if(currency === 'mana') s.mana -= cost; else s.gems -= cost;
            if(type === 'pot') s.pot++; if(type === 'tix') s.tix++; if(type === 'tix_pack') s.tix += 11;
            if(type === 'rare') s.rare_tix++; if(type === 'rare_pack') s.rare_tix += 11;
            if(type === 'xpboost') s.xp_boosters++; if(type === 'grimoire') s.grimoires++;
            Game.save(); UI.upd(); Core.renderShop(); UI.toast("Compra realizada!");
        },
        spin: (type) => {
            let minNat = 1;
            if (type === 'common') { if(s.tix < 1) return UI.toast('Sem Tickets!'); s.tix--; } 
            else { if(s.rare_tix < 1) return UI.toast('Sem Tickets!'); s.rare_tix--; }
            UI.upd(); 

            let cd = el('g-card'); cd.innerText = '?'; cd.classList.remove('reveal');
            el('g-res').innerText = "Invocando...";
            document.getElementById('gacha-controls').style.pointerEvents = 'none';

            setTimeout(() => {
                let targetNat = 1; const r = Math.random() * 100;
                if (type === 'common') { if (r < 70) targetNat = 1; else if (r < 95) targetNat = 2; else targetNat = 3; } 
                else { if (r < 70) targetNat = 3; else if (r < 95) targetNat = 4; else targetNat = 5; }
                
                const pool = DB.filter(m => m.nat === targetNat);
                const h = pool[Math.floor(Math.random()*pool.length)];
                
                cd.classList.add('reveal');
                if (h.nat === 5) el('flash-layer').classList.add('flash-screen');
                setTimeout(()=>el('flash-layer').classList.remove('flash-screen'), 500);

                setTimeout(() => {
                   cd.innerHTML = UI.getVis(h);
                   el('g-res').innerText = `${h.n} ${h.nat}‚òÖ`;
                   if(h.nat>=4) el('g-res').className = 'text-gold'; else el('g-res').className='';
                }, 500);

                s.roster.push({uid:uidCount++, id:h.id, lvl:1, star:h.nat, skLvl:h.s.map(()=>1), runes:[null,null,null,null]});
                Game.save(); UI.upd();
                document.getElementById('gacha-controls').style.pointerEvents = 'all';
            }, 1000); 
        },
        
        openInv: () => { 
            UI.nav('inv'); const grid = el('inv-grid'); grid.innerHTML = '';
            const frag = document.createDocumentFragment();
            const sorted = [...s.roster].sort((a,b) => (b.star - a.star) || (b.lvl - a.lvl));
            sorted.forEach(m => {
                const div = document.createElement('div');
                div.className = `mon-card ${tmp.selInv===m.uid?'selected':''}`;
                div.onclick = () => Core.selInv(m.uid); div.innerHTML = UI.renMon(m);
                frag.appendChild(div);
            });
            grid.appendChild(frag);
        },
        selInv: (uid) => {
            tmp.selInv = uid; Core.openInv(); 
            const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
            const max = MAX_LVL[m.star] || 50; const isMax = m.lvl>=max;
            if(!m.skLvl) m.skLvl = d.s.map(()=>1); 

            let rStats = { hp:0, atk:0, def:0, crit:0 };
            let runesHtml = '<div style="display:flex; gap:10px; justify-content:center; margin:15px 0;">';
            m.runes.forEach((r, idx) => {
                let slotContent = '';
                if(r) {
                    rStats[r.type] += r.val;
                    if(r.subs) r.subs.forEach(s => rStats[s.type]+=s.val);
                    const rClass = r.rarity === 'Lendario' ? 'rune-leg' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                    let icon = r.type==='hp'?'‚ù§Ô∏è': r.type==='atk'?'‚öîÔ∏è': r.type==='def'?'üõ°Ô∏è':'üí•';
                    slotContent = `<div class="rune-icon ${rClass}" style="width:50px; height:50px; font-size:1.2rem">${icon}</div><div style="font-size:0.6rem; margin-top:2px;">+${r.lvl}</div>`;
                } else {
                    slotContent = `<div style="width:50px; height:50px; border:1px dashed #555; border-radius:6px;"></div>`;
                }
                runesHtml += `<div style="text-align:center; cursor:pointer" onclick="Core.openRuneSelect(${idx})">${slotContent}</div>`;
            });
            runesHtml += '</div>';

            const btnStyle = "flex:1; padding:10px; font-size:0.8rem";
            let controls = `
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" style="${btnStyle}; background:var(--success)" onclick="Core.pup(${uid})">UP (${Math.floor(m.lvl/5)+1}üß™)</button>
                    <button class="btn" style="${btnStyle}; background:var(--accent)" onclick="Core.openSkill(${uid})">Skill</button>
                    ${isMax && m.star<6 ? `<button class="btn" style="${btnStyle}; background:var(--epic)" onclick="Core.openEvo(${uid})">Evoluir</button>` : ''}
                </div>`;
            
            el('inv-detail').innerHTML = `
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="font-size:3rem;">${UI.getVis(d)}</div>
                    <div>
                        <h2 class="title-font" style="color:${d.color}">${d.n}</h2>
                        <div style="font-size:0.8rem; color:#aaa">${d.type} | ${d.nat}‚òÖ</div>
                    </div>
                </div>
                <div style="margin-top:15px; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                     <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Lv</span><b>${m.lvl}/${max}</b></div>
                     <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Runas</span><span class="text-success">+${rStats.atk} ATK / +${rStats.hp} HP</span></div>
                </div>
                ${runesHtml}
                ${controls}`;
        },
        pup: (uid) => {
            if(s.pot<1) return UI.toast("Sem po√ß√µes!", 'error');
            const m = s.roster.find(x=>x.uid===uid);
            if(m.lvl >= (MAX_LVL[m.star]||50)) return UI.toast("N√≠vel M√°ximo!");
            s.pot--; m.lvl++; Game.save(); UI.upd(); Core.selInv(uid);
        },
        
        openRuneBag: () => {
            UI.nav('rune_bag'); 
            const grid = el('rune-bag-grid'); grid.innerHTML = '';
            if(s.runes_inv.length === 0) { grid.innerHTML = '<div style="color:#aaa; padding:20px; grid-column:1/-1; text-align:center">Vazio</div>'; return; }
            s.runes_inv.forEach(r => {
                const item = document.createElement('div'); item.className = 'rune-grid-item';
                const rClass = r.rarity === 'Lendario' ? 'rune-leg' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                let icon = r.type==='hp'?'‚ù§Ô∏è': r.type==='atk'?'‚öîÔ∏è': r.type==='def'?'üõ°Ô∏è':'üí•';
                const sellPrice = r.rarity === 'Lendario' ? 500 : r.rarity === 'Epico' ? 200 : 50;

                item.innerHTML = `
                    <div class="rune-icon ${rClass}">${icon}</div>
                    <div style="font-size:0.7rem; font-weight:bold">+${r.lvl}</div>
                    <div style="font-size:0.6rem; color:#aaa">${r.type.toUpperCase()} +${r.val}</div>
                    <div style="display:flex; gap:5px; width:100%">
                        <button class="btn" style="flex:1; padding:2px; font-size:0.6rem; background:var(--primary); color:black" onclick="Core.openRuneUpgrade(${r.id}, event)">UP</button>
                        <button class="btn" style="flex:1; padding:2px; font-size:0.6rem; background:var(--danger)" onclick="Core.sellRune(${r.id}, ${sellPrice}, event)">$</button>
                    </div>
                `;
                grid.appendChild(item);
            });
        },
        sellRune: (runeId, price, event) => {
            if(event) event.stopPropagation(); 
            Core.reqConfirm(`Vender por ${price}?`, () => {
                const idx = s.runes_inv.findIndex(r => r.id == runeId); 
                if(idx > -1) { s.runes_inv.splice(idx, 1); s.mana += price; Game.save(); UI.upd(); Core.openRuneBag(); UI.toast(`+${price} Mana`); }
            });
        },
        
        openRuneUpgrade: (runeId, event) => {
            if(event) event.stopPropagation();
            let r = s.runes_inv.find(x => x.id === runeId);
            if(!r) s.roster.forEach(m => { m.runes.forEach(eqR => { if(eqR && eqR.id === runeId) r = eqR; }); });
            if(!r) return;

            tmp.upRune = r; UI.renRuneDetails(r);
            const cost = 500 + (r.lvl * 1000);
            let chance = 100;
            if(r.lvl >= 3) chance = 70; if(r.lvl >= 6) chance = 50; if(r.lvl >= 9) chance = 30; if(r.lvl >= 12) chance = 10;
            
            if(r.lvl >= 15) { el('up-cost').innerText = "MAX"; el('up-chance').innerText = "-"; }
            else { el('up-cost').innerText = cost; el('up-chance').innerText = chance + "%"; }
            
            UI.modal('m-rune-up', 1);
        },
        doUpgrade: () => {
            const r = tmp.upRune;
            if(r.lvl >= 15) return UI.toast("N√≠vel M√°ximo!");
            const cost = 500 + (r.lvl * 1000);
            if(s.mana < cost) return UI.toast("Mana Insuficiente!", 'error');
            
            s.mana -= cost; UI.upd();
            let chance = 1; 
            if(r.lvl >= 3) chance = 0.7; if(r.lvl >= 6) chance = 0.5; if(r.lvl >= 9) chance = 0.3; if(r.lvl >= 12) chance = 0.1;
            
            if(Math.random() < chance) {
                r.lvl++; r.val = Math.ceil(r.val * 1.1);
                if (r.lvl % 3 === 0) {
                    const subTypes = ['hp', 'atk', 'def', 'crit'];
                    if (r.subs.length < 4) {
                        r.subs.push({ type: subTypes[Math.floor(Math.random()*4)], val: Math.floor(Math.random()*5)+3 });
                        UI.toast(`Sucesso! Novo Substatus!`);
                    } else {
                        r.subs[Math.floor(Math.random()*r.subs.length)].val += Math.floor(Math.random()*4)+2;
                        UI.toast(`Sucesso! Substatus Aumentado!`);
                    }
                } else UI.toast(`Sucesso! +${r.lvl}`);
                
                Game.save(); UI.renRuneDetails(r); 
                if(el('rune_bag').classList.contains('active')) Core.openRuneBag();
                if(el('inv').classList.contains('active')) Core.selInv(tmp.selInv);
            } else UI.toast("Falhou...", 'error');
            
            Core.openRuneUpgrade(r.id); // Refresh modal costs
        },

        openRuneSelect: (slotIdx) => {
            tmp.selRuneSlot = slotIdx;
            const m = s.roster.find(x=>x.uid===tmp.selInv);
            const currentRune = m.runes[slotIdx];
            let html = '';
            
            if (currentRune) {
                html += `<div class="rune-grid-item" style="border-color:var(--danger)">
                    <div>Remover Atual</div>
                    <button class="btn" style="background:var(--danger); padding:5px" onclick="Core.unequipRune()">Desequipar (1000)</button>
                </div><hr style="margin:10px 0; border-color:#444">`;
            }

            s.runes_inv.forEach(r => {
                const rClass = r.rarity === 'Lendario' ? 'rune-leg' : r.rarity === 'Epico' ? 'rune-epic' : 'rune-rare';
                let icon = r.type==='hp'?'‚ù§Ô∏è': r.type==='atk'?'‚öîÔ∏è': r.type==='def'?'üõ°Ô∏è':'üí•';
                html += `<div class="map-node" onclick="Core.equipRune(${r.id})" style="padding:10px">
                    <div class="rune-icon ${rClass}" style="width:30px;height:30px">${icon}</div>
                    <div style="font-size:0.8rem">
                        <div style="font-weight:bold">+${r.lvl} ${r.rarity}</div>
                        <div style="color:#aaa">+${r.val} ${r.type.toUpperCase()}</div>
                    </div>
                </div>`;
            });
            
            if(!html) html = "<div style='text-align:center; padding:20px; color:#aaa'>Sem runas dispon√≠veis</div>";
            el('rune-list').innerHTML = html;
            UI.modal('m-rune', 1);
        },
        equipRune: (runeId) => {
            const m = s.roster.find(x=>x.uid===tmp.selInv);
            const runeIdx = s.runes_inv.findIndex(r => r.id === runeId);
            if (m.runes[tmp.selRuneSlot]) s.runes_inv.push(m.runes[tmp.selRuneSlot]);
            m.runes[tmp.selRuneSlot] = s.runes_inv[runeIdx];
            s.runes_inv.splice(runeIdx, 1);
            Game.save(); UI.modal('m-rune', 0); Core.selInv(tmp.selInv);
        },
        unequipRune: () => {
            if(s.mana < 1000) return UI.toast("Mana insuficiente!", 'error');
            const m = s.roster.find(x=>x.uid===tmp.selInv);
            s.mana -= 1000; s.runes_inv.push(m.runes[tmp.selRuneSlot]);
            m.runes[tmp.selRuneSlot] = null;
            Game.save(); UI.modal('m-rune', 0); Core.selInv(tmp.selInv);
        },

        /* --- EXPLORATION & DUNGEON --- */
        renExplRegions: () => {
            const container = el('expl-regions'); container.innerHTML = '';
            el('expl-regions').style.display='block'; el('expl-stages-list').style.display='none';
            EXPL_REGIONS.forEach((r, i) => {
                const locked = s.maxStage <= (r.id - 1) * 8;
                const progress = locked ? "Bloqueado" : (s.maxStage > r.id * 8 ? "Completo" : `${(s.maxStage - 1) % 8}/8`);
                const div = document.createElement('div');
                div.className = `map-node ${locked?'locked':''}`;
                div.onclick = () => { tmp.explRegion = r.id; el('expl-regions').style.display='none'; el('expl-stages-list').style.display='block'; Core.renExplStages(r.id); };
                div.innerHTML = `<div style="font-size:2rem; width:50px; text-align:center">${r.icon}</div>
                                 <div style="flex:1">
                                    <h4 style="color:${r.color}">${r.name}</h4>
                                    <div style="font-size:0.7rem; color:#aaa">${r.type} ‚Ä¢ ${progress}</div>
                                 </div>
                                 <div>‚ùØ</div>`;
                container.appendChild(div);
            });
        },
        backToExplRegions: () => { el('expl-stages-list').style.display='none'; el('expl-regions').style.display='block'; },
        renExplStages: (regionId) => {
            const container = el('expl-list-container'); container.innerHTML = '';
            for(let i=1; i<=8; i++) {
                const globalStageId = (regionId - 1) * 8 + i;
                const locked = globalStageId > s.maxStage;
                const cleared = globalStageId < s.maxStage;
                const btn = document.createElement('div');
                btn.className = `map-node ${locked?'locked':''}`;
                if(cleared) btn.style.borderColor = 'var(--success)';
                btn.onclick = () => Core.prepFight('story', globalStageId);
                btn.innerHTML = `<div style="font-weight:bold; width:30px;">${i}</div>
                                 <div style="flex:1">${i===8?'Chefe üíÄ':'Batalha'}</div>
                                 ${cleared ? '‚úÖ' : '‚öîÔ∏è'}`;
                container.appendChild(btn);
            }
        },
        
        renDungSelect: () => { el('dung-select').style.display='flex'; el('dung-floors').style.display='none'; },
        selectDung: (type) => { tmp.dungType = type; el('dung-select').style.display='none'; el('dung-floors').style.display='block'; Core.renDungFloors(); },
        backToDungSelect: () => { Core.renDungSelect(); },
        renDungFloors: () => {
            const container = el('dung-list-container'); container.innerHTML = '';
            const type = tmp.dungType;
            for(let i=1; i<=10; i++) {
                const stageKey = type === 'golem' ? `golem-${i}` : `dragon-${i}`;
                const locked = i > 1 && !s.cleared.includes(type === 'golem' ? `golem-${i-1}` : `dragon-${i-1}`);
                const cleared = s.cleared.includes(stageKey);
                const btn = document.createElement('div');
                btn.className = `map-node ${locked?'locked':''}`;
                if(cleared) btn.style.borderColor = 'var(--success)';
                btn.onclick = () => { if(!locked) Core.prepFight(`dungeon-${type}`, i); };
                btn.innerHTML = `<div style="font-weight:bold; width:30px">B${i}</div><div style="flex:1">Andar ${i}</div>${cleared?'‚úÖ':'‚öîÔ∏è'}`;
                container.appendChild(btn);
            }
        },

        prepFight: (mode, level) => { tmp.mode = mode; tmp.lvl = level; tmp.prep = []; UI.nav('prep'); Prep.render(); },

        /* --- EVO & SKILL (Generic logic) --- */
        openEvo: (uid) => { tmp.evoTarget=uid; tmp.evoFodder=[]; el('evo-req-c').innerText=s.roster.find(x=>x.uid===uid).star; el('evo-req-s').innerText=s.roster.find(x=>x.uid===uid).star; UI.modal('m-evo',1); Core.renEvo(); },
        renEvo: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('evo-grid'); grid.innerHTML = ''; const slots = el('evo-slots'); slots.innerHTML = '';
            for(let i=0; i<tgt.star; i++) { 
                const f=tmp.evoFodder[i]; const d = document.createElement('div'); d.className='mon-card'; d.style.width='50px'; d.style.height='50px';
                if(f) { d.onclick=()=>Core.togFodder(f); d.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); } else d.style.border='1px dashed #555';
                slots.appendChild(d);
            }
            s.roster.filter(m=>m.star===tgt.star&&m.uid!==tgt.uid).forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-card ${tmp.evoFodder.includes(m.uid)?'fodder':''}`;
                d.onclick = () => Core.togFodder(m.uid); d.innerHTML = UI.renMon(m);
                grid.appendChild(d);
            });
            el('btn-do-evo').disabled=tmp.evoFodder.length<tgt.star;
        },
        togFodder: (uid) => { if(tmp.evoFodder.includes(uid)) tmp.evoFodder=tmp.evoFodder.filter(x=>x!==uid); else if(tmp.evoFodder.length<s.roster.find(x=>x.uid===tmp.evoTarget).star) tmp.evoFodder.push(uid); Core.renEvo(); },
        doEvolution: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            s.roster = s.roster.filter(m=>!tmp.evoFodder.includes(m.uid));
            t.star++; t.lvl=1; 
            Game.save(); UI.modal('m-evo',0); Core.selInv(t.uid); UI.toast(`Evolu√≠do para ${t.star}‚òÖ!`);
        },
        openSkill: (uid) => { tmp.evoTarget=uid; tmp.skillFodder=[]; UI.modal('m-skill',1); Core.renSkill(); },
        renSkill: () => {
            const tgt = s.roster.find(x=>x.uid===tmp.evoTarget);
            const grid = el('skill-grid'); grid.innerHTML = ''; const slots = el('skill-slots'); slots.innerHTML = '';
            const f = tmp.skillFodder[0]; const dS = document.createElement('div'); dS.className='mon-card'; dS.style.width='50px'; dS.style.height='50px';
            if(f) { dS.onclick=()=>Core.togSkill(f); dS.innerHTML=UI.renMon(s.roster.find(x=>x.uid===f)); } else dS.style.border='1px dashed #555';
            slots.appendChild(dS);
            s.roster.filter(m => m.id === tgt.id && m.uid !== tgt.uid).forEach(m => {
                const d = document.createElement('div'); d.className = `mon-card ${tmp.skillFodder.includes(m.uid)?'fodder':''}`;
                d.onclick = () => Core.togSkill(m.uid); d.innerHTML = UI.renMon(m); grid.appendChild(d);
            });
            el('btn-do-skill').disabled = tmp.skillFodder.length === 0;
        },
        togSkill: (uid) => { if(tmp.skillFodder.includes(uid)) tmp.skillFodder=[]; else if(tmp.skillFodder.length<1) tmp.skillFodder.push(uid); Core.renSkill(); },
        doSkill: () => {
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            s.roster = s.roster.filter(m=>!tmp.skillFodder.includes(m.uid));
            const rnd = Math.floor(Math.random()*t.skLvl.length);
            if(t.skLvl[rnd] < 5) t.skLvl[rnd]++; 
            Game.save(); UI.modal('m-skill',0); Core.selInv(t.uid); UI.toast(`Skill Up!`);
        },
        useGrimoire: () => {
            if(s.grimoires < 1) return UI.toast("Sem Grim√≥rios!", 'error');
            const t = s.roster.find(x=>x.uid===tmp.evoTarget);
            s.grimoires--; const rnd = Math.floor(Math.random()*t.skLvl.length); if(t.skLvl[rnd]<5) t.skLvl[rnd]++;
            Game.save(); UI.upd(); UI.modal('m-skill',0); Core.selInv(t.uid); UI.toast("Grim√≥rio usado!");
        }
    };

    const Prep = {
        render: () => {
            const grid = el('prep-grid'); grid.innerHTML = ''; 
            [0,1,2].forEach(i => {
                const uid = tmp.prep[i]; const sl = el(`s${i}`);
                sl.innerHTML = uid ? UI.renMon(s.roster.find(x=>x.uid===uid)) : '+';
                sl.style.borderStyle = uid ? 'solid' : 'dashed';
            });
            s.roster.forEach(m => {
                const d = document.createElement('div');
                d.className = `mon-card ${tmp.prep.includes(m.uid)?'selected':''}`;
                d.onclick = () => Prep.pick(m.uid); d.innerHTML = UI.renMon(m); grid.appendChild(d);
            });
            el('btn-fight').disabled = tmp.prep.length===0;
            
            // Auto farm button logic
            const stageKey = tmp.mode === 'story' ? `story-${tmp.lvl}` : (tmp.mode==='dungeon-golem' ? `golem-${tmp.lvl}` : `dragon-${tmp.lvl}`);
            el('btn-farm').style.display = (s.cleared.includes(stageKey) && tmp.prep.length > 0) ? 'block' : 'none';
        },
        pick: (uid) => { if(tmp.prep.includes(uid)) tmp.prep=tmp.prep.filter(x=>x!==uid); else if(tmp.prep.length<3) tmp.prep.push(uid); Prep.render(); },
        rem: (i) => { if(tmp.prep[i]) { tmp.prep.splice(i,1); Prep.render(); } }
    };

    /* --- BATTLE SYSTEM (Logic Intact, Visuals Updated) --- */
    const Battle = {
        spd: () => { b.spd = b.spd===1?2:(b.spd===2?3:1); el('btn-spd').innerText = 'x' + b.spd; },
        toggleAuto: () => { b.auto = !b.auto; el('btn-auto').style.color = b.auto ? 'var(--success)' : '#fff'; if(b.auto) Battle.turn(); },
        start: (farmRuns = 0) => {
            if(tmp.prep.length===0) return;
            b.skillPending = null; b.farmRuns = farmRuns;
            b.spd = farmRuns > 0 ? 5 : 1;
            b.auto = farmRuns > 0;
            el('farm-ui').style.display = farmRuns > 0 ? 'block' : 'none';
            el('farm-count').innerText = farmRuns;
            el('btn-auto').style.display = s.p_lvl >= 2 ? 'flex' : 'none';

            b.p = tmp.prep.map((uid,i) => {
                const m = s.roster.find(x=>x.uid===uid); const d = DB.find(x=>x.id===m.id) || DB[0];
                const sm = 1 + m.lvl*0.1 + (m.star * 0.3);
                let rStats = { hp:0, atk:0, def:0, crit:0 };
                m.runes.forEach(r => { 
                    if(r) { rStats[r.type]+=r.val; if(r.subs) r.subs.forEach(s=>rStats[s.type]+=s.val); }
                });
                return {...d, max:Math.floor((d.hp*sm)+rStats.hp), cur:Math.floor((d.hp*sm)+rStats.hp), atk:Math.floor((d.atk*sm)+rStats.atk), def:rStats.def, crit:rStats.crit, idx:i, side:'p', dead:false, cds:d.s.map(()=>0), skLvl:m.skLvl};
            });

            if(tmp.mode === 'story') {
                const diff = 1 + (tmp.lvl * 0.5);
                const isBoss = (tmp.lvl % 8 === 0);
                if (isBoss) {
                    const bossPool = DB.filter(x => x.nat >= 3 && x.nat <= 5);
                    const bossBase = bossPool[Math.floor(Math.random()*bossPool.length)];
                    b.e = [{...bossBase, max:Math.floor(bossBase.hp*2.5*diff), cur:Math.floor(bossBase.hp*2.5*diff), atk:Math.floor(bossBase.atk*1.5*diff), def:Math.floor(tmp.lvl*2), crit:0, idx:0, side:'e', dead:false, cds:bossBase.s.map(()=>0), skLvl:bossBase.s.map(()=>2), isBoss:true}];
                } else {
                    b.e = Array(3).fill(0).map((_,i) => {
                         const base = DB.filter(x => x.nat <= Math.min(3, Math.ceil(tmp.lvl/8)))[Math.floor(Math.random()*3)];
                         return {...base, max:Math.floor(base.hp*diff), cur:Math.floor(base.hp*diff), atk:Math.floor(base.atk*diff), def:0, crit:0, idx:i, side:'e', dead:false, cds:base.s.map(()=>0), skLvl:base.s.map(()=>1)};
                    });
                }
            } else {
                const diff = 1 + (tmp.lvl * 0.8);
                const bossBase = DB.find(x => x.id === (tmp.mode==='dungeon-golem'?901:902));
                b.e = [{...bossBase, max:Math.floor(bossBase.hp*5*diff), cur:Math.floor(bossBase.hp*5*diff), atk:Math.floor(bossBase.atk*1.5*diff), def:Math.floor(tmp.lvl*5), idx:0, side:'e', dead:false, cds:bossBase.s.map(()=>0), skLvl:bossBase.s.map(()=>3), isBoss:true}];
            }
            b.t='p'; b.idx=0; UI.nav('battle'); Battle.draw(); Battle.turn();
        },
        draw: () => {
            el('r-ene').innerHTML = b.e.map(u => Battle.renUnit(u)).join('');
            el('r-pla').innerHTML = b.p.map(u => Battle.renUnit(u)).join('');
        },
        renUnit: (u) => {
            const isAct = !u.dead && ((b.t==='p' && u.side==='p' && b.idx===u.idx));
            const isTgt = !u.dead && b.target===u.idx && u.side==='e';
            return `<div id="${u.side}${u.idx}" class="unit ${u.isBoss?'boss':''} ${u.dead?'dead':''} ${isAct?'attacking-p':''}" 
                     style="${isTgt?'filter:drop-shadow(0 0 10px red)':''}" onclick="Battle.clickUnit('${u.side}', ${u.idx})">
                    <div class="hp-wrapper"><div class="hp-fill" style="width:${(u.cur/u.max)*100}%; background:${u.side==='e'?'var(--danger)':'var(--success)'}"></div></div>
                    <div class="unit-sprite">${UI.getVis(u)}</div>
                </div>`;
        },
        clickUnit: (side, idx) => {
            if (b.t !== 'p') return;
            if (b.skillPending !== null && side === 'p') {
                const u = b.p[b.idx]; const skill = u.s[b.skillPending];
                const skillIdx = b.skillPending; b.skillPending = null;
                el('btl-ui').classList.remove('active');
                u.cds[skillIdx] = skill.cd + 1;
                Battle.hit(u, b.p[idx], skill.m, u.skLvl[skillIdx], skill.ty);
            }
            if (side === 'e' && !b.e[idx].dead) { b.target = b.target === idx ? null : idx; Battle.draw(); }
        },
        turn: () => {
            if(b.e.every(x=>x.dead)) return Battle.end(1); if(b.p.every(x=>x.dead)) return Battle.end(0);
            Battle.draw();
            
            if(b.t==='p') {
                if(b.idx>=b.p.length) { b.t='e'; b.idx=0; return Battle.turn(); }
                const u = b.p[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));

                if (b.auto) {
                    el('btl-ui').classList.remove('active');
                    setTimeout(() => {
                        let si = 0; if(u.s[2]&&u.cds[2]===0) si=2; else if(u.s[1]&&u.cds[1]===0) si=1;
                        const skill = u.s[si];
                        let t = null;
                        if(skill.ty==='heal') t = b.p.filter(a=>!a.dead).sort((a,b)=>(a.cur/a.max)-(b.cur/b.max))[0];
                        else if(skill.ty==='turn') t = u;
                        else t = b.e.filter(e=>!e.dead)[0];
                        
                        u.cds[si] = skill.cd+1;
                        Battle.hit(u, t||u, skill.m, u.skLvl[si], skill.ty);
                    }, 500/b.spd);
                    return;
                }

                el('act-name').innerText = u.n; el('act-target').innerText = "Selecione Habilidade";
                el('btl-ui').classList.add('active');
                el('skill-list').innerHTML = u.s.map((sk,i) => {
                    const cd = u.cds[i]>0;
                    return `<div class="skill-btn ${i===0?'main':i===1?'':'ult'} ${cd?'cd':''}" onclick="${cd?'':'Battle.act('+i+')'}">
                        <div class="skill-icon">${i===0?'‚öîÔ∏è':i===1?'‚ú®':'üî•'}</div>
                        ${cd?`<div class="skill-cd-ovl">${u.cds[i]}</div>`:''}
                        <div style="font-size:0.6rem; font-weight:bold; margin-top:2px">${sk.n}</div>
                    </div>`;
                }).join('');
            } else {
                el('btl-ui').classList.remove('active');
                if(b.idx>=b.e.length) { b.t='p'; b.idx=0; return Battle.turn(); }
                const u = b.e[b.idx]; if(u.dead) { b.idx++; return Battle.turn(); }
                u.cds = u.cds.map(c => Math.max(0, c-1));
                setTimeout(() => {
                    const tg = b.p.filter(x=>!x.dead);
                    if(tg.length) {
                        const avail = u.s.map((s,i)=>({i,...s})).filter(s=>u.cds[s.i]===0);
                        const skill = avail.length ? avail[Math.floor(Math.random()*avail.length)] : {i:0,m:1};
                        u.cds[skill.i] = (skill.cd||0)+1;
                        Battle.hit(u, tg[Math.floor(Math.random()*tg.length)], skill.m, 1, skill.ty);
                    } else { b.idx++; Battle.turn(); }
                }, 800/b.spd);
            }
        },
        act: (i) => {
            const u = b.p[b.idx]; const skill = u.s[i];
            if (skill.ty === 'heal' || skill.ty === 'turn') { b.skillPending=i; el('act-target').innerText = "Selecione Aliado"; return; }
            u.cds[i] = skill.cd + 1; el('btl-ui').classList.remove('active');
            let t = b.target!==null && !b.e[b.target].dead ? b.e[b.target] : b.e.filter(x=>!x.dead)[0];
            Battle.hit(u, t, skill.m, u.skLvl[i], skill.ty);
            b.target=null;
        },
        hit: (atk, def, mult, slvl, type) => {
            const aEl = el(`${atk.side}${atk.idx}`); aEl.classList.add(atk.side==='p'?'attacking-p':'attacking-e');
            setTimeout(() => {
                aEl.classList.remove('attacking-p','attacking-e');
                const targets = type === 'aoe' ? (atk.side==='p'?b.e:b.p) : [def];
                
                targets.forEach(t => {
                    if(t.dead) return;
                    const tEl = el(`${t.side}${t.idx}`); tEl.classList.add('hit-anim'); setTimeout(()=>tEl.classList.remove('hit-anim'), 400);
                    
                    if(type === 'heal') {
                        const amt = Math.floor(atk.atk * mult * (1+(slvl-1)*0.2));
                        t.cur = Math.min(t.max, t.cur + amt);
                        Battle.showDmg(tEl, `+${amt}`, '#10b981');
                    } else if (type === 'turn') {
                         Battle.showDmg(tEl, "Turno Extra", '#3b82f6');
                         if(t.side==='e') setTimeout(()=>{ Battle.hit(t, b.p[0], 1, 1); }, 500); // Simple enemy logic
                         else { setTimeout(Battle.turn, 800/b.spd); return; } // Player gets turn
                    } else {
                        const defRed = 100 / (100 + (t.def||0));
                        let finalMult = mult + (slvl-1)*0.2;
                        let isCrit = atk.crit && Math.random()*100 < atk.crit;
                        if(isCrit) finalMult *= 1.5;
                        const dmg = Math.floor(atk.atk * finalMult * defRed);
                        t.cur = Math.max(0, t.cur - dmg);
                        Battle.showDmg(tEl, isCrit?`CRIT ${dmg}`:dmg, isCrit?'#ef4444':'#fff');
                        if(t.cur === 0) { t.dead = true; tEl.classList.add('dead'); }
                    }
                });
                b.idx++; setTimeout(Battle.turn, 800/b.spd);
            }, 300/b.spd);
        },
        showDmg: (el, txt, col) => {
            const d = document.createElement('div'); d.className='dmg-float'; d.style.color=col; d.innerText=txt;
            el.appendChild(d); setTimeout(()=>d.remove(), 800);
        },
        end: (w) => {
            setTimeout(() => {
                let rewardMsg = "", itemIcon = "", itemQtd = "", gemsAwarded = 0, accXpGain = 0; let runeDrop = "";
                if(w) {
                    const stageKey = tmp.mode === 'story' ? `story-${tmp.lvl}` : (tmp.mode === 'dungeon-golem' ? `golem-${tmp.lvl}` : `dragon-${tmp.lvl}`);
                    const firstClear = !s.cleared.includes(stageKey);
                    if(firstClear) { s.cleared.push(stageKey); gemsAwarded = 50; } else { gemsAwarded = 5; }
                    s.gems += gemsAwarded;
                    
                    let baseVal = tmp.mode === 'story' ? 50 + (tmp.lvl * 20) : 300 + (tmp.lvl * 50);
                    if(s.xp_boosters > 0) { baseVal *= 3; s.xp_boosters--; }
                    s.xp += baseVal;
                    if(s.xp >= s.max_xp) { s.p_lvl++; s.xp -= s.max_xp; s.max_xp = Math.floor(s.max_xp * 1.5); s.gems += 100; UI.toast("LEVEL UP!"); }
                    
                    if(tmp.mode === 'story') {
                        const rPot = Math.floor(tmp.lvl / 2) + 1; s.mana += 50*tmp.lvl; s.pot += rPot;
                        itemIcon = "üß™"; itemQtd = `+${rPot}`; el('end-mana').innerText = `+${50*tmp.lvl}`;
                        if(tmp.lvl === s.maxStage) s.maxStage++;
                    } else {
                        const rarities = ['Comum', 'Raro', 'Epico', 'Lendario'];
                        let rIdx = 0; const rnd = Math.random() * 100;
                        if (tmp.lvl > 6) rIdx=1; if (tmp.lvl > 9) rIdx=2; 
                        if(rnd > 90) rIdx++;
                        const rarity = rarities[Math.min(3, rIdx)];
                        let type = tmp.mode === 'dungeon-golem' ? (Math.random()>0.5?'hp':'def') : (Math.random()>0.5?'atk':'crit');
                        const newRune = { id: runeIdCount++, rarity, type, val: (rIdx+1)*10, lvl: 0, subs: [] };
                        s.runes_inv.push(newRune);
                        itemIcon = "üßø"; itemQtd = "Runas"; runeDrop = `${rarity} ${type.toUpperCase()}`;
                    }
                    Game.save();
                    
                    if (b.farmRuns > 1) {
                        b.farmRuns--; el('farm-count').innerText = b.farmRuns;
                        UI.toast(`Vit√≥ria! Reiniciando (${b.farmRuns})...`);
                        setTimeout(() => Battle.start(b.farmRuns), 1000); return;
                    }
                } else { b.farmRuns=0; }
                
                el('end-title').innerText = w ? "VIT√ìRIA" : "DERROTA"; el('end-title').style.color = w ? "var(--success)" : "var(--danger)";
                el('end-item-icon').innerText = itemIcon; el('end-xp').innerText = itemQtd;
                el('end-gems').innerText = `+${gemsAwarded}`; el('rune-drop-msg').innerText = runeDrop;
                UI.modal('m-end',1);
            }, 800);
        },
        close: () => { UI.modal('m-end',0); UI.nav('hub'); }
    };
</script>
</body>
</html>
